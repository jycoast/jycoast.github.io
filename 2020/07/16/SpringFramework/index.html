<!DOCTYPE html>
<html lang="zh-CN">
<meta name="referrer" content="no-referrer" />
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//fastly.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jycoder.club","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":390,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Spring毫无疑问是当下Web开发的事实标准，修炼好Web开发中这一门最为重要的内功，对于框架原理的理解、视野的开拓以及学习周边技术栈是必不可少的。">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringFramework">
<meta property="og:url" content="https://jycoder.club/2020/07/16/SpringFramework/index.html">
<meta property="og:site_name" content="吉永超">
<meta property="og:description" content="Spring毫无疑问是当下Web开发的事实标准，修炼好Web开发中这一门最为重要的内功，对于框架原理的理解、视野的开拓以及学习周边技术栈是必不可少的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205130273.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205345978.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205434583.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205533354.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205605481.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205723539.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205747975.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205818521.png">
<meta property="og:image" content="https://jycoder.club/2020/07/16/SpringFramework/SpringFramework.assets/image-20210614105732908.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210625173747553.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210625174810362.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210628202410655.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210628202440062.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629102005648.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629104114854.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629112032376.png">
<meta property="og:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629152452981.png">
<meta property="article:published_time" content="2020-07-16T00:00:00.000Z">
<meta property="article:modified_time" content="2022-11-21T15:29:20.954Z">
<meta property="article:author" content="吉永超">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205130273.png">

<link rel="canonical" href="https://jycoder.club/2020/07/16/SpringFramework/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringFramework | 吉永超</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section">首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section">标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section">分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section">归档</a>

  </li>
        <li class="menu-item menu-item-文集">

    <a href="https://www.wolai.com/p7EcXEWp3EsR9BeGRZWNgf?theme=dark/" rel="noopener" target="_blank">文集</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section">公益</a>

  </li>
        <li class="menu-item menu-item-infoq">

    <a href="https://www.infoq.cn/profile/3479D9A8F57FEF/publish/" rel="noopener" target="_blank">infoQ</a>

  </li>
        <li class="menu-item menu-item-路线">

    <a href="/route/" rel="section">路线</a>

  </li>
        <li class="menu-item menu-item-项目">

    <a href="https://github.com/jycoast/" rel="noopener" target="_blank">项目</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section">关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/jycoast" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jycoder.club/2020/07/16/SpringFramework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="吉永超">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吉永超">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringFramework
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-16 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-16T00:00:00+00:00">2020-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-21 15:29:20" itemprop="dateModified" datetime="2022-11-21T15:29:20+00:00">2022-11-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>292k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4:25</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Spring毫无疑问是当下Web开发的事实标准，修炼好Web开发中这一门最为重要的内功，对于框架原理的理解、视野的开拓以及学习周边技术栈是必不可少的。</p>
<span id="more"></span>
<h1 id="spring-基础"><a class="markdownIt-Anchor" href="#spring-基础"></a> Spring 基础</h1>
<h2 id="spring特性总览"><a class="markdownIt-Anchor" href="#spring特性总览"></a> Spring特性总览</h2>
<h3 id="spring-中值得学习的地方"><a class="markdownIt-Anchor" href="#spring-中值得学习的地方"></a> Spring 中值得学习的地方</h3>
<ol>
<li>Java语言特性，例如反射、动态代理、枚举、泛型、注解、ARM、Lambda语法</li>
<li>设计思想和模式的实现，如OOP，DDD，TDD，GoF23等</li>
<li>Java API的封装与简化，如JDBC，事务，Transaction，Servlet，JPA，JMX ，Bean Validation</li>
<li>JSR规范的适配与实现</li>
<li>第三方框架的整合，如MyBatis整合Hibernetes和Redis</li>
</ol>
<h3 id="spring核心特性"><a class="markdownIt-Anchor" href="#spring核心特性"></a> Spring核心特性</h3>
<ol>
<li>IOC容器（IOC Container）</li>
<li>Spring事件（Events）</li>
<li>资源管理（Resources）</li>
<li>国际化（i18n）</li>
<li>校验（Validation）</li>
<li>数据绑定（Data Binding）</li>
<li>类型转换（Type Conversion）</li>
<li>Spring表达式（Spring Express Language）</li>
<li>面向切面编程（AOP）</li>
</ol>
<h3 id="spring数据存储"><a class="markdownIt-Anchor" href="#spring数据存储"></a> Spring数据存储</h3>
<ol>
<li>JDBC</li>
<li>事务抽象（Transactions）</li>
<li>DAO支持（DAO Support）</li>
<li>O/R映射（O/R Mapping）</li>
<li>XML编列（XML Marshalling）</li>
</ol>
<h3 id="spring-web技术"><a class="markdownIt-Anchor" href="#spring-web技术"></a> Spring Web技术</h3>
<ol>
<li>Web Servlet技术栈
<ol>
<li>Spring MVC</li>
<li>WebSocket</li>
<li>SockJS</li>
</ol>
</li>
<li>Web Reactive技术栈
<ol>
<li>Spring WebFlux</li>
<li>WebClient</li>
<li>WebSocket</li>
</ol>
</li>
</ol>
<h3 id="spring技术整合"><a class="markdownIt-Anchor" href="#spring技术整合"></a> Spring技术整合</h3>
<ol>
<li>远程调用（Remoting）</li>
<li>Java消息服务（JMS）</li>
<li>Java连接架构（JCA）</li>
<li>Java管理扩展（JMX）</li>
<li>Java邮件客户端（Email）</li>
<li>本地任务（Taks）</li>
<li>本地调度（Scheduling）</li>
<li>缓存抽象（Caching）</li>
</ol>
<h3 id="spring测试"><a class="markdownIt-Anchor" href="#spring测试"></a> Spring测试</h3>
<ol>
<li>模拟对象（Mock Objects）</li>
<li>TestContext框架（TestContext Framework）</li>
<li>Spring MVC测试（Spring MVC Test）</li>
<li>Web 测试客户端（Web TestClient）</li>
</ol>
<h2 id="spring版本特性"><a class="markdownIt-Anchor" href="#spring版本特性"></a> Spring版本特性</h2>
<table>
<thead>
<tr>
<th>Spring Framework版本</th>
<th>Java标准版</th>
<th>Java企业版</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.x</td>
<td>1.3+</td>
<td>J2EE 1.3+</td>
</tr>
<tr>
<td>2.x</td>
<td>1.4.2+</td>
<td>J2EE 1.3+</td>
</tr>
<tr>
<td>3.x</td>
<td>5+</td>
<td>J2EE1.4和JavaEE5</td>
</tr>
<tr>
<td>4.x</td>
<td>6+</td>
<td>Java EE6和7</td>
</tr>
<tr>
<td>5.x</td>
<td>8+</td>
<td>Java EE7</td>
</tr>
</tbody>
</table>
<h2 id="spring模块化设计"><a class="markdownIt-Anchor" href="#spring模块化设计"></a> Spring模块化设计</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework">仓库链接</a></p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205130273.png" alt="image-20210624205130273" /></p>
<h2 id="spring编程模型"><a class="markdownIt-Anchor" href="#spring编程模型"></a> Spring编程模型</h2>
<ol>
<li>
<p>面向对象编程</p>
<ol>
<li>锲约接口：Aware、BeanPostProcessor…</li>
<li>设计模式：观察者模式、组合模式、模板模式…</li>
<li>对象继承：Abstract类</li>
</ol>
</li>
<li>
<p>面向切面编程</p>
<ol>
<li>动态代理：JDKDynamicAopProxy</li>
<li>字节码提升：ASM、CGLib、AspectJ</li>
</ol>
</li>
<li>
<p>面向元编程</p>
<ol>
<li>注解：模式注解（@Component、@Service、@Respository…）</li>
<li>配置：Environment抽象、PropertySources、BeanDefinition…</li>
<li>泛型：Generic TypeResolver、Resolvable Type…</li>
</ol>
</li>
<li>
<p>函数驱动</p>
<ol>
<li>函数接口：ApplicationEventPublisher</li>
<li>Reactive：Spring WebFlux</li>
</ol>
</li>
<li>
<p>模块驱动</p>
<ol>
<li>Maven Artifacts</li>
<li>OSGI Bundies</li>
<li>Java 9 Automatic Modules</li>
<li>Spring @Enable*</li>
</ol>
<p>​</p>
</li>
</ol>
<h2 id="spring的核心价值"><a class="markdownIt-Anchor" href="#spring的核心价值"></a> Spring的核心价值</h2>
<ol>
<li>生态系统
<ol>
<li>Spring Boot</li>
<li>Spring Cloud</li>
<li>Spring Security</li>
<li>Spring Data</li>
<li>其他</li>
</ol>
</li>
<li>API抽象设计
<ol>
<li>AOP抽象</li>
<li>事务抽象</li>
<li>Environment抽象</li>
<li>生命周期</li>
</ol>
</li>
<li>编程模型
<ol>
<li>面向对象编程：契约接口</li>
<li>面向切面编程：动态代理、字节码提升</li>
<li>面向元编程：配置元信息、注解、配置</li>
<li>面向模块编程：Maven Artifacts、Java9 Automatic Modules</li>
<li>Spring @Enable*注解</li>
<li>面向函数式编程：Lambda、Reactive</li>
</ol>
</li>
<li>设计思想
<ol>
<li>Object-Oriented Programming（OOP）</li>
<li>Ioc/DI</li>
<li>Domain-Driven Development（DDD）</li>
<li>Test-Driven Development（TDD）</li>
<li>Event-Driven Programing（EDP）</li>
<li>Functional Programing（FP）</li>
</ol>
</li>
<li>设计模式
<ol>
<li>专属模式
<ol>
<li>前缀模式：Enable模式
<ol>
<li>Configurable模式</li>
</ol>
</li>
<li>后缀模式
<ol>
<li>处理器模式（Process、Resolver、Handler）</li>
<li>意识模式（Aware）</li>
<li>配置器模式（Configuror）</li>
<li>选择器模式（ImportSelector）</li>
</ol>
</li>
</ol>
</li>
<li>传统GoF23</li>
</ol>
</li>
<li>用户基础
<ol>
<li>Spring用户 Spring Framework、SpringBoot、Spring Cloud</li>
<li>传统用户 Java SE、Java EE</li>
</ol>
</li>
</ol>
<h2 id="面试题"><a class="markdownIt-Anchor" href="#面试题"></a> 面试题</h2>
<h3 id="什么是spring-framework"><a class="markdownIt-Anchor" href="#什么是spring-framework"></a> 什么是Spring Framework？</h3>
<p>Spring Framework提供一个完整性的编程或配置的一个现代化的基于Java的企业的应用，Spring的核心特点是在应用级别上的基础设施建设。</p>
<p>Spring使得你的应用开发变的更容易，它可以提供任何你想要的东西，并是拥抱企业环境的Java语言，并且支持可以运行在JVM上面的其他语言，比如Groovy或者Kotlin，同时也提供一些弹性，根据软件的需要提供不同的软件架构。</p>
<h3 id="spring-framwork有哪些核心模块"><a class="markdownIt-Anchor" href="#spring-framwork有哪些核心模块"></a> Spring Framwork有哪些核心模块？</h3>
<ol>
<li>Spring-core：Spring 基础API模块，如资源管理、泛型处理</li>
<li>Spring-beans：Spring Bean相关，如依赖查找，依赖注入</li>
<li>Spring-aop：Spring AOP处理，如动态代理，AOP字节码提升</li>
<li>Spring-context：事件驱动、注解驱动、模块驱动</li>
<li>Spring-expresson：Spring 表达式语言模块</li>
</ol>
<h3 id="spring-framework的优势和不足是什么"><a class="markdownIt-Anchor" href="#spring-framework的优势和不足是什么"></a> Spring Framework的优势和不足是什么？</h3>
<p>待定…</p>
<h1 id="ioc简介"><a class="markdownIt-Anchor" href="#ioc简介"></a> IoC简介</h1>
<h2 id="ioc的发展简介"><a class="markdownIt-Anchor" href="#ioc的发展简介"></a> IoC的发展简介</h2>
<ol>
<li>1983年，好莱坞原则</li>
<li>1988年，控制反转</li>
<li>1996年，Inversion of control -&gt; Hollywood principle</li>
<li>2004年，Martin Fowler提出了自己对IoC以及DI的理解</li>
<li>2005年，Martin Fowler对IoC做出了进一步的说明</li>
</ol>
<h2 id="ioc主要实现策略"><a class="markdownIt-Anchor" href="#ioc主要实现策略"></a> IoC主要实现策略</h2>
<ol>
<li>使用service locator pattern（服务定位模式）</li>
<li>通过依赖注入：
<ol>
<li>构造器注入</li>
<li>参数注入</li>
<li>Setter注入</li>
<li>接口注入</li>
</ol>
</li>
<li>上下文的依赖查询（beancontext）</li>
<li>模板方法设计模式（例如JDBC）</li>
<li>策略模式</li>
</ol>
<p>IoC主要的实现策略：依赖查找、依赖注入。</p>
<h2 id="ioc容器的职责"><a class="markdownIt-Anchor" href="#ioc容器的职责"></a> IoC容器的职责</h2>
<ol>
<li>依赖处理
<ol>
<li>依赖查找</li>
<li>依赖注入</li>
</ol>
</li>
<li>生命周期管理
<ol>
<li>容器</li>
<li>托管的资源（Java Beans或其他资源）</li>
</ol>
</li>
<li>配置
<ol>
<li>容器</li>
<li>外部化配置</li>
<li>托管的资源（Java Beans或其他资源）</li>
</ol>
</li>
</ol>
<h2 id="ioc的实现"><a class="markdownIt-Anchor" href="#ioc的实现"></a> IoC的实现</h2>
<ol>
<li>Java SE
<ul>
<li>Java Beans</li>
<li>Java ServiceLoader SPI</li>
<li>JNDI（Java Naming and Directory Interface）</li>
</ul>
</li>
<li>Java EE
<ul>
<li>EJB（Enterprise Java Beans）</li>
<li>Servlet</li>
</ul>
</li>
<li>开源
<ul>
<li>Apache Avalon</li>
<li>PicoContainer</li>
<li>Google Guice</li>
<li>Spring Framework</li>
</ul>
</li>
</ol>
<h2 id="传统ioc容器的实现"><a class="markdownIt-Anchor" href="#传统ioc容器的实现"></a> 传统IoC容器的实现</h2>
<p>Java Beans 作为IoC容器的特性：</p>
<ul>
<li>依赖查找</li>
<li>生命周期管理</li>
<li>配置元信息</li>
<li>事件</li>
<li>自定义</li>
<li>资源管理</li>
<li>持久化</li>
</ul>
<p>什么是Java Beans呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 描述人的POJO类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以打印这个Bean的元信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInfoDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        BeanInfo beanInfo = Introspector.getBeanInfo(Person.class, Object.class);</span><br><span class="line">        Stream.of(beanInfo.getPropertyDescriptors()).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.beans.PropertyDescriptor[name=age; propertyType=class java.lang.Integer; readMethod=public java.lang.Integer beans.Person.getAge(); writeMethod=public void beans.Person.setAge(java.lang.Integer)]</span><br><span class="line">java.beans.PropertyDescriptor[name=name; propertyType=class java.lang.String; readMethod=public java.lang.String beans.Person.getName(); writeMethod=public void beans.Person.setName(java.lang.String)]</span><br></pre></td></tr></table></figure>
<h2 id="如何界定ioc容器是轻量级的"><a class="markdownIt-Anchor" href="#如何界定ioc容器是轻量级的"></a> 如何界定IoC容器是轻量级的？</h2>
<p>以下观点出自于《J2EE Development without EJB》</p>
<ol>
<li>管理应用代码</li>
<li>能够快速启动</li>
<li>容器不需要一些特殊的配置来进行操作（主要是针对于EJB）</li>
<li>容器的内存占用小以及最小化API的一个依赖</li>
<li>容器需要一些可以管控的一个渠道，这个渠道能够帮助我们去部署和管理一些细粒度的对象，甚至是一些粗粒度的组件</li>
</ol>
<h2 id="依赖查找和依赖注入"><a class="markdownIt-Anchor" href="#依赖查找和依赖注入"></a> 依赖查找和依赖注入</h2>
<table>
<thead>
<tr>
<th>类型</th>
<th>依赖处理</th>
<th>实现便利性</th>
<th>代码入侵性</th>
<th>API依赖性</th>
<th>可读性</th>
</tr>
</thead>
<tbody>
<tr>
<td>依赖查找</td>
<td>主动获取</td>
<td>相对繁琐</td>
<td>侵入业务逻辑</td>
<td>依赖容器API</td>
<td>良好</td>
</tr>
<tr>
<td>依赖注入</td>
<td>被动提供</td>
<td>相对便利</td>
<td>低入侵性</td>
<td>不主动依赖容器API</td>
<td>一般</td>
</tr>
</tbody>
</table>
<h2 id="构造器注入和setter注入"><a class="markdownIt-Anchor" href="#构造器注入和setter注入"></a> 构造器注入和Setter注入</h2>
<p>Spring官方推荐使用构造器注入，这样可以确保在注入时，对象不为空，但是参数过多时会影响代码的整洁性，可能需要考虑重构。</p>
<p>Setter注入应该主要仅用于我们的可选性的注入，因为Setter的字段本身是可以为空的。</p>
<p>而《J2EE Development without EJB》认为应该使用Setter注入，原因在于：</p>
<ol>
<li>JavaBean属性能够获取更好的IDE支持</li>
<li>JavaBean属性通常是一个自文档的说明</li>
<li>在类型转换上有优势</li>
<li>大量的JavaBeans可能不经过任何修改就可以在JavaBean容器当中使用</li>
</ol>
<p>当然，Setter注入也有缺点，就是无法确定属性初始化的顺序。</p>
<h2 id="面试题-2"><a class="markdownIt-Anchor" href="#面试题-2"></a> 面试题</h2>
<h3 id="什么是ioc"><a class="markdownIt-Anchor" href="#什么是ioc"></a> 什么是IoC？</h3>
<p>简单地说，IoC是反转控制，类似于好莱坞原则，主要有依赖查找和依赖注入两种实现。按照IoC的定义，很多方面其实都是IoC，比如JavaBeans是IoC的一个容器实现，Servlet的容器也是IoC的实现，因为Servlet可以去依赖或者反向地通过JNDI的方式进行得到一些外部的一些资源，包括DataSource或者相关的EJB的组件，于此同时SpringFramework或者Peak Container的依赖注入的框架，也能帮助我们去实现IoC，除此之外，消息也可以看作是IoC的一种实现。</p>
<h3 id="依赖查找和依赖注入的区别"><a class="markdownIt-Anchor" href="#依赖查找和依赖注入的区别"></a> 依赖查找和依赖注入的区别？</h3>
<p>依赖查找是主动或手动的依赖查找方式，通常需要依赖容器或标准API实现。而依赖注入则是手动或自动依赖绑定的方式，无需依赖特定的容器和API。</p>
<h3 id="spring作为ioc容器有什么优势"><a class="markdownIt-Anchor" href="#spring作为ioc容器有什么优势"></a> Spring作为IoC容器有什么优势？</h3>
<p>典型的IoC管理，依赖查找和依赖注入，AOP抽象，事务抽象，事件机制，SPI扩展，强大的第三方整合，易测试性，更好的面向对象。</p>
<h1 id="ioc实践"><a class="markdownIt-Anchor" href="#ioc实践"></a> IoC实践</h1>
<h2 id="spring-ioc依赖查找"><a class="markdownIt-Anchor" href="#spring-ioc依赖查找"></a> Spring IoC依赖查找</h2>
<ol>
<li>根据Bean名称查找
<ul>
<li>实时查找</li>
<li>延迟查找</li>
</ul>
</li>
<li>根据Bean类型查找
<ul>
<li>单个Bean对象</li>
<li>集合Bean对象</li>
</ul>
</li>
<li>根据Bean名称+类型查找</li>
<li>根据Java注解查找</li>
</ol>
<p>新建一个用户类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个超级用户类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 超级用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Super</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperUser</span> <span class="keyword">extends</span> <span class="title">User</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SuperUser&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;address=&#x27;&quot;</span> + address + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;&#125; &quot;</span> + <span class="keyword">super</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddress</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 超级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Super &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>向容器中注入一些Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;吉永超&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;SuperUser&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.SuperUser&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;user&quot;</span> <span class="attr">primary</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">value</span>=<span class="string">&quot;深圳&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;objectFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.ObjectFactoryCreatingFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>依赖查找的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencyLookupDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 配置XML文件</span></span><br><span class="line">        <span class="comment">// 启动Spring应用上下文</span></span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 实时查找</span></span><br><span class="line">        lookupInRealTime(beanFactory);</span><br><span class="line">        <span class="comment">// 延迟查找</span></span><br><span class="line">        lookupInLazy(beanFactory);</span><br><span class="line">        <span class="comment">// 按照类型查找</span></span><br><span class="line">        lookupByType(beanFactory);</span><br><span class="line">        <span class="comment">// 按照类型查找集合对象</span></span><br><span class="line">        lookupCollectionType(beanFactory);</span><br><span class="line">        <span class="comment">// 通过注解查找</span></span><br><span class="line">        lookupByAnnotationType(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过注解查找</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByAnnotationType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">            ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">            Map&lt;String, User&gt; users = (Map)listableBeanFactory.getBeansWithAnnotation(Super.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;查找到的所有标注@Super的User集合对象：&quot;</span> + users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照类型查找集合对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupCollectionType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">            ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">            Map&lt;String, User&gt; users = listableBeanFactory.getBeansOfType(User.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;查找到的所有的User集合对象：&quot;</span> + users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照类型查找</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        User user = beanFactory.getBean(User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;按照类型查找 &quot;</span> + user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟查找</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupInLazy</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        ObjectFactory&lt;User&gt; objectFactory = (ObjectFactory&lt;User&gt;) beanFactory.getBean(<span class="string">&quot;objectFactory&quot;</span>);</span><br><span class="line">        User user = objectFactory.getObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;延迟查找 &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实时查找</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupInRealTime</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        User user = (User) beanFactory.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;实时查找&quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-ioc依赖注入"><a class="markdownIt-Anchor" href="#spring-ioc依赖注入"></a> Spring IoC依赖注入</h2>
<ol>
<li>根据Bean名称注入</li>
<li>根据Bean类型注入
<ul>
<li>单个Bean对象</li>
<li>集合Bean对象</li>
</ul>
</li>
<li>注入容器内建的Bean对象</li>
<li>注入非Bean对象</li>
<li>注入类型
<ul>
<li>实时注入</li>
<li>延迟注入</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息仓库</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRespository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; users; <span class="comment">// 自定义Bean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory; <span class="comment">//内建的非Bean对象（对象）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectFactory&lt;ApplicationContext&gt; objectFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;User&gt; <span class="title">getUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsers</span><span class="params">(Collection&lt;User&gt; users)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.users = users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectFactory&lt;ApplicationContext&gt; <span class="title">getObjectFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> objectFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObjectFactory</span><span class="params">(ObjectFactory&lt;ApplicationContext&gt; objectFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objectFactory = objectFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个类似的资源：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 通过导入复用   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;dependency-lookup-context.xml&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--   Auto-wiring     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userRespository&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.repository.UserRespository&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--   手动配置     --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;users&quot;&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;util:list&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;ref bean=&quot;user&quot;&gt;&lt;/ref&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;ref bean=&quot;SuperUser&quot;&gt;&lt;/ref&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;/util:list&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/property&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencyInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 配置XML文件</span></span><br><span class="line">        <span class="comment">// 启动Spring应用上下文</span></span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;META-INF/dependency-injection-context.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        UserRespository userRespository = beanFactory.getBean(<span class="string">&quot;userRespository&quot;</span>, UserRespository.class);</span><br><span class="line"><span class="comment">//        System.out.println(userRespository.getUsers());</span></span><br><span class="line">        System.out.println(userRespository.getBeanFactory());</span><br><span class="line"><span class="comment">//        System.out.println(userRespository.getBeanFactory() == beanFactory);</span></span><br><span class="line">        ObjectFactory&lt;ApplicationContext&gt; userFactory = userRespository.getObjectFactory();</span><br><span class="line">        System.out.println(userFactory.getObject() == beanFactory);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比结果可以发现依赖查找和依赖注入的来源并不一样。</p>
<h2 id="spring依赖注入和依赖查找的来源"><a class="markdownIt-Anchor" href="#spring依赖注入和依赖查找的来源"></a> Spring依赖注入和依赖查找的来源</h2>
<ol>
<li>自定义Bean</li>
<li>容器内建Bean对象</li>
<li>容器内建依赖</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencyInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 配置XML文件</span></span><br><span class="line">        <span class="comment">// 启动Spring应用上下文</span></span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;META-INF/dependency-injection-context.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 自定义的Bean</span></span><br><span class="line">        UserRespository userRespository = beanFactory.getBean(<span class="string">&quot;userRespository&quot;</span>, UserRespository.class);</span><br><span class="line">        <span class="comment">// 依赖注入（内建依赖）</span></span><br><span class="line">        System.out.println(userRespository.getBeanFactory());</span><br><span class="line">        <span class="comment">// 容器内建Bean对象</span></span><br><span class="line">        Environment environment = beanFactory.getBean(Environment.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;获取Enviroment类型的Bean&quot;</span> + environment);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-ioc配置元信息"><a class="markdownIt-Anchor" href="#spring-ioc配置元信息"></a> Spring IoC配置元信息</h2>
<ol>
<li>Bean定义配置
<ul>
<li>基于XML文件</li>
<li>基于Properties文件</li>
<li>基于Java注解</li>
<li>基于Java API（专题讨论）</li>
</ul>
</li>
<li>IoC容器配置
<ul>
<li>基于XML文件</li>
<li>基于Java注解</li>
<li>基于Java API（专题讨论）</li>
</ul>
</li>
<li>外部化属性配置
<ul>
<li>基于Java注解</li>
</ul>
</li>
</ol>
<h2 id="beanfactory和applicationcontext"><a class="markdownIt-Anchor" href="#beanfactory和applicationcontext"></a> BeanFactory和ApplicationContext</h2>
<p>BeanFactory和ApplicationContext谁才是Spring IoC容器？</p>
<p>BeanFactory是一个具有基本功能的框架，而ApplicationContext添加了更多企业级的特性，总而言之，ApplicationContext是BeanFactory的超集，并且在实现上，ApplicationContext虽然继承了BeanFactory接口，但内部的BeanFactory是采用组合的方式进行的实现，默认的实现类为DefaultListableBeanFactory。</p>
<p>ApplicationContext除了IoC容器角色，还有提供：</p>
<ul>
<li>面向切面（AOP）</li>
<li>配置元信息（Configuration Metadata）</li>
<li>资源管理（Resources）</li>
<li>事件（Events）</li>
<li>国际化（i18n）</li>
<li>注解（Annotations）</li>
<li>Environment抽象（Environment Abstraction）</li>
</ul>
<p>BeanFactory的IoC容器的使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BeanFactory作为IoC容器示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactoryAsIoCContainerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建BeanFactory容器</span></span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 加载配置</span></span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        <span class="comment">// XML配置文件ClassPath路径</span></span><br><span class="line">        String location = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        <span class="comment">// 加载配置</span></span><br><span class="line">        <span class="keyword">int</span> beanDefinitions = reader.loadBeanDefinitions(location);</span><br><span class="line">        System.out.println(<span class="string">&quot;Bean定义加载的数量: &quot;</span> + beanDefinitions);</span><br><span class="line">        <span class="comment">// 依赖查找集合对象....</span></span><br><span class="line">        lookupCollectionType(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照类型查找集合对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupCollectionType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">            ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">            Map&lt;String, User&gt; users = listableBeanFactory.getBeansOfType(User.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;查找到的所有的User集合对象：&quot;</span> + users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Application的IoC容器使用：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ApplicationA作为IoC容器示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationApplicationAsIoCContainerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建BeanFactory容器</span></span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(AnnotationApplicationAsIoCContainerDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 依赖查找集合对象....</span></span><br><span class="line">        lookupCollectionType(applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照类型查找集合对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupCollectionType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">            ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">            Map&lt;String, User&gt; users = listableBeanFactory.getBeansOfType(User.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;查找到的所有的User集合对象：&quot;</span> + users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，使用BeanFactory和ApplicationContext都可以完成依赖查找的功能。</p>
<h2 id="spring-ioc容器生命周期"><a class="markdownIt-Anchor" href="#spring-ioc容器生命周期"></a> Spring IoC容器生命周期</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">		StartupStep contextRefresh = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">		prepareRefresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">		ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">		prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">			postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			StartupStep beanPostProcess = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">			<span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">			invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">			registerBeanPostProcessors(beanFactory);</span><br><span class="line">			beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize message source for this context.</span></span><br><span class="line">			initMessageSource();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">			initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">			onRefresh();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">			registerListeners();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">			finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">			finishRefresh();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">				logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">						<span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">			destroyBeans();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">			cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">			<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">			resetCommonCaches();</span><br><span class="line">			contextRefresh.end();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-3"><a class="markdownIt-Anchor" href="#面试题-3"></a> 面试题</h2>
<h3 id="什么是spring-ioc容器"><a class="markdownIt-Anchor" href="#什么是spring-ioc容器"></a> 什么是Spring IoC容器</h3>
<p>Spring Framework是IoC（控制反转）的一种具体的实现，主要包括了DI（dependency injection），和DL（dependency lookup）。</p>
<h3 id="beanfactory和factorybean"><a class="markdownIt-Anchor" href="#beanfactory和factorybean"></a> BeanFactory和FactoryBean</h3>
<p>BeanFactory是IoC底层容器，FactoryBean是创建Bean的一种方式，帮助实现复杂的初始化逻辑。</p>
<h3 id="spring-ioc容器启动时做了哪些准备"><a class="markdownIt-Anchor" href="#spring-ioc容器启动时做了哪些准备"></a> Spring IoC容器启动时做了哪些准备？</h3>
<p>IoC配置元信息读取和解析、IoC容器生命周期、Spring事件发布、国际化等。</p>
<h1 id="spring-bean基础"><a class="markdownIt-Anchor" href="#spring-bean基础"></a> Spring Bean基础</h1>
<h2 id="beandefinition"><a class="markdownIt-Anchor" href="#beandefinition"></a> BeanDefinition</h2>
<p>BeanDefinition时Spring Framework中定义Bean配置元信息接口，包含：</p>
<ol>
<li>Bean的类名（必须是全限定类名）</li>
<li>Bean行为配置元素，如作用域、自动绑定的模式、生命周期回调等</li>
<li>其他Bean引用，又可称合作者（collaborators）或者依赖（dependencies）</li>
<li>配置设置，比如Bean属性（Properties）</li>
</ol>
<p>BeanDefinition元信息</p>
<table>
<thead>
<tr>
<th>属性（Property）</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Class</td>
<td>Bean全类名，必须是具体类，不能用抽象类或接口</td>
</tr>
<tr>
<td>Name</td>
<td>Bean的名称或者ID</td>
</tr>
<tr>
<td>Scope</td>
<td>Bean的作用域（如：singleton、prototype等）</td>
</tr>
<tr>
<td>Constructor arguments</td>
<td>Bean构造器参数（用于依赖注入）</td>
</tr>
<tr>
<td>Properties</td>
<td>Bean属性设置（用于依赖注入）</td>
</tr>
<tr>
<td>Autowiring mode</td>
<td>Bean自动绑定模式（如：通过名称byName）</td>
</tr>
<tr>
<td>Lazy initialization mode</td>
<td>Bean延迟初始化模式（延迟和非延迟）</td>
</tr>
<tr>
<td>Initialization method</td>
<td>Bean初始化回调方法名称</td>
</tr>
<tr>
<td>Destruction method</td>
<td>Bean销毁回调方法名称</td>
</tr>
</tbody>
</table>
<p>BeanDefinition的构建方式</p>
<ol>
<li>通过BeanDefinitionBuilder</li>
<li>通过AbstactBeanDefinition以及派生类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BeanDefinition构建示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDefinitionCreationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.通过BeanDefinitionBuilder</span></span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(User.class);</span><br><span class="line">        <span class="comment">// 通过属性设置</span></span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;jyc&quot;</span>);</span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;age&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取BeanDefinition实例</span></span><br><span class="line">        AbstractBeanDefinition beanDefinition = beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line">        <span class="comment">// BeanDefinition并非Bean的终态，可以自定义修改</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.通过AbstactBeanDefinition以及派生类</span></span><br><span class="line">        GenericBeanDefinition genericBeanDefinition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">        <span class="comment">// 设置Bean类型</span></span><br><span class="line">        genericBeanDefinition.setBeanClass(User.class);</span><br><span class="line">        <span class="comment">// 通过MutablePropertyValues批量操作属性</span></span><br><span class="line">        MutablePropertyValues propertyValues = <span class="keyword">new</span> MutablePropertyValues();</span><br><span class="line">        propertyValues.addPropertyValue(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        propertyValues.addPropertyValue(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;jyc&quot;</span>);</span><br><span class="line">        genericBeanDefinition.setPropertyValues(propertyValues);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-bean命名"><a class="markdownIt-Anchor" href="#spring-bean命名"></a> Spring Bean命名</h2>
<p>什么是Bean的名称？</p>
<p>每个Bean拥有一个或多个标识符（identifiers），这些标识符在Bean所在的容器必须是唯一的。通常，一个Bean仅有一个标识符，如果需要额外的，可考虑使用别名（Alias）来扩充。</p>
<p>在基于XML的配置元信息中，开发人员可用id或者name属性来规定Bean的标识符。通常Bean的标识符由字母组成，允许出现特殊字符，如果要想映入新的Bean的别名的话，可在name属性使用半角逗号（“,”）或分号（“;”）来间隔。</p>
<p>Bean的id或name属性并非必须制定，如果留空的话，容器回味Bean自动生成一个唯一的名称。Bean的名称尽管没有限制，不过官方建议采用驼峰的方式，更符合Java的命名约定。</p>
<p>Bean名称生成器（BeanNameGenerator）主要有两种实现：</p>
<ol>
<li>DefaultBeanNameGenerator（默认通用BeanNameGenerator实现）</li>
<li>AnnotationBeanNameGenerator</li>
</ol>
<p>默认实现的核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateBeanName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		BeanDefinition definition, BeanDefinitionRegistry registry, <span class="keyword">boolean</span> isInnerBean)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">	String generatedBeanName = definition.getBeanClassName();</span><br><span class="line">	<span class="keyword">if</span> (generatedBeanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (definition.getParentName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			generatedBeanName = definition.getParentName() + <span class="string">&quot;$child&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (definition.getFactoryBeanName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			generatedBeanName = definition.getFactoryBeanName() + <span class="string">&quot;$created&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(generatedBeanName)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;Unnamed bean definition specifies neither &quot;</span> +</span><br><span class="line">				<span class="string">&quot;&#x27;class&#x27; nor &#x27;parent&#x27; nor &#x27;factory-bean&#x27; - can&#x27;t generate bean name&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (isInnerBean) &#123;</span><br><span class="line">		<span class="comment">// Inner bean: generate identity hashcode suffix.</span></span><br><span class="line">		<span class="keyword">return</span> generatedBeanName + GENERATED_BEAN_NAME_SEPARATOR + ObjectUtils.getIdentityHexString(definition);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Top-level bean: use plain class name with unique suffix if necessary.</span></span><br><span class="line">	<span class="keyword">return</span> uniqueBeanName(generatedBeanName, registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是简单场景的Bean的名称：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uniqueBeanName</span><span class="params">(String beanName, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">	String id = beanName;</span><br><span class="line">	<span class="keyword">int</span> counter = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Increase counter until the id is unique.</span></span><br><span class="line">	String prefix = beanName + GENERATED_BEAN_NAME_SEPARATOR;</span><br><span class="line">	<span class="keyword">while</span> (counter == -<span class="number">1</span> || registry.containsBeanDefinition(id)) &#123;</span><br><span class="line">		counter++;</span><br><span class="line">		id = prefix + counter;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解实现的核心源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">generateBeanName</span><span class="params">(BeanDefinition definition, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (definition <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">			String beanName = determineBeanNameFromAnnotation((AnnotatedBeanDefinition) definition);</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(beanName)) &#123;</span><br><span class="line">				<span class="comment">// Explicit bean name found.</span></span><br><span class="line">				<span class="keyword">return</span> beanName;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Fallback: generate a unique default bean name.</span></span><br><span class="line">		<span class="keyword">return</span> buildDefaultBeanName(definition, registry);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>如果是一个普通的Bean就会调用Java Beans的API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">buildDefaultBeanName</span><span class="params">(BeanDefinition definition)</span> </span>&#123;</span><br><span class="line">	String beanClassName = definition.getBeanClassName();</span><br><span class="line">	Assert.state(beanClassName != <span class="keyword">null</span>, <span class="string">&quot;No bean class name set&quot;</span>);</span><br><span class="line">	String shortClassName = ClassUtils.getShortName(beanClassName);</span><br><span class="line">	<span class="keyword">return</span> Introspector.decapitalize(shortClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bean别名（Alias）的价值：</p>
<ol>
<li>
<p>复用现有的BeanDefinition</p>
</li>
<li>
<p>更具有场景化的命名方法，比如：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&quot;myApp-dataSource&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;subsystemA-datasource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&quot;myApp-dataSource&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;subsystemB-datasource&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="beandefinition注册到ioc容器"><a class="markdownIt-Anchor" href="#beandefinition注册到ioc容器"></a> BeanDefinition注册到IoC容器</h2>
<p>BeanDefinition注册的不同方式：</p>
<ol>
<li>XML配置元信息
<ul>
<li>&lt;bean name =&quot;…&quot; … /&gt;</li>
</ul>
</li>
<li>Java注解配置元信息
<ul>
<li>@Bean</li>
<li>@Component</li>
<li>@import</li>
</ul>
</li>
<li>Java API配置元信息
<ul>
<li>命名方式：BeanDefinitionRegistry#registerBeanDefinition（String，BeanDefinition）</li>
<li>非命名方式：BeanDefinitionReaderUtils#registerWithGeneratedName(AbstractBeanDefinition，BeanDefinitionRegistry)</li>
<li>配置类方式：AnnotatedBeanDefinitionReader#register（Class）</li>
</ul>
</li>
</ol>
<p>通过Java注解配置元信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解BeanDefinition示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Import(AnnotationBeanDefinitionDemo.Config.class)</span> <span class="comment">// 3.通过@Import方式导入</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationBeanDefinitionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 注册配置类（configuration class）</span></span><br><span class="line">        applicationContext.register(AnnotationBeanDefinitionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        System.out.println(<span class="string">&quot;Config类型的所有的Beans&quot;</span> + applicationContext.getBeansOfType(Config.class));</span><br><span class="line">        System.out.println(<span class="string">&quot;user类型的所有的Beans&quot;</span> + applicationContext.getBeansOfType(User.class));</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.通过Component方式</span></span><br><span class="line">    <span class="meta">@Component</span> <span class="comment">//定义当前类作为Spring Bean（组件）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.通过@Bean方式定义</span></span><br><span class="line">        <span class="meta">@Bean(&#123;&quot;user&quot;, &quot;jyc&quot;&#125;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setId(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            user.setName(<span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java API配置元信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 命名Bean的注册方式</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerUserBeanDefinition</span><span class="params">(BeanDefinitionRegistry registry, String beanName)</span> </span>&#123;</span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(User.class);</span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>).addPropertyValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jiyongchao&quot;</span>);</span><br><span class="line">        <span class="comment">// 判断如果beanName参数存在时</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(beanName)) &#123;</span><br><span class="line">            registry.registerBeanDefinition(beanName, beanDefinitionBuilder.getBeanDefinition());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非命名的Bean注册方法</span></span><br><span class="line">            BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinitionBuilder.getBeanDefinition(), registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="实例化bean的方式"><a class="markdownIt-Anchor" href="#实例化bean的方式"></a> 实例化Bean的方式</h2>
<p>Bean实例化：</p>
<ol>
<li>
<p>常规方式</p>
<ul>
<li>通过构造器（配置元信息：XML、Java注解和Java API）</li>
<li>通过静态工厂方法（配置元信息：XML和Java API）</li>
<li>通过Bean工厂方法（配置元信息：XML和Java API）</li>
<li>通过FactoryBean（配置元信息：XML、Java注解和Java API）</li>
</ul>
</li>
<li>
<p>特殊方式</p>
<ul>
<li>通过ServiceLoaderFactoryBean（配置元信息：XML、Java注解和Java API）</li>
<li>通过AutowireCapableBeanFactory#createBean（java.lang.Class，int，boolean）</li>
<li>通过BeanDefinitionResgistry#registerBeanDefinition（String，BeanDefinition）</li>
</ul>
<p>常规方式实例化的示例：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  静态方法实例化Bean  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user-by-static-method&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;createUser&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  实例方法实例化Bean  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user-by-instance-method&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;userFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;createUser&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  Bean工厂实例化Bean  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.definition.factory.DefaultUserFactory&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  FactoryBean实例化Bean  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user-by-factory-bean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.definition.factory.UserFactoryBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中UserFactoryBean为：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * User Bean的FactoryBean的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试输出：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bean实例化示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInstantiationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/bean-instantiation-context.xml&quot;</span>);</span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user-by-static-method&quot;</span>, User.class);</span><br><span class="line">        User userByInstanceMethod = beanFactory.getBean(<span class="string">&quot;user-by-instance-method&quot;</span>, User.class);</span><br><span class="line">        User userByFactoryBean = beanFactory.getBean(<span class="string">&quot;user-by-instance-method&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        System.out.println(userByInstanceMethod);</span><br><span class="line">        System.out.println(userByFactoryBean);</span><br><span class="line"></span><br><span class="line">        System.out.println(user == userByInstanceMethod);</span><br><span class="line">        System.out.println(user == userByFactoryBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特殊方式的示例：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userFactoryServiceLoader&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serviceType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.definition.factory.UserFactory&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试输出：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecialBeanInstantiationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/special-bean-instantiation-context.xml&quot;</span>);</span><br><span class="line">        ServiceLoader serviceLoader = beanFactory.getBean(<span class="string">&quot;userFactoryServiceLoader&quot;</span>, ServiceLoader.class);</span><br><span class="line">        displayServiceLoader(serviceLoader);</span><br><span class="line">        demoServiceLoader();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demoServiceLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceLoader&lt;UserFactory&gt; serviceLoader = ServiceLoader.load(UserFactory.class, Thread.currentThread().getContextClassLoader());</span><br><span class="line">        displayServiceLoader(serviceLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayServiceLoader</span><span class="params">(ServiceLoader&lt;UserFactory&gt; serviceLoader)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;UserFactory&gt; iterator = serviceLoader.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            UserFactory userFactory = iterator.next();</span><br><span class="line">            System.out.println(userFactory.createUser());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过AutowireCapableBeanFactory实例化：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/special-bean-instantiation-context.xml&quot;</span>);</span><br><span class="line">     <span class="comment">// 通过ApplicationContext获取AutowireCapableBeanFactory</span></span><br><span class="line">     AutowireCapableBeanFactory beanFactory = applicationContext.getAutowireCapableBeanFactory();</span><br><span class="line">     <span class="comment">// 通过AutowireCapableBeanFactory创建UserFactory对象</span></span><br><span class="line">     UserFactory userFactory = beanFactory.createBean(DefaultUserFactory.class);</span><br><span class="line">     System.out.println(userFactory.createUser());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化bean的方式"><a class="markdownIt-Anchor" href="#初始化bean的方式"></a> 初始化Bean的方式</h2>
<p>Bean的初始化（Initialization）：</p>
<ol>
<li>@PostConstruct标注方法</li>
<li>实现InitializingBean接口的afterPropertiesSet()方法</li>
<li>自定义初始化方法
<ul>
<li>XML配置：&lt;bean init-method=“init” … /&gt;</li>
<li>Java注解：@Bean(initMethod=“init”)</li>
<li>Java API：AbstractBeanDefinition#setInitMethodName(String)</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>初始化的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultUserFactory</span> <span class="keyword">implements</span> <span class="title">UserFactory</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.基于@PostConstruct注解</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@PostConstruct: UserFactory 初始化中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterPropertiesSet: UserFactory 初始化中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initUserFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;自定义初始化方法： initUserFactory： UserFactory 初始化中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInitializationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(BeanInitializationDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        UserFactory userFactory = applicationContext.getBean(UserFactory.class);</span><br><span class="line">        applicationContext.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;initUserFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserFactory <span class="title">userFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultUserFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终实际上都会调用的AbstractBeanDefinition的setInitMethodName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInitMethodName</span><span class="params">(<span class="meta">@Nullable</span> String initMethodName)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.initMethodName = initMethodName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三者的执行顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span>: UserFactory 初始化中....</span><br><span class="line">afterPropertiesSet: UserFactory 初始化中....</span><br><span class="line">自定义初始化方法： initUserFactory： UserFactory 初始化中....</span><br></pre></td></tr></table></figure>
<h2 id="延迟初始化bean"><a class="markdownIt-Anchor" href="#延迟初始化bean"></a> 延迟初始化Bean</h2>
<p>Bean延迟初始化（Lazy Initialization）</p>
<ol>
<li>XML配置：&lt;bean lazy-init=“true” …/&gt;</li>
<li>Java注解：@Lazy(true)</li>
</ol>
<p>Spring容器返回的对象和非延迟的对象存在怎样的差异？</p>
<p>非延迟初始化在Spring应用上下文启动完成后，被初始化。而延迟初始化是在依赖查找和依赖注入的时候才会进行初始化。</p>
<h2 id="销毁bean"><a class="markdownIt-Anchor" href="#销毁bean"></a> 销毁Bean</h2>
<p>Bean销毁（Destroy）</p>
<ol>
<li>@PreDestory标注方法</li>
<li>实现DisposableBean接口的destory()方法</li>
<li>自定义销毁方法
<ul>
<li>XML配置：&lt;bean destory=“destory” …/&gt;</li>
<li>Java注解：@Bean(destory=“destory”)</li>
<li>Java API: AbstractBeanDefinition#setDestoryMethodName(String)</li>
</ul>
</li>
</ol>
<p>销毁的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultUserFactory</span> <span class="keyword">implements</span> <span class="title">UserFactory</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@PreDestroy: UserFactory 销毁中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DisposableBean#destroy: UserFactory 销毁中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;自定义销毁方法：doDestory()： UserFactory 销毁中....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDestoryDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(BeanDestoryDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 非延迟初始化在Spring应用上下文启动完成后，被初始化。</span></span><br><span class="line">        System.out.println(<span class="string">&quot;应用上下文已启动...&quot;</span>);</span><br><span class="line">        UserFactory userFactory = applicationContext.getBean(UserFactory.class);</span><br><span class="line">        System.out.println(userFactory);</span><br><span class="line">        System.out.println(<span class="string">&quot;应用上下文准备关闭...&quot;</span>);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;应用上下文已关闭...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod = &quot;doDestory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserFactory <span class="title">userFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultUserFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过不同时机的打印，可以观察到Bean的销毁的时机就是在应用上下文关闭的时候。</p>
<p>三者不同方式的执行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">应用上下文已启动...</span><br><span class="line">应用上下文准备关闭...</span><br><span class="line"><span class="meta">@PreDestroy</span>: UserFactory 销毁中....</span><br><span class="line">DisposableBean#destroy: UserFactory 销毁中....</span><br><span class="line">自定义销毁方法：doDestory()： UserFactory 销毁中....</span><br><span class="line">应用上下文已关闭...</span><br></pre></td></tr></table></figure>
<h2 id="垃圾回收spring-bean"><a class="markdownIt-Anchor" href="#垃圾回收spring-bean"></a> 垃圾回收Spring Bean</h2>
<p>Bean垃圾回收（GC）</p>
<ol>
<li>关闭Spring容器（应用上下文）</li>
<li>执行GC</li>
<li>Spring Bean覆盖的finalize()方法被回调</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bena垃圾回收的示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanGarbageCollectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(BeanInitializationDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 应用上下文已关闭&quot;</span>);</span><br><span class="line">        <span class="comment">// 强制触发GC</span></span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们重写了DefaultUserFactory中的finalize()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;当前DefaultUserFactory 对象正在被垃圾回收&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-4"><a class="markdownIt-Anchor" href="#面试题-4"></a> 面试题</h2>
<h3 id="如何注册一个spring-bean"><a class="markdownIt-Anchor" href="#如何注册一个spring-bean"></a> 如何注册一个Spring Bean？</h3>
<p>通过BeanDefinition和外部单体对象来注册。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 单体Bean注册示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonBeanRegistrationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 注册外部单例对象</span></span><br><span class="line">        UserFactory userFactory = <span class="keyword">new</span> DefaultUserFactory();</span><br><span class="line">        <span class="comment">// 创建一个外部UserFactory对象</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = applicationContext.getBeanFactory();</span><br><span class="line">        <span class="comment">// 注册外部单例对象</span></span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;userFactory&quot;</span>, userFactory);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        UserFactory userFactoryByLookup = beanFactory.getBean(<span class="string">&quot;userFactory&quot;</span>, UserFactory.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;userFactory == userFactoryByLookup: &quot;</span> + (userFactory == userFactoryByLookup));</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="什么是spring-beandefinition"><a class="markdownIt-Anchor" href="#什么是spring-beandefinition"></a> 什么是Spring BeanDefinition？</h3>
<p>BeanDefinition是关于Bean定义的元信息的接口，允许我们通过getter、setter方法方式来进行存储信息。</p>
<h3 id="spring容器是怎样管理注册bean"><a class="markdownIt-Anchor" href="#spring容器是怎样管理注册bean"></a> Spring容器是怎样管理注册Bean</h3>
<p>如IoC配置元信息读取和解析、依赖查找和注入以及Bean生命周期等。</p>
<h1 id="依赖查找"><a class="markdownIt-Anchor" href="#依赖查找"></a> 依赖查找</h1>
<h2 id="依赖查找简介"><a class="markdownIt-Anchor" href="#依赖查找简介"></a> 依赖查找简介</h2>
<ol>
<li>单一类型依赖查找
<ul>
<li>JNDI - javax.naming.Context#lookup(<a target="_blank" rel="noopener" href="http://javax.naming.Name">javax.naming.Name</a>)</li>
<li>JavaBeans - java.beans.beancontext.BeanContext</li>
</ul>
</li>
<li>集合类型依赖查找
<ul>
<li>java.beans.beancontext.BeanContext</li>
</ul>
</li>
<li>层次性依赖查找
<ul>
<li>java.beans.beancontext.BeanContext</li>
</ul>
</li>
</ol>
<h2 id="单一类型依赖查找"><a class="markdownIt-Anchor" href="#单一类型依赖查找"></a> 单一类型依赖查找</h2>
<p>单一类型依赖查找接口-BeanFactory</p>
<ol>
<li>根据Bean名称查找
<ul>
<li>getBean(String)</li>
<li>Spring 2.5 覆盖默认参数：getBean(String,Object…)</li>
</ul>
</li>
<li>根据Bean类型查找
<ul>
<li>Bean实时查找
<ul>
<li>Spring 3.0 getBean(Class)</li>
<li>Spring 4.1 覆盖默认参数：getBean(Class,Object…)</li>
</ul>
</li>
<li>Spring 5.1 Bean延迟查找
<ul>
<li>getBeanProvider(Class)</li>
<li>getBeanProvider(ResolvableType)</li>
</ul>
</li>
</ul>
</li>
<li>根据Bean名称 + 类型查找：getBean(String,Class)</li>
</ol>
<p>利用ObejctProvider进行依赖查找：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过ObjectProvider进行依赖查找</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObejctProviderDemo</span> </span>&#123; <span class="comment">// @Configuration是非必须的注解</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(ObejctProviderDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        lookupByObejctProvider(applicationContext);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloworld</span><span class="params">()</span> </span>&#123; <span class="comment">// 方法名就是Bean名称 = “helloworld”</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByObejctProvider</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        ObjectProvider&lt;String&gt; beanProvider = applicationContext.getBeanProvider(String.class);</span><br><span class="line">        System.out.println(beanProvider.getObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="集合类型依赖查找"><a class="markdownIt-Anchor" href="#集合类型依赖查找"></a> 集合类型依赖查找</h2>
<p>集合类型依赖查找接口-ListableBeanFactory</p>
<ol>
<li>根据Bean类型查找
<ul>
<li>根据同类型Bean名称列表
<ul>
<li>getBeanNamesForType（Class）</li>
<li>Spring 4.2 getBeanNamesForType（ResolvableType）</li>
</ul>
</li>
<li>获取同类型Bean实例列表
<ul>
<li>getBeanOfType（Class）以及重载方法</li>
</ul>
</li>
</ul>
</li>
<li>通过注解类型查找
<ul>
<li>Spring 3.0 获取标注类型Bean名称列表
<ul>
<li>getBeanNamesForAnnotation（Class&lt;? extends Annotation&gt;）</li>
</ul>
</li>
<li>Spring 3.0 获取标注类型Bean实例列表
<ul>
<li>getBeansWithAnnotation（Class&lt;? extends Annotation&gt;）</li>
</ul>
</li>
<li>Spring 3.0 获取指定名称 + 标注类型Bean 实例</li>
</ul>
</li>
</ol>
<p>相关的示例实际上在之前就已经提到过了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过注解查找</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByAnnotationType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">          ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">          Map&lt;String, User&gt; users = (Map)listableBeanFactory.getBeansWithAnnotation(Super.class);</span><br><span class="line">          System.out.println(<span class="string">&quot;查找到的所有标注@Super的User集合对象：&quot;</span> + users);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 按照类型查找集合对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupCollectionType</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ListableBeanFactory) &#123;</span><br><span class="line">          ListableBeanFactory listableBeanFactory = (ListableBeanFactory) beanFactory;</span><br><span class="line">          Map&lt;String, User&gt; users = listableBeanFactory.getBeansOfType(User.class);</span><br><span class="line">          System.out.println(<span class="string">&quot;查找到的所有的User集合对象：&quot;</span> + users);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="层次性依赖查找"><a class="markdownIt-Anchor" href="#层次性依赖查找"></a> 层次性依赖查找</h2>
<p>层次性依赖查找接口-HierachicalBeanFactory</p>
<ol>
<li>双亲BeanFactory：getParentBeanFacotry</li>
<li>层次性查找：
<ul>
<li>根据Bean名称查找
<ul>
<li>基于containsLocalBean方法实现</li>
</ul>
</li>
<li>根据Bean类型查找实例列表
<ul>
<li>单一类型：BeanFactoryUtils#beanOfType</li>
<li>集合类型BeanFactoryUtils#beanOfTypeIncludingAncestors</li>
</ul>
</li>
<li>根据Java注解查找名称列表
<ul>
<li>BeanFactoryUtils#beanNamesForTypeIncludingAncestors</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="延迟依赖查找"><a class="markdownIt-Anchor" href="#延迟依赖查找"></a> 延迟依赖查找</h2>
<p>Bean延迟依赖查找接口</p>
<ol>
<li>org.springframework.beans.factory.ObjectFactory</li>
<li>org.springframwork.beans.factory.ObjecyProvider
<ul>
<li>Spring 5 对Java8特性扩展
<ul>
<li>函数式接口
<ul>
<li>getIfAvailable(Supplier)</li>
<li>ifAvailable(Consumer)</li>
</ul>
</li>
<li>Stream扩展-stream()</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>相关示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObejctProviderDemo</span> </span>&#123; <span class="comment">// @Configuration是非必须的注解</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(ObejctProviderDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        lookupByObejctProvider(applicationContext);</span><br><span class="line">        lookupIfAvailable(applicationContext);</span><br><span class="line">        lookupByStreamOps(applicationContext);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByStreamOps</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        ObjectProvider&lt;String&gt; beanProvider = applicationContext.getBeanProvider(String.class);</span><br><span class="line"><span class="comment">//        Iterable&lt;String&gt; stringIterable = beanProvider;</span></span><br><span class="line"><span class="comment">//        for (String string : stringIterable) &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(string);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        beanProvider.stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupIfAvailable</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// User对象并不存在</span></span><br><span class="line">        ObjectProvider&lt;User&gt; userObjectProvider = applicationContext.getBeanProvider(User.class);</span><br><span class="line">        User user = userObjectProvider.getIfAvailable(User::createUser);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前User对象: &quot;</span> + user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloworld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">message</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Message&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lookupByObejctProvider</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        ObjectProvider&lt;String&gt; beanProvider = applicationContext.getBeanProvider(String.class);</span><br><span class="line">        System.out.println(beanProvider.getObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安全依赖查找"><a class="markdownIt-Anchor" href="#安全依赖查找"></a> 安全依赖查找</h2>
<p>安全性指的是没有查找到Bean的时候，是否会抛出异常。有关依赖查找安全性对比如下</p>
<table>
<thead>
<tr>
<th>依赖查找类型</th>
<th>代表实现</th>
<th>是否安全</th>
</tr>
</thead>
<tbody>
<tr>
<td>单一类型查找</td>
<td>BeanFactory#getBean</td>
<td>否</td>
</tr>
<tr>
<td></td>
<td>ObjectFactory#getObject</td>
<td>否</td>
</tr>
<tr>
<td></td>
<td>ObjectProvider#getIfAvailable</td>
<td>是</td>
</tr>
<tr>
<td></td>
<td></td>
<td>是</td>
</tr>
<tr>
<td>集合类型查找</td>
<td>ListableBeanFactory#getBeansOfType</td>
<td>是</td>
</tr>
<tr>
<td></td>
<td>ObjectProvider#stream</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>注意：层次性依赖查找的安全性取决于其扩展的单一或集合类型的BeanFactory接口。</p>
<p>类型安全的依赖查找的相关示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型安全的依赖查找示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeSafetyDependencyLookupDemp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(TypeSafetyDependencyLookupDemp.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 演示BeanFactory#getBean方法的安全性</span></span><br><span class="line">        displayBeanFactoryGetBean(applicationContext);</span><br><span class="line">        <span class="comment">// 演示ObjectFactory#getObject方法的安全性</span></span><br><span class="line">        displayBeanFactoryGetObject(applicationContext);</span><br><span class="line">        <span class="comment">// 演示ObjectProvider#ifAvailable方法的安全性</span></span><br><span class="line">        displayObjectProviderIfAvailable(applicationContext);</span><br><span class="line">        <span class="comment">// 演示ListableBeanFactory#getBeansOfTYpe方法的安全性</span></span><br><span class="line">        displayListableBeanFactoryGetBeansType(applicationContext);</span><br><span class="line">        <span class="comment">// 演示ObjectProvider#stream方法的安全性</span></span><br><span class="line">        displayObjectProviderStreamOps(applicationContext);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayObjectProviderStreamOps</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        ObjectProvider&lt;User&gt; userObjectProvider = applicationContext.getBeanProvider(User.class);</span><br><span class="line">        printBeansException(<span class="string">&quot;displayObjectProviderStreamOps&quot;</span>, () -&gt; userObjectProvider.stream().forEach(System.out::println));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayListableBeanFactoryGetBeansType</span><span class="params">(ListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        printBeansException(<span class="string">&quot;displayListableBeanFactoryGetBeansType&quot;</span>,() -&gt; beanFactory.getBeanNamesForType(User.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayObjectProviderIfAvailable</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        ObjectProvider&lt;User&gt; objectProvider = applicationContext.getBeanProvider(User.class);</span><br><span class="line">        printBeansException(<span class="string">&quot;displayObjectProviderIfAvailable&quot;</span>, objectProvider::getIfAvailable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayBeanFactoryGetObject</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ObjectProvider is ObjectFactory</span></span><br><span class="line">        ObjectFactory&lt;User&gt; userObjectFactory = applicationContext.getBeanProvider(User.class);</span><br><span class="line">        printBeansException(<span class="string">&quot;displayBeanFactoryGetObject&quot;</span>, userObjectFactory::getObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayBeanFactoryGetBean</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        printBeansException(<span class="string">&quot;displayBeanFactoryGetBean&quot;</span>, () -&gt; beanFactory.getBean(User.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printBeansException</span><span class="params">(String source, Runnable runnable)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Source from: &quot;</span> + source);</span><br><span class="line">        System.err.println(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeansException exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内建可查找的依赖"><a class="markdownIt-Anchor" href="#内建可查找的依赖"></a> 内建可查找的依赖</h2>
<p>AbastractApplicationContext内建可查找的依赖：</p>
<table>
<thead>
<tr>
<th>Bean名称</th>
<th>Bena实例</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>environment</td>
<td>Environment对象</td>
<td>外部化配置以及Profiles</td>
</tr>
<tr>
<td>systemProperties</td>
<td>java.util.Properties对象</td>
<td>Java系统属性</td>
</tr>
<tr>
<td>systemEnvironment</td>
<td>java.util.Map对象</td>
<td>操作系统环境变量</td>
</tr>
<tr>
<td>messageSource</td>
<td>MessageSource对象</td>
<td>国际化文案</td>
</tr>
<tr>
<td>lifecycleProcessor</td>
<td>lifecycleProcessor对象</td>
<td>Lifecycle Bean处理器</td>
</tr>
<tr>
<td>applicationEventMulticaster</td>
<td>ApplicationEventMulticaster对象</td>
<td>Spring事件广播器</td>
</tr>
</tbody>
</table>
<p>注解驱动Spring应用上下文内建可查找的依赖（部分）：</p>
<table>
<thead>
<tr>
<th>Bean名称</th>
<th>Bean实例</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>org.springframework.context.event.internalConfigurationAnnotationProcessor</td>
<td>ConfigurationClassPostProcessor对象</td>
<td>处理Spring配置类</td>
</tr>
<tr>
<td>org.springframework.context.event.internalAutowiredAnnotationProcessor</td>
<td>AutowiredAnnotationBeanPostProcessor对象</td>
<td>处理@Autowired以及@Value注解</td>
</tr>
<tr>
<td>org.springframework.context.event.internalCommonAnnotationProcessor</td>
<td>CommonAnnotationBeanPostProcessor对象</td>
<td>（条件激活）处理JSR-250注解，如@PostConstruct等</td>
</tr>
<tr>
<td>org.springframework.context.event.internalEventListenerProcessor</td>
<td>EventListenerMethodProcessor对象</td>
<td>处理标注@EventListener的Spring事件监听方法</td>
</tr>
<tr>
<td>org.springframework.context.event.internalListenerFactory</td>
<td>DefaultEventListenerFactory对象</td>
<td>@EventListener事件监听方法适配为ApplicationListener</td>
</tr>
<tr>
<td>org.springframework.context.event.internalPersistenceAnnotationProcessor</td>
<td>PersistenceAnnotationProcessor对象</td>
<td>条件激活处理JPA注解场景</td>
</tr>
</tbody>
</table>
<p>这些内建的Bean的初始化都是在AnnotationConfigUtils中完成的。</p>
<h2 id="依赖查找中典型异常"><a class="markdownIt-Anchor" href="#依赖查找中典型异常"></a> 依赖查找中典型异常</h2>
<p>BeansException子类型</p>
<table>
<thead>
<tr>
<th>异常类型</th>
<th>触发条件（举例）</th>
<th>场景举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>NoSuchBeanDefinitionException</td>
<td>当查找Bean不存在于IoC容器时</td>
<td>BeanFactory#getBean<br />ObjectFactory#getObject</td>
</tr>
<tr>
<td>NoUniqueBeanDefinitionException</td>
<td>类型查找时，IoC容器存在多个Bean实例</td>
<td>BeanFactory#getBean(Class)</td>
</tr>
<tr>
<td>BeanInstantiationException</td>
<td>当Bean所对应的类型非具体类时</td>
<td>BeanFactory#getBean</td>
</tr>
<tr>
<td>BeanCreationException</td>
<td>当Bean初始化过程中</td>
<td>Bean初始化方法执行异常时</td>
</tr>
<tr>
<td>BeanDefinitionStoreException</td>
<td>当BeanDefinition配置元信息非法时</td>
<td>XML配置资源无法打开时</td>
</tr>
</tbody>
</table>
<p>NoUniqueBeanDefinitionException示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NoUniqueBeanDefinitionException示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoUniqueBeanDefinitionExceptionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(NoUniqueBeanDefinitionExceptionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            applicationContext.getBean(String.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoUniqueBeanDefinitionException e) &#123;</span><br><span class="line">            System.err.printf(<span class="string">&quot;Spring应用上下文存在%d 个 %s 类型的Bean,具体原因: %s%n&quot;</span>, e.getNumberOfBeansFound(),</span><br><span class="line">                    String.class.getName(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">bean1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bean1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">bean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bean2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">bean3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bean3&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BeanInstantiationException示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BeanInstantiationException示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInstantiationExceptionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 注册BeanDefinition</span></span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(CharSequence.class);</span><br><span class="line">        <span class="comment">// CharSequence是一个接口，所以实例化的时候会报错</span></span><br><span class="line">        applicationContext.registerBeanDefinition(<span class="string">&quot;errorBean&quot;</span>, beanDefinitionBuilder.getBeanDefinition());</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BeanCreationException示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BeanCreationException示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanCreationExceptionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 注册BeanDefinition</span></span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(POJO.class);</span><br><span class="line">        applicationContext.registerBeanDefinition(<span class="string">&quot;errorBean&quot;</span>, beanDefinitionBuilder.getBeanDefinition());</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">POJO</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Throwable(<span class="string">&quot;init(): For purposers...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;afterPropertiesSet(): For purposes...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-5"><a class="markdownIt-Anchor" href="#面试题-5"></a> 面试题</h2>
<h3 id="objectfactory与beanfactory的区别"><a class="markdownIt-Anchor" href="#objectfactory与beanfactory的区别"></a> ObjectFactory与BeanFactory的区别</h3>
<p>ObjectFactory与BeanFactory均提供依赖查找的能力，不过ObjectFactory仅关注一个或一种类型的Bean依赖查找，并且自身不具备依赖查找的能力，能力由BeanFactory输出。</p>
<p>BeanFactory则提供了单一类型、集合类型以及层次性等多种依赖查找方式。</p>
<h3 id="beanfactorygetbean操作是否线程安全"><a class="markdownIt-Anchor" href="#beanfactorygetbean操作是否线程安全"></a> BeanFactory.getBean操作是否线程安全？</h3>
<p>BeanFactory.getBean方法的执行是线程安全的，操作过程中会增加互斥锁。</p>
<h3 id="spring的依赖查找和依赖注入在来源上有什么区别"><a class="markdownIt-Anchor" href="#spring的依赖查找和依赖注入在来源上有什么区别"></a> Spring的依赖查找和依赖注入在来源上有什么区别？</h3>
<p>待定…</p>
<h1 id="依赖注入"><a class="markdownIt-Anchor" href="#依赖注入"></a> 依赖注入</h1>
<h2 id="依赖注入的模式和类型"><a class="markdownIt-Anchor" href="#依赖注入的模式和类型"></a> 依赖注入的模式和类型</h2>
<ol>
<li>手动模式-配置或者编程的方式，提前安排注入规则
<ul>
<li>XML资源配置元信息</li>
<li>Java注解配置元信息</li>
<li>API配置元信息</li>
</ul>
</li>
<li>自动模式-实现方提供依赖自动关联的方式，按照内建的注入规则
<ul>
<li>Autowring(自动绑定)</li>
</ul>
</li>
</ol>
<p>依赖注入类型：</p>
<table>
<thead>
<tr>
<th>依赖注入类型</th>
<th>配置元数据举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>Setter方法</td>
<td><proepty name="user" ref="userBean" /></td>
</tr>
<tr>
<td>构造器</td>
<td><constructor-arg name="user" ref="userBean" /></td>
</tr>
<tr>
<td>字段</td>
<td>@Autowired<br />User user;</td>
</tr>
<tr>
<td>方法</td>
<td>@Autowired<br />public void user(User user) {…}</td>
</tr>
<tr>
<td>接口回调</td>
<td>class MyBean implements BeanFactoryAware{…}</td>
</tr>
</tbody>
</table>
<h2 id="自动绑定"><a class="markdownIt-Anchor" href="#自动绑定"></a> 自动绑定</h2>
<p>Autowiring modes:</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>no</td>
<td>默认值，未激活Autowiring，需要手动指定依赖注入对象</td>
</tr>
<tr>
<td>byName</td>
<td>根据被注入属性的名称作为Bean名称进行依赖查找，并将对象设置到该属性</td>
</tr>
<tr>
<td>byType</td>
<td>根据被注入属性的类型作为依赖类型进行查找，并将对象设置到该属性</td>
</tr>
<tr>
<td>constructor</td>
<td>特殊byType类型，用于构造器参数</td>
</tr>
</tbody>
</table>
<p>可以参考：org.springframework.beans.factory.annotation.Autowire。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Autowire</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constant that indicates no autowiring at all.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NO(AutowireCapableBeanFactory.AUTOWIRE_NO),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constant that indicates autowiring bean properties by name.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	BY_NAME(AutowireCapableBeanFactory.AUTOWIRE_BY_NAME),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constant that indicates autowiring bean properties by type.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	BY_TYPE(AutowireCapableBeanFactory.AUTOWIRE_BY_TYPE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Autowire(<span class="keyword">int</span> value) &#123;</span><br><span class="line">		<span class="keyword">this</span>.value = value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return whether this represents an actual autowiring value.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether actual autowiring was specified</span></span><br><span class="line"><span class="comment">	 * (either BY_NAME or BY_TYPE)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAutowire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">this</span> == BY_NAME || <span class="keyword">this</span> == BY_TYPE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自动绑定的不足之处：</p>
<ol>
<li>构造器参数以及property上面的设置通常会覆盖掉Autowiring，也不能绑定一些简单的类型，比如String、Classes、properties</li>
<li>Autowiring无法把控注入的时候的精确性，会导致一些不确定的情况发生。</li>
<li>wiring很难在工具上产生一些文档或者相关提示。</li>
<li>如果应用上下文中存在多个Bean的定义，会发生歧义性，可能会抛出NoUniqueBeanDefinitionException。</li>
</ol>
<h2 id="setter注入"><a class="markdownIt-Anchor" href="#setter注入"></a> Setter注入</h2>
<p>Setter注入实现方法：</p>
<ol>
<li>手动模式：
<ul>
<li>XML资源配置元信息</li>
<li>Java注解配置元信息</li>
<li>API配置元信息</li>
</ul>
</li>
<li>自动模式
<ul>
<li>byName</li>
<li>byType</li>
</ul>
</li>
</ol>
<p>这里我们新建一个UserHolder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> User&#125; 的holder类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserHolder&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user=&quot;</span> + user +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过XML的方式注入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.dependcy.injection.UserHolder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;user&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过XML的方式注入演示的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于XML资源的依赖，Setter方法注入依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlDependencySetterInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/MTEA-INF/dependency-setter-injection.xml&quot;</span>;</span><br><span class="line">        <span class="comment">// 加载XML资源，解析并且生成BeanDefinition</span></span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        <span class="comment">//依赖查找并且创建Bean</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(UserHolder.class);</span><br><span class="line">        System.out.println(userHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>基于注解的依赖注入的演示示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于注解的Setter方法注入依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationDependencySetterInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(AnnotationDependencySetterInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line"></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/MTEA-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line"></span><br><span class="line">        UserHolder userHolder = applicationContext.getBean(UserHolder.class);</span><br><span class="line">        System.out.println(userHolder);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserHolder <span class="title">userHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        UserHolder userHolder = <span class="keyword">new</span> UserHolder();</span><br><span class="line">        userHolder.setUser(user);</span><br><span class="line">        <span class="keyword">return</span> userHolder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于Api的依赖注入的演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于API的Setter方法注入依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiDependencySetterInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        BeanDefinition userBeanDefinition = createUserBeanDefinition();</span><br><span class="line">        <span class="comment">// 注册UserHolder的BeanDefinition</span></span><br><span class="line">        applicationContext.registerBeanDefinition(<span class="string">&quot;UserHolder&quot;</span>,userBeanDefinition);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/MTEA-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line"></span><br><span class="line">        UserHolder userHolder = applicationContext.getBean(UserHolder.class);</span><br><span class="line">        System.out.println(userHolder);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为&#123;<span class="doctag">@link</span> UserHolder&#125; 生成&#123;<span class="doctag">@link</span> BeanDefinition&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title">createUserBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(UserHolder.class);</span><br><span class="line">        beanDefinitionBuilder.addPropertyReference(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;SuperUser&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自动配置的主要应用场景在XML文件当中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--这里可以通过byType或者byName进行注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.dependcy.injection.UserHolder&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--        &lt;property name=&quot;user&quot; ref=&quot;user&quot; /&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="构造器注入"><a class="markdownIt-Anchor" href="#构造器注入"></a> 构造器注入</h2>
<p>构造器注入的实现方法：</p>
<ol>
<li>手动模式
<ul>
<li>XML资源配置元信息</li>
<li>Java注解配置元信息</li>
<li>API配置元信息</li>
</ul>
</li>
<li>自动模式
<ul>
<li>constructor</li>
</ul>
</li>
</ol>
<p>XML资源配置的方式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.dependcy.injection.UserHolder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;SuperUser&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>XML资源配置方式的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于XML资源的依赖，构造器注入依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlDependencyConstructorInjectionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-constructor-injection.xml&quot;</span>;</span><br><span class="line">        <span class="comment">// 加载XML资源，解析并且生成BeanDefinition</span></span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        <span class="comment">//依赖查找并且创建Bean</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(UserHolder.class);</span><br><span class="line">        System.out.println(userHolder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java注解方式的核心部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserHolder <span class="title">userHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserHolder(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>API配置元信息的方式的核心部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为&#123;<span class="doctag">@link</span> UserHolder&#125; 生成&#123;<span class="doctag">@link</span> BeanDefinition&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title">createUserBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(UserHolder.class);</span><br><span class="line">    beanDefinitionBuilder.addConstructorArgReference(<span class="string">&quot;SuperUser&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造器自动绑定的示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.dependcy.injection.UserHolder&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;constructor&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="字段注入"><a class="markdownIt-Anchor" href="#字段注入"></a> 字段注入</h2>
<p>实现方法：</p>
<ol>
<li>手动模式
<ul>
<li>@Autowird</li>
<li>@Resource</li>
<li>@inject（可选）</li>
</ul>
</li>
</ol>
<p>字段注入的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于注解的字段注入依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationDependencyFiledInjectionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span></span><br><span class="line">    <span class="comment">//static @Autowired会忽略掉静态字段</span></span><br><span class="line">    UserHolder userHolder;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserHolder userHolder2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 配置Class也是 Spring Bean</span></span><br><span class="line">        applicationContext.register(AnnotationDependencyFiledInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line"></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line"></span><br><span class="line">        AnnotationDependencyFiledInjectionDemo demo = applicationContext.getBean(AnnotationDependencyFiledInjectionDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Autowired字段关联</span></span><br><span class="line">        UserHolder userHolder = demo.userHolder;</span><br><span class="line">        <span class="comment">// @Resource</span></span><br><span class="line">        UserHolder userHolder2 = demo.userHolder2;</span><br><span class="line">        System.out.println(userHolder);</span><br><span class="line">        System.out.println(userHolder2);</span><br><span class="line"></span><br><span class="line">        System.out.println(userHolder == userHolder2);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserHolder <span class="title">userHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserHolder(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方法注入"><a class="markdownIt-Anchor" href="#方法注入"></a> 方法注入</h2>
<ol>
<li>手动模式
<ul>
<li>@Autowird</li>
<li>@Resource</li>
<li>@inject（可选）</li>
<li>@Bean</li>
</ul>
</li>
</ol>
<p>方法注入的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> UserHolder userHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> UserHolder userHolder2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initUserHolder</span><span class="params">(UserHolder userHolder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userHolder = userHolder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initUserHolder2</span><span class="params">(UserHolder userHolder2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userHolder2 = userHolder2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserHolder <span class="title">userHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserHolder(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接口回调注入"><a class="markdownIt-Anchor" href="#接口回调注入"></a> 接口回调注入</h2>
<p>Aware系列接口回调</p>
<ol>
<li>
<p>自动模式</p>
<table>
<thead>
<tr>
<th>内建接口</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BeanFactoryAware</td>
<td>获取IoC容器-BeanFactory</td>
</tr>
<tr>
<td>ApplicationContextAware</td>
<td>获取Spring应用上下文-ApplicationConetxt对象</td>
</tr>
<tr>
<td>EnvironmentAware</td>
<td>获取Environment对象</td>
</tr>
<tr>
<td>ResourceLoaderAware</td>
<td>获取资源加载器对象-ResourceLoader</td>
</tr>
<tr>
<td>BeanClassLoaderAware</td>
<td>获取加载当前Bean Class的ClassLoader</td>
</tr>
<tr>
<td>BeanNameAware</td>
<td>获取当前Bean名称</td>
</tr>
<tr>
<td>MessageSourceAware</td>
<td>获取MessageSource对象，用于Spring国际化</td>
</tr>
<tr>
<td>ApplicationEventPublisherAware</td>
<td>获取ApplicationEventPublishAware对象，用于Spring事件</td>
</tr>
<tr>
<td>EmbeddedValueResolverAware</td>
<td>获取StringValueResolver对象，用占位符处理</td>
</tr>
</tbody>
</table>
<p>接口回调示例：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于&#123;<span class="doctag">@link</span> org.springframework.beans.factory.Aware&#125; 接口回调的示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AwareInterfaceDependencyInjectionDemo</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        AwareInterfaceDependencyInjectionDemo.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        AwareInterfaceDependencyInjectionDemo.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(AwareInterfaceDependencyInjectionDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        System.out.println(beanFactory == context.getBeanFactory());</span><br><span class="line">        System.out.println(applicationContext == context);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="依赖注入类型选择"><a class="markdownIt-Anchor" href="#依赖注入类型选择"></a> 依赖注入类型选择</h2>
<p>注入选型</p>
<ol>
<li>低依赖：构造器注入</li>
<li>多以来：Setter方法注入</li>
<li>便利性：字段注入</li>
<li>声明类：方法注入</li>
</ol>
<h2 id="基础类型注入"><a class="markdownIt-Anchor" href="#基础类型注入"></a> 基础类型注入</h2>
<p>基础类型</p>
<ol>
<li>原生类型（Primitive）：boolean、byte、char、short、int、float、long、double</li>
<li>标量类型（Scalar）：Number、Character、Boolean、Enum、Locale、Charset、Currency、Properties、UUID</li>
<li>常规类型（General）：Object、String、TimeZone、Calendar、Optional等</li>
<li>Spring类型：Resource、InputSource、Formatter等。</li>
</ol>
<h2 id="集合类型注入"><a class="markdownIt-Anchor" href="#集合类型注入"></a> 集合类型注入</h2>
<p>集合类型</p>
<ol>
<li>数组类型（Array）：原生类型、标量类型、常规类型、Spring类型</li>
<li>集合类型（Collection）
<ul>
<li>Collection：List、Set（SortedSet、NavigableSet、EnumSet）</li>
<li>Map：Properties</li>
</ul>
</li>
</ol>
<h2 id="限定注入"><a class="markdownIt-Anchor" href="#限定注入"></a> 限定注入</h2>
<ol>
<li>使用注解@Qualifier限定
<ul>
<li>通过Bean名称限定</li>
<li>通过分组限定</li>
</ul>
</li>
<li>基于注解@Qualifier扩展限定
<ul>
<li>自定义注解，如Spring Cloud @LoadBalanced</li>
</ul>
</li>
</ol>
<p>使用注解@Qualifer限定Bean的名称的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.annotation.Qualifier&#125; 使用示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QualifierAnnotationDependencyInjectionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// SuperUser -&gt; primary = true</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;user&quot;)</span> <span class="comment">// 指定Bean名称或者ID</span></span><br><span class="line">    <span class="keyword">private</span> User namedUser;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        QualifierAnnotationDependencyInjectionDemo demo = applicationContext.getBean(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.user = &quot;</span> + demo.user);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.namedUser = &quot;</span> + demo.namedUser);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以使用@Qulifier对注入的Bean可以进行逻辑上的分组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.annotation.Qualifier&#125; 使用示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QualifierAnnotationDependencyInjectionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// SuperUser -&gt; primary = true</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;user&quot;)</span> <span class="comment">// 指定Bean名称或者ID</span></span><br><span class="line">    <span class="keyword">private</span> User namedUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; allUsers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; qualifierUsers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Qualifier</span> <span class="comment">// 进行逻辑分组</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Qualifier</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        QualifierAnnotationDependencyInjectionDemo demo = applicationContext.getBean(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        <span class="comment">// 输出SuperUSer Bean</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.user = &quot;</span> + demo.user);</span><br><span class="line">        <span class="comment">// 输出 user Bean</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.namedUser = &quot;</span> + demo.namedUser);</span><br><span class="line">        <span class="comment">// 输出 SuperUSer、user,注意这里输出的不是所有的user对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.allUsers = &quot;</span> + demo.allUsers);</span><br><span class="line">        <span class="comment">// 输出 user1、user2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.qualifierUsers = &quot;</span> + demo.qualifierUsers);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过注解的定义我们可以看到@Qualifier注解还可以作用到注解上面，也就是说可以对这个注解进行一些自定义的扩展：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Qualifier &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们自定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserGroup &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用自定义注解来进行分组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.annotation.Qualifier&#125; 使用示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QualifierAnnotationDependencyInjectionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// SuperUser -&gt; primary = true</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;user&quot;)</span> <span class="comment">// 指定Bean名称或者ID</span></span><br><span class="line">    <span class="keyword">private</span> User namedUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; allUsers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; qualifierUsers;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@UserGroup</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;User&gt; groupedUsers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Qualifier</span> <span class="comment">// 进行逻辑分组</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Qualifier</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@UserGroup</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;9&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@UserGroup</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;10&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        QualifierAnnotationDependencyInjectionDemo demo = applicationContext.getBean(QualifierAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        <span class="comment">// 输出SuperUSer Bean</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.user = &quot;</span> + demo.user);</span><br><span class="line">        <span class="comment">// 输出 user Bean</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.namedUser = &quot;</span> + demo.namedUser);</span><br><span class="line">        <span class="comment">// 输出 SuperUSer、user,注意这里输出的不是所有的user对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.allUsers = &quot;</span> + demo.allUsers);</span><br><span class="line">        <span class="comment">// 输出 user1、user2、user3和user4,这个时候这个集合元素也增加了,这种方式了类似继承</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.qualifierUsers = &quot;</span> + demo.qualifierUsers);</span><br><span class="line">        <span class="comment">// 输出 user3和user4</span></span><br><span class="line">        System.out.println(<span class="string">&quot;demo.groupedUsers = &quot;</span> + demo.groupedUsers);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们来查看以下@LoadBalanced注解的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoadBalanced &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="延迟依赖注入"><a class="markdownIt-Anchor" href="#延迟依赖注入"></a> 延迟依赖注入</h2>
<ol>
<li>使用API ObjectFactory延迟注入
<ul>
<li>单一类型</li>
<li>集合类型</li>
</ul>
</li>
<li>使用API ObjectProvider延迟注入（推荐，这里主要是基于安全性的考量）
<ul>
<li>单一类型</li>
<li>集合类型</li>
</ul>
</li>
</ol>
<p>使用ObjectProvider延迟注入的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.ObjectProvider&#125; 实现延迟依赖注入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyAnnotationDependencyInjectionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> User user;  <span class="comment">// 实时注入</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectProvider&lt;User&gt; userObjectProvider; <span class="comment">//延迟注入</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectProvider&lt;Set&lt;User&gt;&gt; usersObjectFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(LazyAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        LazyAnnotationDependencyInjectionDemo demo = applicationContext.getBean(LazyAnnotationDependencyInjectionDemo.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.user = &quot;</span> + demo.user);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.userObjectProvider = &quot;</span> + demo.userObjectProvider);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.usersObjectFactory&quot;</span> + demo.usersObjectFactory);</span><br><span class="line">        demo.userObjectProvider.forEach(System.out::println);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖处理的过程"><a class="markdownIt-Anchor" href="#依赖处理的过程"></a> 依赖处理的过程</h2>
<p>基础知识：</p>
<ol>
<li>入口-DefaultListableBeanFactory#resolveDependency</li>
<li>依赖描述符-DependencyDescriptor</li>
<li>自定义绑定候选对象处理器-AutowireCandidateResolver</li>
</ol>
<p>首先观察以下依赖的描述类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencyDescriptor</span> <span class="keyword">extends</span> <span class="title">InjectionPoint</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 被注入的容器类</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; declaringClass;</span><br><span class="line">	<span class="comment">// 方法名称</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> String methodName;</span><br><span class="line">	<span class="comment">// 构造器参数</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt;[] parameterTypes;</span><br><span class="line">	<span class="comment">// 参数索引</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> parameterIndex;</span><br><span class="line">	<span class="comment">// 属性名称</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> String fieldName;</span><br><span class="line">	<span class="comment">// 是不是必须的</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> required;</span><br><span class="line">	<span class="comment">// 是不是饥饿的，@Lazy注解</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> eager;</span><br><span class="line">	<span class="comment">// 嵌入层次</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> nestingLevel = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 包含类</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; containingClass;</span><br><span class="line">	<span class="comment">// 泛型处理</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> ResolvableType resolvableType;</span><br><span class="line">	<span class="comment">// 类型描述</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> TypeDescriptor typeDescriptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先改造以下我们之前看到的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解驱动的依赖注入过程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationDependencyInjectionResolutionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> User user;  <span class="comment">// DependencyDescriptor -&gt;</span></span><br><span class="line">                        <span class="comment">// 必须（required=true）</span></span><br><span class="line">                        <span class="comment">// 实时注入（eager=true）</span></span><br><span class="line">                        <span class="comment">// 通过类型查找（User.class）</span></span><br><span class="line">                        <span class="comment">// 字段名称（“user”）</span></span><br><span class="line">                        <span class="comment">// 是否首要（primary=true）</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(AnnotationDependencyInjectionResolutionDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(applicationContext);</span><br><span class="line">        String xmlResourcePath = <span class="string">&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        beanDefinitionReader.loadBeanDefinitions(xmlResourcePath);</span><br><span class="line">        AnnotationDependencyInjectionResolutionDemo demo = applicationContext.getBean(AnnotationDependencyInjectionResolutionDemo.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;demo.user = &quot;</span> + demo.user);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在DefaultListableBeanFactory#resolveDependency处打个断点进行观察：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205345978.png" alt="image-20210624205345978" /></p>
<p>方法会继续往下执行到doResolveDependency方法：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205434583.png" alt="image-20210624205434583" /></p>
<p>集合注入和单个类型的注入略微有点差别，首先我们增加一个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>          <span class="comment">// 集合类型的依赖注入</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String,User&gt; users;  <span class="comment">// user SuperUser</span></span><br></pre></td></tr></table></figure>
<p>这个时候在返回的时候就会进行判断，判断返回的类型是什么，然后然后把结果放进去进行返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">resolveMultipleBeans</span><span class="params">(DependencyDescriptor descriptor, <span class="meta">@Nullable</span> String beanName,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="meta">@Nullable</span> TypeConverter typeConverter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; type = descriptor.getDependencyType();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (descriptor <span class="keyword">instanceof</span> StreamDependencyDescriptor) &#123;</span><br><span class="line">		Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">		<span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">			autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">		&#125;</span><br><span class="line">		Stream&lt;Object&gt; stream = matchingBeans.keySet().stream()</span><br><span class="line">				.map(name -&gt; descriptor.resolveCandidate(name, type, <span class="keyword">this</span>))</span><br><span class="line">				.filter(bean -&gt; !(bean <span class="keyword">instanceof</span> NullBean));</span><br><span class="line">		<span class="keyword">if</span> (((StreamDependencyDescriptor) descriptor).isOrdered()) &#123;</span><br><span class="line">			stream = stream.sorted(adaptOrderComparator(matchingBeans));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> stream;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (type.isArray()) &#123;</span><br><span class="line">		Class&lt;?&gt; componentType = type.getComponentType();</span><br><span class="line">		ResolvableType resolvableType = descriptor.getResolvableType();</span><br><span class="line">		Class&lt;?&gt; resolvedArrayType = resolvableType.resolve(type);</span><br><span class="line">		<span class="keyword">if</span> (resolvedArrayType != type) &#123;</span><br><span class="line">			componentType = resolvableType.getComponentType().resolve();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (componentType == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, componentType,</span><br><span class="line">				<span class="keyword">new</span> MultiElementDescriptor(descriptor));</span><br><span class="line">		<span class="keyword">if</span> (matchingBeans.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">			autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">		&#125;</span><br><span class="line">		TypeConverter converter = (typeConverter != <span class="keyword">null</span> ? typeConverter : getTypeConverter());</span><br><span class="line">		Object result = converter.convertIfNecessary(matchingBeans.values(), resolvedArrayType);</span><br><span class="line">		<span class="keyword">if</span> (result <span class="keyword">instanceof</span> Object[]) &#123;</span><br><span class="line">			Comparator&lt;Object&gt; comparator = adaptDependencyComparator(matchingBeans);</span><br><span class="line">			<span class="keyword">if</span> (comparator != <span class="keyword">null</span>) &#123;</span><br><span class="line">				Arrays.sort((Object[]) result, comparator);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (Collection.class.isAssignableFrom(type) &amp;&amp; type.isInterface()) &#123;</span><br><span class="line">		Class&lt;?&gt; elementType = descriptor.getResolvableType().asCollection().resolveGeneric();</span><br><span class="line">		<span class="keyword">if</span> (elementType == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, elementType,</span><br><span class="line">				<span class="keyword">new</span> MultiElementDescriptor(descriptor));</span><br><span class="line">		<span class="keyword">if</span> (matchingBeans.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">			autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">		&#125;</span><br><span class="line">		TypeConverter converter = (typeConverter != <span class="keyword">null</span> ? typeConverter : getTypeConverter());</span><br><span class="line">		Object result = converter.convertIfNecessary(matchingBeans.values(), type);</span><br><span class="line">		<span class="keyword">if</span> (result <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">			<span class="keyword">if</span> (((List&lt;?&gt;) result).size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				Comparator&lt;Object&gt; comparator = adaptDependencyComparator(matchingBeans);</span><br><span class="line">				<span class="keyword">if</span> (comparator != <span class="keyword">null</span>) &#123;</span><br><span class="line">					((List&lt;?&gt;) result).sort(comparator);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">       <span class="comment">// Map类型</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (Map.class == type) &#123;</span><br><span class="line">           <span class="comment">// 获取到users字段的Map的泛型信息</span></span><br><span class="line">		ResolvableType mapType = descriptor.getResolvableType().asMap();</span><br><span class="line">		Class&lt;?&gt; keyType = mapType.resolveGeneric(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (String.class != keyType) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Class&lt;?&gt; valueType = mapType.resolveGeneric(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (valueType == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, valueType,</span><br><span class="line">				<span class="keyword">new</span> MultiElementDescriptor(descriptor));</span><br><span class="line">		<span class="keyword">if</span> (matchingBeans.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">			autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> matchingBeans;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当进行集合类型的注入时，定义Bean的顺序也就是加载Bean的顺序，也是初始化Bean的时候的顺序。</p>
<p>在Java8之后，也可以注入Optional类型的字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> Optional&lt;User&gt; userOptional;</span><br></pre></td></tr></table></figure>
<p>当注入的类型时延迟查找时，实际上会返回一个代理对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="meta">@Lazy</span></span><br><span class="line">   <span class="keyword">private</span> User lazyUser;</span><br></pre></td></tr></table></figure>
<p>总的来说，依赖注入的处理主要就是由以下两个方法来完成的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveDependency</span><span class="params">(DependencyDescriptor descriptor, <span class="meta">@Nullable</span> String requestingBeanName,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">	descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());</span><br><span class="line">       <span class="comment">// 对于Optional类型的判断</span></span><br><span class="line">	<span class="keyword">if</span> (Optional.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">		<span class="keyword">return</span> createOptionalDependency(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (ObjectFactory.class == descriptor.getDependencyType() ||</span><br><span class="line">			ObjectProvider.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DependencyObjectProvider(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Jsr330Factory().createDependencyProvider(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(</span><br><span class="line">				descriptor, requestingBeanName);</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">			result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doResolveDependency</span><span class="params">(DependencyDescriptor descriptor, <span class="meta">@Nullable</span> String beanName,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">	InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Object shortcut = descriptor.resolveShortcut(<span class="keyword">this</span>);</span><br><span class="line">		<span class="keyword">if</span> (shortcut != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> shortcut;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt; type = descriptor.getDependencyType();</span><br><span class="line">		Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">				String strVal = resolveEmbeddedValue((String) value);</span><br><span class="line">				BeanDefinition bd = (beanName != <span class="keyword">null</span> &amp;&amp; containsBean(beanName) ?</span><br><span class="line">						getMergedBeanDefinition(beanName) : <span class="keyword">null</span>);</span><br><span class="line">				value = evaluateBeanDefinitionString(strVal, bd);</span><br><span class="line">			&#125;</span><br><span class="line">			TypeConverter converter = (typeConverter != <span class="keyword">null</span> ? typeConverter : getTypeConverter());</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (UnsupportedOperationException ex) &#123;</span><br><span class="line">				<span class="comment">// A custom TypeConverter which does not support TypeDescriptor resolution...</span></span><br><span class="line">				<span class="keyword">return</span> (descriptor.getField() != <span class="keyword">null</span> ?</span><br><span class="line">						converter.convertIfNecessary(value, type, descriptor.getField()) :</span><br><span class="line">						converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">		<span class="keyword">if</span> (multipleBeans != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> multipleBeans;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">		<span class="keyword">if</span> (matchingBeans.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isRequired(descriptor)) &#123;</span><br><span class="line">				raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String autowiredBeanName;</span><br><span class="line">		Object instanceCandidate;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (matchingBeans.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);</span><br><span class="line">			<span class="keyword">if</span> (autowiredBeanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;</span><br><span class="line">					<span class="keyword">return</span> descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// In case of an optional Collection/Map, silently ignore a non-unique case:</span></span><br><span class="line">					<span class="comment">// possibly it was meant to be an empty collection of multiple regular beans</span></span><br><span class="line">					<span class="comment">// (before 4.3 in particular when we didn&#x27;t even look for collection beans).</span></span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			instanceCandidate = matchingBeans.get(autowiredBeanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// We have exactly one match.</span></span><br><span class="line">			Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();</span><br><span class="line">			autowiredBeanName = entry.getKey();</span><br><span class="line">			instanceCandidate = entry.getValue();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">			autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (instanceCandidate <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">			instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, <span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object result = instanceCandidate;</span><br><span class="line">		<span class="keyword">if</span> (result <span class="keyword">instanceof</span> NullBean) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isRequired(descriptor)) &#123;</span><br><span class="line">				raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">			&#125;</span><br><span class="line">			result = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!ClassUtils.isAssignableValue(type, result)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="autowird注入"><a class="markdownIt-Anchor" href="#autowird注入"></a> @Autowird注入</h2>
<p>@Autowired注入总体过程：</p>
<ol>
<li>元信息解析</li>
<li>依赖查找</li>
<li>依赖注入（字段、方法）</li>
</ol>
<p>核心处理方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, <span class="meta">@Nullable</span> String beanName, <span class="meta">@Nullable</span> PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">             <span class="comment">// 标注了@Autowired注解的字段</span></span><br><span class="line">			Field field = (Field) <span class="keyword">this</span>.member;</span><br><span class="line">			Object value;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.cached) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					value = resolvedCachedArgument(beanName, <span class="keyword">this</span>.cachedFieldValue);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">					<span class="comment">// Unexpected removal of target bean for cached argument -&gt; re-resolve</span></span><br><span class="line">					value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="comment">// 有可能时非public字段</span></span><br><span class="line">				ReflectionUtils.makeAccessible(field);</span><br><span class="line">                 <span class="comment">// 最终通过反射的方式将依赖注入的对象设置到属性上</span></span><br><span class="line">				field.set(bean, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>在XML中配置信息解析的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">	InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		metadata.inject(bean, beanName, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pvs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法会在set方法执行之前就执行，并且这个时候还没有进行类型转换。当这个类有父类的时候，会进行属性合并的操作，并且是在postProcessProperties之前执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessMergedBeanDefinition</span><span class="params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;</span><br><span class="line">		InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, <span class="keyword">null</span>);</span><br><span class="line">		metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>一直会找到所有父类中的属性的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> MergedAnnotation&lt;?&gt; findAutowiredAnnotation(AccessibleObject ao) &#123;</span><br><span class="line">	MergedAnnotations annotations = MergedAnnotations.from(ao);</span><br><span class="line">	<span class="keyword">for</span> (Class&lt;? extends Annotation&gt; type : <span class="keyword">this</span>.autowiredAnnotationTypes) &#123;</span><br><span class="line">		MergedAnnotation&lt;?&gt; annotation = annotations.get(type);</span><br><span class="line">		<span class="keyword">if</span> (annotation.isPresent()) &#123;</span><br><span class="line">			<span class="keyword">return</span> annotation;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用上述方法的地方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class="line">			MergedAnnotation&lt;?&gt; ann = findAutowiredAnnotation(field);</span><br><span class="line">			<span class="keyword">if</span> (ann != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="comment">// 可以看到就是在这里排除掉了static的字段</span></span><br><span class="line">				<span class="keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">						logger.info(<span class="string">&quot;Autowired annotation is not supported on static fields: &quot;</span> + field);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">boolean</span> required = determineRequiredStatus(ann);</span><br><span class="line">				currElements.add(<span class="keyword">new</span> AutowiredFieldElement(field, required));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看到在postProcessMergedBeanDefinition就完成了Bean的元信息的组装，并且在postProcessProperties执行的时候会包含调用DefaultListableBeanFactory#resolveDependency方法的过程。</p>
<h2 id="inject和autowired联系"><a class="markdownIt-Anchor" href="#inject和autowired联系"></a> @Inject和@Autowired联系</h2>
<p>@Inject注入过程</p>
<ul>
<li>如果JSR-330存在于ClassPath中，就直接复用AutowiredAnnotationBeanPostProcessor的实现。</li>
</ul>
<p>在源代码中可以看到相关的逻辑：</p>
<p>这里首先要关注一个属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; autowiredAnnotationTypes = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>可以看到autowiredAnnotationTypes实际上是一个有序的Set集合，接下来是具体处理的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AutowiredAnnotationBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 依次插入Autowired、Value、inject</span></span><br><span class="line">	<span class="keyword">this</span>.autowiredAnnotationTypes.add(Autowired.class);</span><br><span class="line">	<span class="keyword">this</span>.autowiredAnnotationTypes.add(Value.class);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.autowiredAnnotationTypes.add((Class&lt;? extends Annotation&gt;)</span><br><span class="line">				ClassUtils.forName(<span class="string">&quot;javax.inject.Inject&quot;</span>, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));</span><br><span class="line">		logger.trace(<span class="string">&quot;JSR-330 &#x27;javax.inject.Inject&#x27; annotation found and supported for autowiring&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">		<span class="comment">// JSR-330 API not available - simply skip.</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到实际上还可以进行复合注解，并且在处理的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> MergedAnnotation&lt;?&gt; findAutowiredAnnotation(AccessibleObject ao) &#123;</span><br><span class="line">	MergedAnnotations annotations = MergedAnnotations.from(ao);</span><br><span class="line">	<span class="keyword">for</span> (Class&lt;? extends Annotation&gt; type : <span class="keyword">this</span>.autowiredAnnotationTypes) &#123;</span><br><span class="line">		MergedAnnotation&lt;?&gt; annotation = annotations.get(type);</span><br><span class="line">		<span class="keyword">if</span> (annotation.isPresent()) &#123;</span><br><span class="line">			<span class="keyword">return</span> annotation;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，如果要使用@Inject注解，就需要引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.inject<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.inject<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以发现@Inject和@Autowired注解在处理的上完全一样的，都是使用AutowiredAnnotationBeanPostProcessor来处理依赖注入的过程。</p>
<h2 id="java通用注解原理"><a class="markdownIt-Anchor" href="#java通用注解原理"></a> Java通用注解原理</h2>
<p>CommonAnnotationBeanPostProcessor</p>
<ol>
<li>注入注解
<ul>
<li>javax.xml.ws.WebServiceRef</li>
<li>javax.ejb.EJB</li>
<li>javax.annotation.Resource</li>
</ul>
</li>
<li>生命周期注解
<ul>
<li>javax.annotation.PostConstruct</li>
<li>javax.annotation.PreDestory</li>
</ul>
</li>
</ol>
<p>CommonAnnotationBeanPostProcessor和AutowiredAnnotationBeanPostProcessor大概的实现逻辑是如出一辙的，只是在细微的地方略有差别。</p>
<p>CommonAnnotationBeanPostProcessor实现了InitDestroyAnnotationBeanPostProcessor接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonAnnotationBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">InitDestroyAnnotationBeanPostProcessor</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span>, <span class="title">BeanFactoryAware</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>在InitDestroyAnnotationBeanPostProcessor中也可以看到postProcessMergedBeanDefinition这个方法：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205533354.png" alt="image-20210624205533354" /></p>
<p>这里只是元信息不太一样，这主要是LifecycleMetadata中包含了初始化和销毁两个阶段。</p>
<p>同样CommonAnnotationBeanPostProcessor也有postProcessProperties的方法：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205605481.png" alt="image-20210624205605481" /></p>
<p>对于生命周期的注解的处理，可以从构造方法中看出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommonAnnotationBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// 优先级是倒数第四位的</span></span><br><span class="line">		setOrder(Ordered.LOWEST_PRECEDENCE - <span class="number">3</span>);</span><br><span class="line">		setInitAnnotationType(PostConstruct.class);</span><br><span class="line">		setDestroyAnnotationType(PreDestroy.class);</span><br><span class="line">		ignoreResourceType(<span class="string">&quot;javax.xml.ws.WebServiceContext&quot;</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>CommonAnnotationBeanPostProcessor会在AutowiredAnnotationBeanPostProcessor之前进行处理，这一点，可以通过实现的PriorityOrdered接口，看到属性中定义的顺序来进行确认。</p>
<h2 id="自定义依赖注入注解"><a class="markdownIt-Anchor" href="#自定义依赖注入注解"></a> 自定义依赖注入注解</h2>
<ol>
<li>基于AutowiredAnnotationBeanPostProcessor实现</li>
<li>自定义实现
<ul>
<li>生命周期处理
<ul>
<li>InstantiationAwareBeanPostProcessor</li>
<li>MergedBeanDefinitionPostProcessor</li>
</ul>
</li>
<li>元数据
<ul>
<li>InjectedElement</li>
<li>InjectionMetadata</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>基于AutowiredAnnotationBeanPostProcessor实现自定义依赖注入相对比较容易，如果使用自定义实现，就比较麻烦。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAutowired &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们不对@Autowired做任何的扩展，仅仅使用它进行元标注，定义完成之后使用MyAutowired进行注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyAutowired</span></span><br><span class="line">  <span class="keyword">private</span> Optional&lt;User&gt; userOptional;</span><br></pre></td></tr></table></figure>
<p>发现依然可以正常地工作，接下来我们自定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义依赖注入注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> InjectedUser &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将我们自定义的注解类型添加到AutowiredAnnotationBeanPostProcessor中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Bean(name = AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)</span> <span class="comment">//注意这里是static方法，会提前初始化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutowiredAnnotationBeanPostProcessor <span class="title">beanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AutowiredAnnotationBeanPostProcessor beanPostProcessor = <span class="keyword">new</span> AutowiredAnnotationBeanPostProcessor();</span><br><span class="line">        <span class="comment">// 替换原有注解处理，使用新注解@InjectedUser，原来的注解会失效</span></span><br><span class="line"><span class="comment">//        beanPostProcessor.setAutowiredAnnotationType(InjectedUser.class);</span></span><br><span class="line">        <span class="comment">// 保留原来的方式，添加新的注解，@Autowired + @InjectedUser</span></span><br><span class="line">        Set&lt;Class&lt;? extends Annotation&gt;&gt; autowiredAnnotationTypes = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(Autowired.class, Inject.class, InjectedUser.class));</span><br><span class="line">        beanPostProcessor.setAutowiredAnnotationTypes(autowiredAnnotationTypes);</span><br><span class="line">        <span class="keyword">return</span> beanPostProcessor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>测试我们的注解是否生效：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectedUser</span></span><br><span class="line">  <span class="keyword">private</span> User myInjectedUser;</span><br></pre></td></tr></table></figure>
<p>答案是肯定的。如何实现新老注解的兼容的注入方法呢？</p>
<p>首先注入一个AutowiredAnnotationBeanPostProcessor，并设置我们自定义的注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@Order(Ordered.LOWEST_PRECEDENCE - 3)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutowiredAnnotationBeanPostProcessor <span class="title">beanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       AutowiredAnnotationBeanPostProcessor beanPostProcessor = <span class="keyword">new</span> AutowiredAnnotationBeanPostProcessor();</span><br><span class="line">       beanPostProcessor.setAutowiredAnnotationType(InjectedUser.class);</span><br><span class="line">       <span class="keyword">return</span> beanPostProcessor;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>​	在AnnotationConfigUtils#registerAnnotationConfigProcessors中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">			RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">			def.setSource(source);</span><br><span class="line">			beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到如果AutowiredAnnotationBeanPostProcessor这个Bean存在的话，就不注册，不存在的会注册一个默认的，因为我们这里注入AutowiredAnnotationBeanPostProcessor采用的static，就会首先使用我们注册的AutowiredAnnotationBeanPostProcessor来进行依赖注入，这时候，在应用上下文中有两个AutowiredAnnotationBeanPostProcessor来进行处理。</p>
<h2 id="面试题-6"><a class="markdownIt-Anchor" href="#面试题-6"></a> 面试题</h2>
<h3 id="有多少种依赖注入的方式"><a class="markdownIt-Anchor" href="#有多少种依赖注入的方式"></a> 有多少种依赖注入的方式</h3>
<p>构造器注入、Setter注入、字段注入、方法注入、接口回调注入</p>
<h3 id="你偏好构造器注入还是setter注入"><a class="markdownIt-Anchor" href="#你偏好构造器注入还是setter注入"></a> 你偏好构造器注入还是Setter注入?</h3>
<p>两种依赖注入的方式均可以使用，如果是必须依赖的话，那么推荐使用构造器注入，Setter注入用于可选依赖。</p>
<h3 id="spring依赖注入的来源有哪些"><a class="markdownIt-Anchor" href="#spring依赖注入的来源有哪些"></a> Spring依赖注入的来源有哪些？</h3>
<p>待续…</p>
<h1 id="spring-ioc依赖来源"><a class="markdownIt-Anchor" href="#spring-ioc依赖来源"></a> Spring IoC依赖来源</h1>
<h2 id="依赖查找的来源"><a class="markdownIt-Anchor" href="#依赖查找的来源"></a> 依赖查找的来源</h2>
<p>查找来源：</p>
<table>
<thead>
<tr>
<th>来源</th>
<th>配置元数据</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spring BeanDefinition</td>
<td><code>&lt;bean id=&quot;user&quot; class=&quot;org...User&quot;&gt;</code></td>
</tr>
<tr>
<td></td>
<td>@Bean<br />public User user(){…}</td>
</tr>
<tr>
<td></td>
<td>BeanDefinitionBuilder</td>
</tr>
<tr>
<td>单例对象</td>
<td>API实现</td>
</tr>
</tbody>
</table>
<h2 id="依赖注入的来源"><a class="markdownIt-Anchor" href="#依赖注入的来源"></a> 依赖注入的来源</h2>
<p>注入来源：</p>
<table>
<thead>
<tr>
<th>来源</th>
<th>配置元数据</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spring BeanDefinition</td>
<td><code>&lt;bean id=&quot;user&quot; class=&quot;org...User&quot;&gt;</code></td>
</tr>
<tr>
<td></td>
<td>@Bean<br />public User user(){…}</td>
</tr>
<tr>
<td></td>
<td>BeanDefinitionBuilder</td>
</tr>
<tr>
<td>单例对象</td>
<td>API实现</td>
</tr>
<tr>
<td>非Spring容器管理对象（游离对象）</td>
<td></td>
</tr>
</tbody>
</table>
<p>AbstractApplicationContext#refresh()方法会调用prepareBeanFactory(beanFactory)方法，这个方法中会注入一些Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line"><span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line">beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line"><span class="comment">// 注意接下来的都是当前ApplicationContext对象</span></span><br><span class="line">beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>实际上，注入了四个类型，两个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 依赖来源示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencySourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注入在postProcessProperties方法执行，早于setter注入，也早于PostConstruct</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beanFactory == applicationContext: &quot;</span> + (beanFactory == applicationContext));</span><br><span class="line">        System.out.println(<span class="string">&quot;beanFactory == applicationContext.getBeanFactory: &quot;</span> + (beanFactory == applicationContext.getAutowireCapableBeanFactory()));</span><br><span class="line">        System.out.println(<span class="string">&quot;resourceLoader == applicationContext: &quot;</span> + (resourceLoader == applicationContext));</span><br><span class="line">        System.out.println(<span class="string">&quot;applicationEventMulticaster == applicationContext: &quot;</span> + (applicationEventPublisher == applicationContext));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initByLookup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getBean(BeanFactory.class);</span><br><span class="line">        getBean(ResourceLoader.class);</span><br><span class="line">        getBean(ApplicationContext.class);</span><br><span class="line">        getBean(ApplicationEventPublisher.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; beanType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> beanFactory.getBean(beanType);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchBeanDefinitionException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;当前类型&quot;</span> + beanType.getName() + <span class="string">&quot;无法在BeanFactory中查找&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(DependencySourceDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line"></span><br><span class="line">        DependencySourceDemo demo = applicationContext.getBean(DependencySourceDemo.class);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring容器管理和游离对象"><a class="markdownIt-Anchor" href="#spring容器管理和游离对象"></a> Spring容器管理和游离对象</h2>
<p>依赖对象：</p>
<table>
<thead>
<tr>
<th>来源</th>
<th>Spring Bean对象</th>
<th>生命周期管理</th>
<th>配置元信息</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spring BeanDefinition</td>
<td>是</td>
<td>是</td>
<td>有</td>
<td>依赖查找、依赖注入</td>
</tr>
<tr>
<td>单体对象</td>
<td>是</td>
<td>否</td>
<td>无</td>
<td>依赖查找、依赖注入</td>
</tr>
<tr>
<td>Resolvable Dependency</td>
<td>否</td>
<td>否</td>
<td>无</td>
<td>依赖注入</td>
</tr>
</tbody>
</table>
<h2 id="spring-beandefinition作为依赖来源"><a class="markdownIt-Anchor" href="#spring-beandefinition作为依赖来源"></a> Spring BeanDefinition作为依赖来源</h2>
<p>要素：</p>
<ol>
<li>元数据：BeanDefinition</li>
<li>注册：BeanDefinitionRegistry#registerBeanDefinition</li>
<li>类型：延迟和非延迟</li>
<li>顺序：Bean生命周期顺序按照注册顺序</li>
</ol>
<p>BeanDefinitionRegistry有且仅有一个实现，就是DefaultListableBeanFactory，首先有这样两个属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map of bean definition objects, keyed by bean name</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"><span class="comment">// List of bean definition names, in registration order.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;String&gt; beanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure>
<p>在registerBeanDefinition方法中会这样保存数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line"><span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br></pre></td></tr></table></figure>
<p>可以看到这里除了保存beanName和beanDefinition，还单独保存了beanName，这样做的原因就是ConcurrentHashMap是无序的，而ArrayList是有序的，后面在初始化的时候，会根据这个List里面的Bean的名称，按照次序依次进行初始化操作。</p>
<h2 id="单体对象作为依赖来源"><a class="markdownIt-Anchor" href="#单体对象作为依赖来源"></a> 单体对象作为依赖来源</h2>
<p>要素：</p>
<ol>
<li>来源：外部普通Java对象（不一定是POJO）</li>
<li>注册：SingletonBeanRegistry#registerSinleton</li>
</ol>
<p>限制：</p>
<ol>
<li>无生命周期管理</li>
<li>无法实现延迟初始化Bean</li>
</ol>
<h2 id="resolvable-dependency作为依赖来源"><a class="markdownIt-Anchor" href="#resolvable-dependency作为依赖来源"></a> Resolvable Dependency作为依赖来源</h2>
<p>要素：</p>
<ul>
<li>注册：ConfigurableListableBeanFactory#registerResolvableDependency</li>
</ul>
<p>限制：</p>
<ol>
<li>无生命周期管理</li>
<li>无法延迟初始化Bean</li>
<li>无法通过依赖查找</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ResolvableDependency作为依赖来源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolvableDependencySourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(ResolvableDependencySourceDemo.class);</span><br><span class="line">        <span class="comment">// 只能用于类型方面的依赖注入</span></span><br><span class="line">        applicationContext.addBeanFactoryPostProcessor(beanFactory -&gt; &#123;</span><br><span class="line">            beanFactory.registerResolvableDependency(String.class,<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="外部化配置作为依赖来源"><a class="markdownIt-Anchor" href="#外部化配置作为依赖来源"></a> 外部化配置作为依赖来源</h2>
<p>要素：</p>
<ul>
<li>类型：非常规Spring对象依赖来源</li>
</ul>
<p>限制：</p>
<ol>
<li>无生命周期管理</li>
<li>无法实现延迟初始化Bean</li>
<li>无法通过依赖查找</li>
</ol>
<p>外部化配置的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 外部化配置作为依赖来源示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;META-INF/default.properties&quot;,encoding = &quot;GBK&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExternalConfigurationDependencySourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.resource&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource resource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是中文，这里会显示操作系统登录的用户名，而不是在配置文件中配置的信息。这是因为user.name是一个系统属性。</span></span><br><span class="line"><span class="comment">//    @Value(&quot;$&#123;user.name&#125;&quot;)</span></span><br><span class="line"><span class="comment">//    private String name;</span></span><br><span class="line">    <span class="comment">// 直接输出会显示乱码,需要设置编码</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;usr.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(ExternalConfigurationDependencySourceDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        ExternalConfigurationDependencySourceDemo demo = applicationContext.getBean(ExternalConfigurationDependencySourceDemo.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;id: &quot;</span> + demo.id);</span><br><span class="line">        System.out.println(<span class="string">&quot;resource: &quot;</span> + demo.resource);</span><br><span class="line">        System.out.println(<span class="string">&quot;name: &quot;</span> + demo.name);</span><br><span class="line"></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现原理就是DefaultListableBeanFactory#doResolveDependency中：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205723539.png" alt="image-20210624205723539" /></p>
<p>会通过接下来的方法进行替换，将属性替换为配置文件中的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String strVal = resolveEmbeddedValue((String) value);</span><br></pre></td></tr></table></figure>
<h2 id="面试题-7"><a class="markdownIt-Anchor" href="#面试题-7"></a> 面试题</h2>
<h3 id="依赖注入和依赖查找的依赖来源是否相同"><a class="markdownIt-Anchor" href="#依赖注入和依赖查找的依赖来源是否相同"></a> 依赖注入和依赖查找的依赖来源是否相同？</h3>
<p>否，依赖查找的来源仅限于Spring BeanDefinition以及单例对象，而依赖注入的来源还包括了Resolvable Dependency以及@Value所标注的外部化配置。</p>
<h3 id="单例对象能在ioc容器启动后注册吗"><a class="markdownIt-Anchor" href="#单例对象能在ioc容器启动后注册吗"></a> 单例对象能在IoC容器启动后注册吗？</h3>
<p>可以的，单例对象注册与BeanDefinition不同，BeanDefinition会被ConfigurableListableBeanFactory#freezeConfiguration()方法影响，从而冻结注册，单例对象则没有这个限制。</p>
<h3 id="spring依赖注入的来源有哪些-2"><a class="markdownIt-Anchor" href="#spring依赖注入的来源有哪些-2"></a> Spring依赖注入的来源有哪些？</h3>
<p>Spring BeanDefinition、单例对象、Resolvable Dependency、@Value外部化配置</p>
<h1 id="spring-bean作用域"><a class="markdownIt-Anchor" href="#spring-bean作用域"></a> Spring Bean作用域</h1>
<h2 id="作用域简介"><a class="markdownIt-Anchor" href="#作用域简介"></a> 作用域简介</h2>
<table>
<thead>
<tr>
<th>来源</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>singleton</td>
<td>默认Spring Bean作用域，一个BeanFactory有且仅有一个实例</td>
</tr>
<tr>
<td>prototype</td>
<td>原型作用域，每次依赖查找和依赖注入生成新Bean对象</td>
</tr>
<tr>
<td>request</td>
<td>将Spring Bean存储在ServletRequest上下文中</td>
</tr>
<tr>
<td>session</td>
<td>将Spring Bean存储在HttpSession中</td>
</tr>
<tr>
<td>application</td>
<td>将Spring Bean存储在ServletContext中</td>
</tr>
</tbody>
</table>
<p>笼统而言，我们只要记住单例和原型两种即可，其余三种主要是为了服务端模板引擎渲染，包括JSP、Velocity、FreeMarker。</p>
<h2 id="singleton作用域"><a class="markdownIt-Anchor" href="#singleton作用域"></a> singleton作用域</h2>
<p>单例模式是在一定范围内是全局共享的，但是这个范围是有限的。通过观察BeanDefinition源代码可以发现，其实只有singleton和prototype这两个作用域相关的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否是单例</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 是否是原型</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPrototype</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>单例模式的示例图：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205747975.png" alt="image-20210624205747975" /></p>
<p>这里有一个误区就是，singleton和prototype并没有互斥的关系，是可以同时存在的，当然，如果同时存在的话，可能行为会有一些问题。</p>
<h2 id="prototype作用域"><a class="markdownIt-Anchor" href="#prototype作用域"></a> prototype作用域</h2>
<p>多例模式的示意图：</p>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210624205818521.png" alt="image-20210624205818521" /></p>
<p>多例和单例比较的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bean的作用域示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanScopeDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 默认的scop就是“singleton”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">singletonUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">prototypeUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> User <span class="title">createUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(String.valueOf(System.nanoTime()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;singletonUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User singletonUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;singletonUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User singletonUser1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,User&gt; users;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scopedBeansByInjection</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        BeanScopeDemo beanScopeDemo = applicationContext.getBean(BeanScopeDemo.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.singletonUser = &quot;</span> + beanScopeDemo.singletonUser);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.singletonUser1 = &quot;</span> + beanScopeDemo.singletonUser1);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.prototypeUser1 = &quot;</span> + beanScopeDemo.prototypeUser);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.prototypeUser2 = &quot;</span> + beanScopeDemo.prototypeUser1);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.prototypeUser3 = &quot;</span> + beanScopeDemo.prototypeUser2);</span><br><span class="line">        System.out.println(<span class="string">&quot;beanScopeDemo.users = &quot;</span> + beanScopeDemo.users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scopedBeansByLookup</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            User singletonUser = applicationContext.getBean(<span class="string">&quot;singletonUser&quot;</span>, User.class);</span><br><span class="line">            <span class="comment">// singletonUser是共享的Bean对象</span></span><br><span class="line">            System.out.println(<span class="string">&quot;singletonUser = &quot;</span> + singletonUser.getId());</span><br><span class="line">            <span class="comment">// prototypeUser是每次依赖查找都会生成新的Bean对象</span></span><br><span class="line">            User prototypeUser = applicationContext.getBean(<span class="string">&quot;prototypeUser&quot;</span>, User.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;prototypeUser = &quot;</span> + prototypeUser.getId());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(BeanScopeDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 结论一：</span></span><br><span class="line">        <span class="comment">// singleton Bean无论依赖查找还是依赖注入均为同一个对象</span></span><br><span class="line">        <span class="comment">// prototype Bean无论依赖查找还是依赖注入均为新生成的对象</span></span><br><span class="line">        <span class="comment">// 结论二：</span></span><br><span class="line">        <span class="comment">// 如果依赖注入集合类型的对象，singleton Bean和prototype Bean均会存在一个</span></span><br><span class="line">        <span class="comment">// prototype Bean有别于其他地方的依赖注入</span></span><br><span class="line">        scopedBeansByLookup(applicationContext);</span><br><span class="line">        scopedBeansByInjection(applicationContext);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意事项：</p>
<p>Spring容器没有办法管理prototype Bean的完整生命周期，也没有办法记录实例的存在。销毁回调方法将不会执行，可以利用BeanPostProcess进行清扫工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">createUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">&quot;createUser&quot;</span>);</span><br><span class="line">        user.setId(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User Bean [&quot;</span> + beanName + <span class="string">&quot;]初始化...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User Bean [&quot;</span> + beanName + <span class="string">&quot;]销毁化...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanName = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行刚才的例子不难看出，初始化的方法每次还是会被调用，但是销毁方法只有单例的Bean才会调用，那么如何销毁prototype的Bean呢？一种做法就是前面提到的BeanPostProcess：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.addBeanFactoryPostProcessor(beanFactory -&gt; &#123;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessor() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s Bean名称: %s 在初始化后回调...%n&quot;</span>, bean.getClass().getName(), beanName);</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在这个方法里面可以执行一些销毁的逻辑，但是使用这种方式，可能会有一些意想不到的结果，因为创建好的prototype的Bean通常而言都是马上要使用的，而不需要在它上面增加一些额外的操作，更为推荐的方式，是在维护prototype的Bean的类中，利用它的生命周期方法，对于所管理的prototype类型的类进行销毁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanScopeDemo</span> <span class="keyword">implements</span> <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 默认的scop就是“singleton”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">singletonUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">prototypeUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> User <span class="title">createUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(String.valueOf(System.nanoTime()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;singletonUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User singletonUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;singletonUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User singletonUser1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;prototypeUser&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User prototypeUser2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, User&gt; users;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(BeanScopeDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前BeanScopeDemo Bean 正在销毁中&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.prototypeUser.destory();</span><br><span class="line">        <span class="keyword">this</span>.prototypeUser1.destory();</span><br><span class="line">        <span class="keyword">this</span>.prototypeUser2.destory();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, User&gt; entry : <span class="keyword">this</span>.users.entrySet()) &#123;</span><br><span class="line">            String beanName = entry.getKey();</span><br><span class="line">            BeanDefinition beanDefinition = beanFactory.getBeanDefinition(beanName);</span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.isPrototype()) &#123;</span><br><span class="line">                User user = entry.getValue();</span><br><span class="line">                user.destory();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前BeanScopeDemo Bean 销毁已完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="request作用域"><a class="markdownIt-Anchor" href="#request作用域"></a> request作用域</h2>
<ol>
<li>配置
<ul>
<li>XML - <code>&lt;bean class=&quot;...&quot; scope=&quot;request&quot;&gt;</code></li>
<li>Java注解 - @RequestScope或@Scope（WebApplicationContext.SCOPE_REQUEST）</li>
</ul>
</li>
<li>实现
<ul>
<li>API - RequestScope</li>
</ul>
</li>
</ol>
<h2 id="session作用域"><a class="markdownIt-Anchor" href="#session作用域"></a> session作用域</h2>
<ol>
<li>配置
<ul>
<li>XML - <code>&lt;bean class=&quot;...&quot; scope=&quot;session&quot;&gt;</code></li>
<li>Java注解 - @SessionScope或@Scope（WebApplicationContext.SCOPE_SESSION）</li>
</ul>
</li>
<li>实现
<ul>
<li>API - SessionScope</li>
</ul>
</li>
</ol>
<p>request作用域的对象，每次请求都会返回一个新的对象，并且对象会经历初始化和销毁两个过程，而session作用域，在同一个cookie的情况下，每次返回的都是同一个对象，这个时候对象只会经历初始化的过程，而不会对Bean进行销毁。无论是request还是session，返回的对象都是经过cglib代理的对象。</p>
<h2 id="application作用域"><a class="markdownIt-Anchor" href="#application作用域"></a> application作用域</h2>
<ol>
<li>配置
<ul>
<li>XML - <code>&lt;bean class=&quot;...&quot; scope=&quot;application&quot;&gt;</code></li>
<li>Java注解 - @ApplicationScope或@Scope（WebApplicationContext.APPLICATION）</li>
</ul>
</li>
<li>实现
<ul>
<li>API - ApplicationScope</li>
</ul>
</li>
</ol>
<p>application作用域的Bean可以在ServletContext中直接获取到。一个JavaWeb应用只创建一个ServletContext对象，应用在启动的时候创建ServletContext对象，在服务器关闭的时候销毁，使用ServletContext获取到的Bean对象也是经过cglib代理的对象，Bean的名称为<code>scopedTarget.beanName</code></p>
<h2 id="自定义bean作用域"><a class="markdownIt-Anchor" href="#自定义bean作用域"></a> 自定义Bean作用域</h2>
<ol>
<li>
<p>实现Scope</p>
<ul>
<li>org.springframework.beans.factory.config.Scope</li>
</ul>
</li>
<li>
<p>注册Scope</p>
<ul>
<li>
<p>API - org.springframework.beans.factory.config.ConfigurableBeanFactory#registerScope</p>
</li>
<li>
<p>配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.CustomScopeConfigurer&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;scopes&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>自定义作用的相关示例，首先进行定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalScope</span> <span class="keyword">implements</span> <span class="title">Scope</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCOP_NAME = <span class="string">&quot;thread-local&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NamedThreadLocal&lt;Map&lt;String, Object&gt;&gt; threadLocal = <span class="keyword">new</span> NamedThreadLocal(<span class="string">&quot;thread-local-scope&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String name, ObjectFactory&lt;?&gt; objectFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空</span></span><br><span class="line">        Map&lt;String, Object&gt; context = getContext();</span><br><span class="line">        Object object = context.get(name);</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            object = objectFactory.getObject();</span><br><span class="line">            context.put(name, object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">remove</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; context = getContext();</span><br><span class="line">        <span class="keyword">return</span> context.remove(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDestructionCallback</span><span class="params">(String name, Runnable callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveContextualObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; context = getContext();</span><br><span class="line">        <span class="keyword">return</span> context.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConversationId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(thread.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来进行注册并且测试是否成功：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalScopeDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(ThreadLocalScope.SCOP_NAME)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> User <span class="title">createUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(String.valueOf(System.nanoTime()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(ThreadLocalScopeDemo.class);</span><br><span class="line">        applicationContext.addBeanFactoryPostProcessor(beanFactory -&gt; &#123;</span><br><span class="line">                    beanFactory.registerScope(ThreadLocalScope.SCOP_NAME, <span class="keyword">new</span> ThreadLocalScope());</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        scopedBeansByLookup(applicationContext);</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scopedBeansByLookup</span><span class="params">(AnnotationConfigApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 单个线程下，返回的永远是同一个Bean</span></span><br><span class="line"><span class="comment">//        for (int i = 0; i &lt; 3; i++) &#123;</span></span><br><span class="line"><span class="comment">//            User user = applicationContext.getBean(&quot;user&quot;, User.class);</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;user = &quot; + user.getId());</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                User user = applicationContext.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">                System.out.printf(<span class="string">&quot;[Thread id: %d] user = %s%n&quot;</span>, Thread.currentThread().getId(), user);</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">            <span class="comment">// 强制线程执行完成</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-8"><a class="markdownIt-Anchor" href="#面试题-8"></a> 面试题</h2>
<h3 id="spring内建的bean的作用域有几种"><a class="markdownIt-Anchor" href="#spring内建的bean的作用域有几种"></a> Spring内建的Bean的作用域有几种？</h3>
<p>sington、prototype、request、session、application以及websocket</p>
<h3 id="singleton-bean是否在一个应用中是唯一的"><a class="markdownIt-Anchor" href="#singleton-bean是否在一个应用中是唯一的"></a> singleton Bean是否在一个应用中是唯一的？</h3>
<p>否，singleton bean仅在当前Spring IoC容器（BeanFactory）中是单例对象。</p>
<h3 id="application-bean是否被其他方案他替代"><a class="markdownIt-Anchor" href="#application-bean是否被其他方案他替代"></a> “application” Bean是否被其他方案他替代？</h3>
<p>可以的，实际上，“application” Bean与&quot;singleton&quot; Bean没有本质区别。</p>
<h1 id="spring-bean-生命周期"><a class="markdownIt-Anchor" href="#spring-bean-生命周期"></a> Spring Bean 生命周期</h1>
<h2 id="元信息配置阶段"><a class="markdownIt-Anchor" href="#元信息配置阶段"></a> 元信息配置阶段</h2>
<p>BeanDefinition的配置方式：</p>
<ol>
<li>面向资源
<ul>
<li>XML配置</li>
<li>Properties资源配置</li>
</ul>
</li>
<li>面向注解</li>
<li>面向API</li>
</ol>
<p>这里除了Properties资源配置我们没有见到过外，其他的都有相关的示例。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这里必须这么写，不能写user.class</span></span><br><span class="line"><span class="meta">user.(class)</span> = <span class="string">org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User</span></span><br><span class="line"><span class="meta">user.id</span> = <span class="string">001</span></span><br><span class="line"><span class="meta">user.name</span> = <span class="string">吉永超</span></span><br><span class="line"><span class="meta">user.city</span> = <span class="string">HANGZHOU</span></span><br></pre></td></tr></table></figure>
<p>相关的演示示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMetadataConfigurationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 实例化PropertiesBeanDefinitionReader</span></span><br><span class="line">        PropertiesBeanDefinitionReader propertiesBeanDefinitionReader = <span class="keyword">new</span> PropertiesBeanDefinitionReader(beanFactory);</span><br><span class="line">        String location = <span class="string">&quot;classpath:/META-INF/user.properties&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = propertiesBeanDefinitionReader.loadBeanDefinitions(location);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line">        <span class="comment">// 通过Bean ID和类型进行依赖查找</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="元信息解析阶段"><a class="markdownIt-Anchor" href="#元信息解析阶段"></a> 元信息解析阶段</h2>
<p>主要分为两种：</p>
<ol>
<li>面向资源BeanDefinition解析
<ul>
<li>BeanDefinitionReader</li>
<li>XML解析器 - BeanDefinitionParser</li>
</ul>
</li>
<li>面向注解BeanDefinition解析
<ul>
<li>AnnotatedBeanDefinitionReader</li>
</ul>
</li>
</ol>
<p>面向资源的情况我们在之前也有过相关的讨论，这里只介绍面向注解的BeanDefinition解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedBeanDefinitionParsingDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 基于Java 注解的 AnnotatedBeanDefinitionReader的实现</span></span><br><span class="line">        AnnotatedBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(beanFactory);</span><br><span class="line">        <span class="keyword">int</span> beanDefinitionCountBefore = beanFactory.getBeanDefinitionCount();</span><br><span class="line">        <span class="comment">// 注册当前类（非Componenet Class）</span></span><br><span class="line">        beanDefinitionReader.registerBean(AnnotatedBeanDefinitionParsingDemo.class);</span><br><span class="line">        <span class="keyword">int</span> beanDefinitionCountAfter = beanFactory.getBeanDefinitionCount();</span><br><span class="line">        <span class="keyword">int</span> beanDefinitionCount = beanDefinitionCountAfter - beanDefinitionCountBefore;</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanDefinitionCount);</span><br><span class="line">        <span class="comment">// 普通Class作为Component注册到Spring IoC容器后，通常Bean的名称为类名的首字母小写（annotatedBeanDefinitionParsingDemo）</span></span><br><span class="line">        <span class="comment">// Bean名称生成来自于BeanNameGenerator，注解实现AnnotationBeanNameGenerator</span></span><br><span class="line">        AnnotatedBeanDefinitionParsingDemo demo = beanFactory.getBean(<span class="string">&quot;annotatedBeanDefinitionParsingDemo&quot;</span>, AnnotatedBeanDefinitionParsingDemo.class);</span><br><span class="line">        System.out.println(demo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认生成Bean的名称的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">buildDefaultBeanName</span><span class="params">(BeanDefinition definition)</span> </span>&#123;</span><br><span class="line">	String beanClassName = definition.getBeanClassName();</span><br><span class="line">	Assert.state(beanClassName != <span class="keyword">null</span>, <span class="string">&quot;No bean class name set&quot;</span>);</span><br><span class="line">	String shortClassName = ClassUtils.getShortName(beanClassName);</span><br><span class="line">	<span class="keyword">return</span> Introspector.decapitalize(shortClassName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="注册阶段"><a class="markdownIt-Anchor" href="#注册阶段"></a> 注册阶段</h2>
<p>BeanDefinition注册的核心接口：BeanDefinitionRegistry，它有且仅有一个实现类就是DefaultListableBeanFactory。DefaultListableBeanFactory#registerBeanDefinition的逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.hasText(beanName, <span class="string">&quot;Bean name must not be empty&quot;</span>);</span><br><span class="line">		Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">						<span class="string">&quot;Validation of bean definition failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		BeanDefinition existingDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">    	<span class="comment">// 当已经存在BeanDefinition的时候</span></span><br><span class="line">		<span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// 允许Bean重复注册</span></span><br><span class="line">			<span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionOverrideException(beanName, beanDefinition, existingDefinition);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (existingDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">				<span class="comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">&quot;Overriding user-defined bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">							<span class="string">&quot;&#x27; with a framework-generated bean definition: replacing [&quot;</span> +</span><br><span class="line">							existingDefinition + <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(existingDefinition)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">							<span class="string">&quot;&#x27; with a different definition: replacing [&quot;</span> + existingDefinition +</span><br><span class="line">							<span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">					logger.trace(<span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">							<span class="string">&quot;&#x27; with an equivalent definition: replacing [&quot;</span> + existingDefinition +</span><br><span class="line">							<span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// 注册一个新的BeanDefinition</span></span><br><span class="line">			<span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">				<span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">                      <span class="comment">// 这里的beanDefinitionMap的类型是Map&lt;String, BeanDefinition&gt;,key就是Bean的名称，value就是对应的BeanDefinition</span></span><br><span class="line">					<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">                      <span class="comment">// 这里之所以还要维护一个beanDefinitionNames是为了记住注册时候的Bean的顺序。</span></span><br><span class="line">					List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">					updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">					updatedDefinitions.add(beanName);</span><br><span class="line">					<span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">					removeManualSingletonName(beanName);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Still in startup registration phase</span></span><br><span class="line">				<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">				<span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">				removeManualSingletonName(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">			resetBeanDefinition(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isConfigurationFrozen()) &#123;</span><br><span class="line">			clearByTypeCache();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beandefinition合并阶段"><a class="markdownIt-Anchor" href="#beandefinition合并阶段"></a> BeanDefinition合并阶段</h2>
<p>BeanDefinition合并：</p>
<ol>
<li>父子BeanDefinition合并
<ul>
<li>当前BeanFactory查找</li>
<li>层次性BeanFactory查找</li>
</ul>
</li>
</ol>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergedBeanDefinitionDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String location = <span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(location);</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(resource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(encodedResource);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>递归查找</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">getMergedBeanDefinition</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	String beanName = transformedBeanName(name);</span><br><span class="line">	<span class="comment">// Efficiently check whether bean definition exists in this factory.</span></span><br><span class="line">	<span class="keyword">if</span> (!containsBeanDefinition(beanName) &amp;&amp; getParentBeanFactory() <span class="keyword">instanceof</span> ConfigurableBeanFactory) &#123;</span><br><span class="line">		<span class="keyword">return</span> ((ConfigurableBeanFactory) getParentBeanFactory()).getMergedBeanDefinition(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Resolve merged bean definition locally.</span></span><br><span class="line">       <span class="comment">// 当前的BeanFactory</span></span><br><span class="line">	<span class="keyword">return</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合并的核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> RootBeanDefinition <span class="title">getMergedBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		String beanName, BeanDefinition bd, <span class="meta">@Nullable</span> BeanDefinition containingBd)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.mergedBeanDefinitions) &#123;</span><br><span class="line">		RootBeanDefinition mbd = <span class="keyword">null</span>;</span><br><span class="line">		RootBeanDefinition previous = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Check with full lock now in order to enforce the same merged instance.</span></span><br><span class="line">		<span class="keyword">if</span> (containingBd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			mbd = <span class="keyword">this</span>.mergedBeanDefinitions.get(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || mbd.stale) &#123;</span><br><span class="line">			previous = mbd;</span><br><span class="line">			<span class="keyword">if</span> (bd.getParentName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// Use copy of given root bean definition.</span></span><br><span class="line">				<span class="keyword">if</span> (bd <span class="keyword">instanceof</span> RootBeanDefinition) &#123;</span><br><span class="line">					mbd = ((RootBeanDefinition) bd).cloneBeanDefinition();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					mbd = <span class="keyword">new</span> RootBeanDefinition(bd);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Child bean definition: needs to be merged with parent.</span></span><br><span class="line">				BeanDefinition pbd;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					String parentBeanName = transformedBeanName(bd.getParentName());</span><br><span class="line">					<span class="keyword">if</span> (!beanName.equals(parentBeanName)) &#123;</span><br><span class="line">						pbd = getMergedBeanDefinition(parentBeanName);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						BeanFactory parent = getParentBeanFactory();</span><br><span class="line">						<span class="keyword">if</span> (parent <span class="keyword">instanceof</span> ConfigurableBeanFactory) &#123;</span><br><span class="line">							pbd = ((ConfigurableBeanFactory) parent).getMergedBeanDefinition(parentBeanName);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(parentBeanName,</span><br><span class="line">									<span class="string">&quot;Parent name &#x27;&quot;</span> + parentBeanName + <span class="string">&quot;&#x27; is equal to bean name &#x27;&quot;</span> + beanName +</span><br><span class="line">											<span class="string">&quot;&#x27;: cannot be resolved without a ConfigurableBeanFactory parent&quot;</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(bd.getResourceDescription(), beanName,</span><br><span class="line">							<span class="string">&quot;Could not resolve parent bean definition &#x27;&quot;</span> + bd.getParentName() + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Deep copy with overridden values.</span></span><br><span class="line">				mbd = <span class="keyword">new</span> RootBeanDefinition(pbd);</span><br><span class="line">				mbd.overrideFrom(bd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Set default singleton scope, if not configured before.</span></span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.hasLength(mbd.getScope())) &#123;</span><br><span class="line">				mbd.setScope(SCOPE_SINGLETON);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// A bean contained in a non-singleton bean cannot be a singleton itself.</span></span><br><span class="line">			<span class="comment">// Let&#x27;s correct this on the fly here, since this might be the result of</span></span><br><span class="line">			<span class="comment">// parent-child merging for the outer bean, in which case the original inner bean</span></span><br><span class="line">			<span class="comment">// definition will not have inherited the merged outer bean&#x27;s singleton status.</span></span><br><span class="line">			<span class="keyword">if</span> (containingBd != <span class="keyword">null</span> &amp;&amp; !containingBd.isSingleton() &amp;&amp; mbd.isSingleton()) &#123;</span><br><span class="line">				mbd.setScope(containingBd.getScope());</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Cache the merged bean definition for the time being</span></span><br><span class="line">			<span class="comment">// (it might still get re-merged later on in order to pick up metadata changes)</span></span><br><span class="line">			<span class="keyword">if</span> (containingBd == <span class="keyword">null</span> &amp;&amp; isCacheBeanMetadata()) &#123;</span><br><span class="line">				<span class="keyword">this</span>.mergedBeanDefinitions.put(beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">			copyRelevantMergedBeanDefinitionCaches(previous, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> mbd;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bean-class加载阶段"><a class="markdownIt-Anchor" href="#bean-class加载阶段"></a> Bean Class加载阶段</h2>
<ol>
<li>ClassLoader类加载</li>
<li>Java Security安全控制</li>
<li>ConfigurableBeanFactory临时ClassLoader（场景比较有限）</li>
</ol>
<p>加载的核心代码代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; resolveBeanClass(<span class="meta">@Nullable</span> ClassLoader classLoader) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">	String className = getBeanClassName();</span><br><span class="line">	<span class="keyword">if</span> (className == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Class&lt;?&gt; resolvedClass = ClassUtils.forName(className, classLoader);</span><br><span class="line">	<span class="keyword">this</span>.beanClass = resolvedClass;</span><br><span class="line">	<span class="keyword">return</span> resolvedClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最开始的beanClass实际上是一个String类型，然后通过AppClassLoader加载到Class对象并赋值给beanClass这个属性，这个属性本身是一个Object类型的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Object beanClass;</span><br></pre></td></tr></table></figure>
<h2 id="实例化"><a class="markdownIt-Anchor" href="#实例化"></a> 实例化</h2>
<h3 id="实例化前阶段"><a class="markdownIt-Anchor" href="#实例化前阶段"></a> 实例化前阶段</h3>
<p>非主流生命周期-Bena实例化前阶段</p>
<ul>
<li>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</li>
</ul>
<p>首先我们给出这个接口的使用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInstantiationLifecycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 添加BeanPostProcesssor实现</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> MyInstantiationAwareBeanPostProcessor());</span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String location = <span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>;</span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(location);</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(resource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(encodedResource);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInstantiationAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;SuperUser&quot;</span>,beanName) &amp;&amp; SuperUser.class.equals(beanClass)) &#123;</span><br><span class="line">                <span class="comment">// 把配置好的SuperUser Bean覆盖</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SuperUser();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// 保持Spring IoC容器的实例化操作</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码分析，可以看到postProcessBeforeInstantiation方法被调用之后返回了这个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">			Object result = bp.postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line">			<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用关系，不难看出，在实例化Bean的时候，如果上述的方法返回的不是一个空对象，就直接返回，不在进行实例化的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line"><span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实例化阶段"><a class="markdownIt-Anchor" href="#实例化阶段"></a> 实例化阶段</h3>
<p>Spring中实例化方式：</p>
<ol>
<li>传统实例化方式
<ul>
<li>实例化策略 - InstantiationStrategy</li>
</ul>
</li>
<li>构造器注入</li>
</ol>
<p>传统的方式可以在AbstractAutowireCapableBeanFactory#instantiateBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>构造器注入，我们可以构造一个例子来进行测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserHolder&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user=&quot;</span> + user +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在之前的例子上稍作修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInstantiationLifecycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 添加BeanPostProcesssor实现</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> MyInstantiationAwareBeanPostProcessor());</span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String[] locations = &#123;<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>,<span class="string">&quot;META-INF/bean-constructor-dependency-injection.xml&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(locations);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">        <span class="comment">// 构造器注入式按照类型注入，底层resolveDependency</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(<span class="string">&quot;userHolder&quot;</span>, UserHolder.class);</span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInstantiationAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;SuperUser&quot;</span>,beanName) &amp;&amp; SuperUser.class.equals(beanClass)) &#123;</span><br><span class="line">                <span class="comment">// 把配置好的SuperUser Bean覆盖</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SuperUser();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// 保持Spring IoC容器的实例化操作</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们可以总结一下，Bean的实例化主要有两种类型，并且使用构造器注入的时候，是按照类型来进行注入的，底层是使用的我们在依赖注入章节中介绍过的resolveDependency方法来实现的。</p>
<h3 id="bean实例化后阶段"><a class="markdownIt-Anchor" href="#bean实例化后阶段"></a> Bean实例化后阶段</h3>
<p>对于Spring Bean实例化后阶段，我们可以理解为是Bean属性赋值（Populate）的判断：InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation。可以结合Bean实例化前阶段一起对照查看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInstantiationAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;SuperUser&quot;</span>, beanName) &amp;&amp; SuperUser.class.equals(beanClass)) &#123;</span><br><span class="line">              <span class="comment">// 把配置好的SuperUser Bean覆盖</span></span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> SuperUser();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// 保持Spring IoC容器的实例化操作</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;user&quot;</span>, beanName) &amp;&amp; User.class.equals(bean.getClass())) &#123;</span><br><span class="line">              User user = (User) bean;</span><br><span class="line">              user.setId(<span class="string">&quot;33&quot;</span>);</span><br><span class="line">              user.setName(<span class="string">&quot;jjjjjj&quot;</span>);</span><br><span class="line">              <span class="comment">// &quot;user&quot;对象不允许属性赋值（填入）（配置元信息 -&gt; 属性值）</span></span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里相当于可以拦截掉所有的属性赋值，并且可以进行一些自定义的赋值，此时Bean的实例化已经完成了，但是属性赋值还没进行。</p>
<h2 id="属性赋值前阶段"><a class="markdownIt-Anchor" href="#属性赋值前阶段"></a> 属性赋值前阶段</h2>
<p>Bean属性值信息的类：</p>
<ul>
<li>PropertyValues</li>
</ul>
<p>Bean属性赋值前回调</p>
<ul>
<li>Spring1.2-5.0：InstantiationAwareBeanPostProcessor#postProcessPropertyValues</li>
<li>Spring 5.1：InstantiationAwareBeanPostProcessor#postProcessProperties</li>
</ul>
<p>他们都是在BeanFactory赋值之前的回调操作，PropertyValues就是从配置文件里面读入的值，这个方法的作用就是可以修改从配置文件里面读入的值，默认情况下不做任何修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">default</span> PropertyValues <span class="title">postProcessPropertyValues</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> pvs;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是，这里的返回值是null。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">default</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>还在在我们之前的例子上稍作修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">       <span class="comment">// 要注意如果postProcessAfterInstantiation返回的是false的话，这个方法不会被调用，因为相当于返回的Bean已经被替换了。</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;userHolder&quot;</span>, beanName) &amp;&amp; UserHolder.class.equals(bean.getClass())) &#123;</span><br><span class="line">                <span class="comment">// 假设&lt;property name=&quot;number&quot; value=&quot;1&quot; /&gt;配置的话，那么在PropertyValues中就包含一个PropertyValues(number=1)</span></span><br><span class="line">                <span class="keyword">final</span> MutablePropertyValues propertyValues;</span><br><span class="line">                <span class="keyword">if</span> (pvs <span class="keyword">instanceof</span> MutablePropertyValues) &#123;</span><br><span class="line">                    propertyValues = (MutablePropertyValues) pvs;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    propertyValues = <span class="keyword">new</span> MutablePropertyValues();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 等价于&lt;property name=&quot;number&quot; value=&quot;1&quot; /&gt;</span></span><br><span class="line">                propertyValues.addPropertyValue(<span class="string">&quot;number&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (propertyValues.contains(<span class="string">&quot;description&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// PropertyValue是不可变的</span></span><br><span class="line"><span class="comment">//                    PropertyValue description = propertyValues.getPropertyValue(&quot;description&quot;);</span></span><br><span class="line">                    propertyValues.removePropertyValue(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">                    propertyValues.addPropertyValue(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;The user holder V2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> propertyValues;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这里我们演示了两种情况，一种是number这个属性本来是没有值的，通过这个Api的拦截，我们手动给他赋上了值，而description这个属性，是我们在XML文件中，定义好了属性值，从结果来看，这个属性值也成功的被修改了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userHolder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.lifecycle.UserHolder&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;constructor&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;number&quot; value=&quot;1&quot;/&gt;--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">value</span>=<span class="string">&quot;The user holder&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改后的UserHolder类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserHolder&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user=&quot;</span> + user +</span><br><span class="line">                <span class="string">&quot;, number=&quot;</span> + number +</span><br><span class="line">                <span class="string">&quot;, description=&#x27;&quot;</span> + description + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(Integer number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>相应的源码：</p>
<p><img src="./SpringFramework.assets/image-20210614105732908.png" alt="image-20210614105732908" /></p>
<p>最后将准备好的pvs对象赋值给BeanWrapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pvs != <span class="keyword">null</span>) &#123;</span><br><span class="line">	applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h2>
<h3 id="接口回调阶段"><a class="markdownIt-Anchor" href="#接口回调阶段"></a> 接口回调阶段</h3>
<p>Spring Aware接口：</p>
<ul>
<li>BeanNameAware</li>
<li>BeanClassLoaderAware</li>
<li>BeanFactoryAware</li>
<li>EnvironmentAware</li>
<li>EmbeddedValueResolverAware</li>
<li>ResourceLoaderAware</li>
<li>ApplicationEventPublisherAware</li>
<li>MessageSourceAware</li>
<li>ApplicationContextAware</li>
</ul>
<blockquote>
<p>这里列出的顺序同时也是调用时候的顺序，这一点，源代码中也有体现：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(String beanName, Object bean)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">				((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">				ClassLoader bcl = getBeanClassLoader();</span><br><span class="line">				<span class="keyword">if</span> (bcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">					((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">				((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>另外一些相关的方法在ApplicationContextAwareProcessor#invokeAwareInterfaces：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareInterfaces</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EnvironmentAware) &#123;</span><br><span class="line">			((EnvironmentAware) bean).setEnvironment(<span class="keyword">this</span>.applicationContext.getEnvironment());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EmbeddedValueResolverAware) &#123;</span><br><span class="line">			((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(<span class="keyword">this</span>.embeddedValueResolver);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ResourceLoaderAware) &#123;</span><br><span class="line">			((ResourceLoaderAware) bean).setResourceLoader(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationEventPublisherAware) &#123;</span><br><span class="line">			((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> MessageSourceAware) &#123;</span><br><span class="line">			((MessageSourceAware) bean).setMessageSource(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationStartupAware) &#123;</span><br><span class="line">			((ApplicationStartupAware) bean).setApplicationStartup(<span class="keyword">this</span>.applicationContext.getApplicationStartup());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationContextAware) &#123;</span><br><span class="line">			((ApplicationContextAware) bean).setApplicationContext(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>但是第二部分的回调接口无法通过BeanFacotry的方式得到回调，我们需要对之前的代码进行一定的重构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInstantiationLifecycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        executeBeanFactory();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=============&quot;</span>);</span><br><span class="line"></span><br><span class="line">        executApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 方法一：添加BeanPostProcesssor实现InstantiationAwareBeanPostProcessor</span></span><br><span class="line">        <span class="comment">// 方法二：将MyInstantiationAwareBeanPostProcessor作为Bean注册</span></span><br><span class="line"><span class="comment">//        beanFactory.addBeanPostProcessor(new MyInstantiationAwareBeanPostProcessor());</span></span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String[] locations = &#123;<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>, <span class="string">&quot;META-INF/bean-constructor-dependency-injection.xml&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(locations);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">        <span class="comment">// 构造器注入式按照类型注入，底层resolveDependency</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(<span class="string">&quot;userHolder&quot;</span>, UserHolder.class);</span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClassPathXmlApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext();</span><br><span class="line">        String[] locations = &#123;<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>, <span class="string">&quot;META-INF/bean-constructor-dependency-injection.xml&quot;</span>&#125;;</span><br><span class="line">        applicationContext.setConfigLocations(locations);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        User user = applicationContext.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        SuperUser superUser = applicationContext.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">        UserHolder userHolder = applicationContext.getBean(<span class="string">&quot;userHolder&quot;</span>, UserHolder.class);</span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在XML文件中，注入MyInstantiationAwareBeanPostProcessor：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.lifecycle.MyInstantiationAwareBeanPostProcessor&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以在UserHolder中实现这些接口，进行观察：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHolder</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserHolder&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user=&quot;</span> + user +</span><br><span class="line">                <span class="string">&quot;, number=&quot;</span> + number +</span><br><span class="line">                <span class="string">&quot;, description=&#x27;&quot;</span> + description + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, beanName=&#x27;&quot;</span> + beanName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(Integer number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHolder</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不难发现，通过BeanFacotry的方式，无法获取到EnvironmentAware对象的回调，而ApplicationContext则可以，这是因为在AbstractApplicationContext#prepareBeanFactory中，BeanFactory注册了ApplicationContextAwareProcessor这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure>
<p>而我们前面提到过，第二部分的接口的回调，需要执行ApplicationContextAwareProcessor#invokeAwareInterfaces方法，而ApplicationContextAwareProcessor又是一个非public的类，因此，在我们创建的BeanFactory无法操作这个类。总来的来说，通过BeanFactory可以获取到BeanNameAware、BeanClassLoaderAware、BeanFactoryAware这三个接口的回调，而如果使用AppliactionContext来进行操作，就可以获取到更多的回调，这也从另一个角度说明了AppliacitonContext和BeanFactory的区别。</p>
<h3 id="初始化前阶段"><a class="markdownIt-Anchor" href="#初始化前阶段"></a> 初始化前阶段</h3>
<p>方法回调：</p>
<ul>
<li>BeanPostProcessor#postProcessBeforeInitialization</li>
</ul>
<p>因为InstantiationAwareBeanPostProcessor继承了BeanPostProcessor，因此我们还是调整MyInstantiationAwareBeanPostProcessor的方法来进行观察：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;userHolder&quot;</span>, beanName) &amp;&amp; UserHolder.class.equals(bean.getClass())) &#123;</span><br><span class="line">           UserHolder userHolder = (UserHolder) bean;</span><br><span class="line">           userHolder.setDescription(<span class="string">&quot;The user holder V3&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> userHolder;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>为了跟前面加以区别，这里我们增加一个调用的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInitilzationLifecycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        executeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 方法一：添加BeanPostProcesssor实现InstantiationAwareBeanPostProcessor</span></span><br><span class="line">        <span class="comment">// 方法二：将MyInstantiationAwareBeanPostProcessor作为Bean注册</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> MyInstantiationAwareBeanPostProcessor());</span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String[] locations = &#123;<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>, <span class="string">&quot;META-INF/bean-constructor-dependency-injection.xml&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(locations);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">        <span class="comment">// 构造器注入式按照类型注入，底层resolveDependency</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(<span class="string">&quot;userHolder&quot;</span>, UserHolder.class);</span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到userHolder的description属性成功的变成了v3，相关的源码的实现在AbstractAutowireCapableBeanFactory#pplyBeanPostProcessorsBeforeInitialization：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">	Object result = existingBean;</span><br><span class="line">	<span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">		Object current = processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">		<span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">            <span class="comment">// 可能返回的是一个代理对象，并不是原有的对象</span></span><br><span class="line">		result = current;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化阶段"><a class="markdownIt-Anchor" href="#初始化阶段"></a> 初始化阶段</h3>
<p>在之前，我们有提到过Bean初始化操作：</p>
<ul>
<li>@PostConstruct标注方法</li>
<li>实现InitializingBean接口的afterPropertiesSet()方法</li>
<li>自定义初始化方法</li>
</ul>
<blockquote>
<p>@PostConstruct标注方法需要注解驱动，因为这种方式需要依赖于ApplicationContext的，并且所依赖的ApplicationContext是需要有注解驱动能力的。</p>
</blockquote>
<p>我们在UserHolder中添加它的初始化方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 依赖于注解驱动，当前场景：BeanFactory，因此直接运行，并不会执行</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostConstruct</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initPostConstruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V4&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;initPostConstruct() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V5&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;afterPropertiesSet() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V6&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;init() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里因为我们是BeanFactory的场景，因此需要手动添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> CommonAnnotationBeanPostProcessor());</span><br></pre></td></tr></table></figure>
<p>相应的源码在AbstractAutowireCapableBeanFactory#invokeInitMethods方法当中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeInitMethods</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="comment">// afterPropertiesSet方法：</span></span><br><span class="line">		<span class="keyword">boolean</span> isInitializingBean = (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">		<span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">						((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">					&#125;, getAccessControlContext());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">					<span class="keyword">throw</span> pae.getException();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 自定义初始化方法</span></span><br><span class="line">		<span class="keyword">if</span> (mbd != <span class="keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">			String initMethodName = mbd.getInitMethodName();</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">					!(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">					!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">				invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化后阶段"><a class="markdownIt-Anchor" href="#初始化后阶段"></a> 初始化后阶段</h3>
<p>方法的回调：</p>
<ul>
<li>BeanPostProcessor#postProcessAfterInitialization</li>
</ul>
<p>还是对我们的MyInstantiationAwareBeanPostProcessor进行添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;userHolder&quot;</span>, beanName) &amp;&amp; UserHolder.class.equals(bean.getClass())) &#123;</span><br><span class="line">          UserHolder userHolder = (UserHolder) bean;</span><br><span class="line">          userHolder.setDescription(<span class="string">&quot;The user holder V7&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> userHolder;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>总的来说，关于Bean的初始化操作，总共可以分为下面几个阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">			invokeAwareMethods(beanName, bean);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;, getAccessControlContext());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 接口回调</span></span><br><span class="line">		invokeAwareMethods(beanName, bean);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Object wrappedBean = bean;</span><br><span class="line">	<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">           <span class="comment">// 初始化前方法</span></span><br><span class="line">		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 初始化方法</span></span><br><span class="line">		invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">				(mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">				beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">           <span class="comment">// 初始化后方法</span></span><br><span class="line">		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化完成阶段"><a class="markdownIt-Anchor" href="#初始化完成阶段"></a> 初始化完成阶段</h3>
<p>方法回调：</p>
<ul>
<li>SmartInitializingSingleton#afterSingletonsInstantiated</li>
</ul>
<p>同样的，还是操作Userholder类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V8&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;afterSingletonsInstantiated() = &quot;</span> + description);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>直接去运行，发现并没有打印出我们预期的结果，这是因为这个方法调用的地方在DefaultListableBeanFactory#preInstantiateSingletons，而这个方法需要显示的调用才会执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SmartInitializingSingleton 通常在Spring AppliactionContext场景使用</span></span><br><span class="line"><span class="comment">// preInstantiateSingletons将已注册的BeanDefinition初始化成Spring Bean</span></span><br><span class="line">beanFactory.preInstantiateSingletons();</span><br></pre></td></tr></table></figure>
<p>在AbstractApplicationContext#finishBeanFactoryInitialization方法中，我们可以看到这里就调用了preInstantiateSingletons方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">		beanFactory.preInstantiateSingletons();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>提供这个方法的主要原因是之前的BeanPostProcessor接口提供的回调，可能Bean会存在初始化不完全的情况，使用这个方法的时候就不用担心有Bean初始化不完全的情况发生。</p>
<h2 id="销毁阶段"><a class="markdownIt-Anchor" href="#销毁阶段"></a> 销毁阶段</h2>
<h3 id="销毁前阶段"><a class="markdownIt-Anchor" href="#销毁前阶段"></a> 销毁前阶段</h3>
<p>方法回调：</p>
<ul>
<li>DestructionAwareBeanPostProcessor#postProcessBeforeDestruction</li>
</ul>
<p>实现一下这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDestructionAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">DestructionAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeforeDestruction</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;userHolder&quot;</span>, beanName) &amp;&amp; UserHolder.class.equals(bean.getClass())) &#123;</span><br><span class="line">            UserHolder userHolder = (UserHolder) bean;</span><br><span class="line">            userHolder.setDescription(<span class="string">&quot;The user holder V9&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于Bean生命周期的完整的演示示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanLifeCycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">// 方法一：添加BeanPostProcesssor实现InstantiationAwareBeanPostProcessor</span></span><br><span class="line">        <span class="comment">// 方法二：将MyInstantiationAwareBeanPostProcessor作为Bean注册</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> MyInstantiationAwareBeanPostProcessor());</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> CommonAnnotationBeanPostProcessor());</span><br><span class="line">        <span class="comment">// 添加MyDestructionAwareBeanPostProcessor执行销毁前回调</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> MyDestructionAwareBeanPostProcessor());</span><br><span class="line">        <span class="comment">// 基于XML资源BeanDefinitionReader 实现</span></span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        String[] locations = &#123;<span class="string">&quot;META-INF/dependency-lookup-context.xml&quot;</span>, <span class="string">&quot;META-INF/bean-constructor-dependency-injection.xml&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> beanNumbers = xmlBeanDefinitionReader.loadBeanDefinitions(locations);</span><br><span class="line">        System.out.println(<span class="string">&quot;已加载的BeanDefinitiond的数量：&quot;</span> + beanNumbers);</span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line">        <span class="comment">// 不需要合并BeanDefinition</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line">        <span class="comment">// 需要合并BeanDefinition</span></span><br><span class="line">        SuperUser superUser = beanFactory.getBean(<span class="string">&quot;SuperUser&quot;</span>, SuperUser.class);</span><br><span class="line">        System.out.println(superUser.toString());</span><br><span class="line">        <span class="comment">// 构造器注入式按照类型注入，底层resolveDependency</span></span><br><span class="line">        UserHolder userHolder = beanFactory.getBean(<span class="string">&quot;userHolder&quot;</span>, UserHolder.class);</span><br><span class="line">        <span class="comment">// SmartInitializingSingleton 通常在Spring AppliactionContext场景使用</span></span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line"></span><br><span class="line">        beanFactory.destroyBean(<span class="string">&quot;userHolder&quot;</span>, userHolder);</span><br><span class="line">        <span class="comment">// Bean销毁并不意味这Bean垃圾回收了</span></span><br><span class="line">        System.out.println(userHolder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>特别需要注意的是，这里的销毁并不是这个对象被GC掉了，GC和Bean的销毁是两个不同的概念。</p>
</blockquote>
<h3 id="销毁阶段-2"><a class="markdownIt-Anchor" href="#销毁阶段-2"></a> 销毁阶段</h3>
<p>Bean销毁（Destory）：</p>
<ul>
<li>@PreDestory标注方法</li>
<li>实现DisposableBean接口的destory()方法</li>
<li>自定义销毁方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreDestroy</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V10&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;PreDestroy() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V11&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;PreDestroy() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.description = <span class="string">&quot;The user holder V12&quot;</span>;</span><br><span class="line">       System.out.println(<span class="string">&quot;PreDestroy() = &quot;</span> + description);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在XML中指定自定义的销毁方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userHolder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.bean.lifecycle.UserHolder&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;constructor&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;doDestory&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;number&quot; value=&quot;1&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">value</span>=<span class="string">&quot;The user holder&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在BeanFactory场景下还是需要手动进行调用，而在ApplicationContext中，是会自动调用的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.destroyBean(<span class="string">&quot;userHolder&quot;</span>, userHolder);</span><br></pre></td></tr></table></figure>
<h2 id="bean垃圾收集"><a class="markdownIt-Anchor" href="#bean垃圾收集"></a> Bean垃圾收集</h2>
<p>Bean垃圾回收（GC）的过程：</p>
<ol>
<li>关闭Spring容器（应用上下文）</li>
<li>执行GC</li>
<li>Spring Bean覆盖的finalize()方法被回调</li>
</ol>
<p>首先在UserHolder中重写finalize()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;UserHolder is finalized ...&quot;</span>);</span><br><span class="line">    <span class="keyword">super</span>.finalize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行销毁方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 销毁BeanFactory中的单例Bean</span></span><br><span class="line">   beanFactory.destroySingletons();</span><br><span class="line">   <span class="comment">// 强制GC</span></span><br><span class="line">   System.gc();</span><br><span class="line">   <span class="comment">// 等待一段时间</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (InterruptedException exception) &#123;</span><br><span class="line">       exception.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   System.gc();</span><br></pre></td></tr></table></figure>
<h2 id="面试题-9"><a class="markdownIt-Anchor" href="#面试题-9"></a> 面试题</h2>
<h3 id="beanpostprocess使用场景有哪些"><a class="markdownIt-Anchor" href="#beanpostprocess使用场景有哪些"></a> BeanPostProcess使用场景有哪些？</h3>
<p>BeanPostProcess提供了Spring Bean初始化前和初始化后的生命周期回调，分别对应postProcessBeforeInitialization以及postProcessAfterInitialization方法，允许对关心的Bean进行扩展，甚至是替换，</p>
<p>其中ApplicationContext相关的Aware回调也是基于BeanPostProcess实现，即ApplicationContextAwareProcessor。</p>
<h3 id="beanfactorypostprocess与beanpostprocess的区别"><a class="markdownIt-Anchor" href="#beanfactorypostprocess与beanpostprocess的区别"></a> BeanFactoryPostProcess与BeanPostProcess的区别</h3>
<p>BeanFactroyPostProcessor是Spring BeanFacrtory（实际为ConfigurableListableBeanFactory）的后置处理器，用于扩展BeanFacotry，或通过BeanFactory进行依赖查找和依赖注入。</p>
<p>BeanFactroyPostProcessor必须有Spring ApplicationContext执行，BeanFactory无法与其直接交互。而BeanPostProcess直接与BeanFactory关联，属于N对1的关系。</p>
<h3 id="beanfactory是怎样处理bean生命周期"><a class="markdownIt-Anchor" href="#beanfactory是怎样处理bean生命周期"></a> BeanFactory是怎样处理Bean生命周期？</h3>
<p>BeanFactory的默认实现为DefaultListableBeanFactory，其中Bean生命周期与方法映射如下：</p>
<ul>
<li>BeanDefinition注册阶段 - regsiterBeanDefinition</li>
<li>BeanDefinition合并阶段 - getMergedBeanDefinition</li>
<li>Bean实例化前阶段 - resolveBeforeInstantiation</li>
<li>Bean实例化阶段 - createBeanInstance</li>
<li>Bean实例化后阶段- populateBean</li>
<li>Bean属性赋值前阶段 - populateBean</li>
<li>Bean属性赋值阶段 - populateBean</li>
<li>Bean Aware接口回调阶段 - initializeBean</li>
<li>Bean初始化前阶段- initializeBean</li>
<li>Bean初始化阶段- initializeBean</li>
<li>Bean初始化后阶段- initializeBean</li>
<li>Bean初始化完成阶段 - preInstantiateSingtons</li>
<li>Bean销毁前阶段- destoryBean</li>
<li>Bean销毁阶段 - destoryBean</li>
</ul>
<h1 id="spring-配置元信息"><a class="markdownIt-Anchor" href="#spring-配置元信息"></a> Spring 配置元信息</h1>
<p>配置元信息主要可以分为以下五个方面：</p>
<ol>
<li>Spring Bean配置元信息 - BeanDefinition</li>
<li>Spring Bean属性元信息 - PropertyValues</li>
<li>Spring 容器配置元信息</li>
<li>Spring 外部化配置元信息 - PropertySource</li>
<li>Spring Profile 元信息 - @Profile</li>
</ol>
<h2 id="spring-bean配置元信息"><a class="markdownIt-Anchor" href="#spring-bean配置元信息"></a> Spring Bean配置元信息</h2>
<p>Bean的配置元信息 - BeanDefinition主要包括了：</p>
<ul>
<li>GenericBeanDefinition：通用型BeanDefinition</li>
<li>RootBeanDefinition：无parent的BeanDefinition或者合并后BeanDefinition</li>
<li>AnnotatedBeanDefinition：注解标注的BeanDefinition</li>
</ul>
<blockquote>
<p>AnnotatedBeanDefinition中的AnnotationMetadata有两种具体的实现，StandardAnnotationMetadata是基于Java注解实现的，SimpleAnnotationMetadata是基于ASM实现的。</p>
</blockquote>
<h2 id="spring-bean属性元信息"><a class="markdownIt-Anchor" href="#spring-bean属性元信息"></a> Spring Bean属性元信息</h2>
<ol>
<li>Bean属性元信息 - PropertyValues
<ul>
<li>可修改实现 - MutablePropertyValues</li>
<li>元素成员 - PropertyValue</li>
</ul>
</li>
<li>Bean属性上下文存储 - AttributeAccessor</li>
<li>Bean元信息元素 - BeanMetadataElement</li>
</ol>
<p>其中第一种我们已经见过很多次了，这里主要演示第二种和第三种。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfigurationMetadataDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// BeanDefinition 的定义（声明）</span></span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(User.class);</span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jycoder&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取AbstractBeanDefinition</span></span><br><span class="line">        AbstractBeanDefinition beanDefinition = beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line">        <span class="comment">// 声明BeanDefinition</span></span><br><span class="line">        <span class="comment">// 附件属性(不影响Bean 实例化、属性赋值、初始化)</span></span><br><span class="line">        beanDefinition.setAttribute(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jiyongchao&quot;</span>);</span><br><span class="line">        <span class="comment">// 当前BeanDefinition来自何方,也是起存储的作用</span></span><br><span class="line">        beanDefinition.setSource(BeanConfigurationMetadataDemo.class);</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(<span class="string">&quot;user&quot;</span>, beanName) &amp;&amp; User.class.equals(bean.getClass())) &#123;</span><br><span class="line">                    BeanDefinition bd = beanFactory.getBeanDefinition(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (BeanConfigurationMetadataDemo.class.equals(bd.getSource())) &#123; <span class="comment">// 通过source来判断</span></span><br><span class="line">                        <span class="comment">// TODO</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 属性（存储）上下文</span></span><br><span class="line">                    String name = (String) bd.getAttribute(<span class="string">&quot;jiyongchao&quot;</span>); <span class="comment">// 这里的name就是jiyongchao</span></span><br><span class="line">                    User user = (User) bean;</span><br><span class="line">                    user.setName(name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;user&quot;</span>, beanDefinition);</span><br><span class="line"></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring容器配置元信息"><a class="markdownIt-Anchor" href="#spring容器配置元信息"></a> Spring容器配置元信息</h2>
<p>Spring XML配置元信息 - Beans元素相关</p>
<table>
<thead>
<tr>
<th>Beans元素属性</th>
<th>默认直</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>profile</td>
<td>null（留空）</td>
<td>Spring Profiles配置值</td>
</tr>
<tr>
<td>default-lazt-init</td>
<td>default</td>
<td>当outter beans “default-lazy-init&quot;属性存在时，继承该值，否则为&quot;false”</td>
</tr>
<tr>
<td>default-merge</td>
<td>default</td>
<td>当outter beans “default-merge&quot;属性存在时，继承该值，否则为&quot;false”</td>
</tr>
<tr>
<td>default-autowire</td>
<td>default</td>
<td>当outter beans “default-autowire&quot;属性存在时，继承该值，否则为&quot;false”</td>
</tr>
<tr>
<td>default-autowire-candidates</td>
<td>null（留空）</td>
<td>默认Spring Beans 名称pattern</td>
</tr>
<tr>
<td>default-init-method</td>
<td>null（留空）</td>
<td>默认Spring Beans 自定义初始化方法</td>
</tr>
<tr>
<td>default-destory-method</td>
<td>null（留空）</td>
<td>默认Spring Beans 自定义销毁方法</td>
</tr>
</tbody>
</table>
<blockquote>
<p>outter beans指的是在XML文件中通过import导入资源的方法注册Bean，导入方就是外部，被导入方就是内部。</p>
</blockquote>
<p>Spring XML配置元信息 - 应用上下文</p>
<table>
<thead>
<tr>
<th>XML元素</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;context:annotation-config /&gt;</td>
<td>激活Spring注解驱动</td>
</tr>
<tr>
<td>&lt;context:componenet-scan /&gt;</td>
<td>Spring@Component以及自定义注解扫描</td>
</tr>
<tr>
<td>&lt;context:load-time-weaver /&gt;</td>
<td>激活Spring LoadTimeWeaver</td>
</tr>
<tr>
<td>&lt;context:mbean-export /&gt;</td>
<td>暴露Spring Beans作为JMX Beans</td>
</tr>
<tr>
<td>&lt;context:mbean-server /&gt;</td>
<td>将当前平台作为MBeanServer</td>
</tr>
<tr>
<td>&lt;context:property-placeholder /&gt;</td>
<td>加载外部化配置资源作为Spring属性配置</td>
</tr>
<tr>
<td>&lt;context:property-override /&gt;</td>
<td>利用外部化配置资源覆盖Spring属性值</td>
</tr>
</tbody>
</table>
<blockquote>
<p>mbean：Java Management Extensions</p>
</blockquote>
<p>关于Beans的元素相关的配置可以在<code>BeanDefinitionParserDelegate#populateDefaults</code>中看到。</p>
<h2 id="基于xml资源装载spring-bean配置元信息"><a class="markdownIt-Anchor" href="#基于xml资源装载spring-bean配置元信息"></a> 基于XML资源装载Spring Bean配置元信息</h2>
<p>Spring Bean配置元信息</p>
<table>
<thead>
<tr>
<th>XML元素</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;beans:beans /&gt;</td>
<td>单XML资源下的多个Spring Beans配置</td>
</tr>
<tr>
<td>&lt;beans:bean /&gt;</td>
<td>单个Spring Bean定义（BeanDefinition）配置</td>
</tr>
<tr>
<td>&lt;beans:alias /&gt;</td>
<td>为Spring Bean定义（BeanDefinition）映射别名</td>
</tr>
<tr>
<td>&lt;beans:import /&gt;</td>
<td>加载外部Spring XML配置资源</td>
</tr>
</tbody>
</table>
<blockquote>
<p>通常情况下我们会使用默认的namespace，这里使用beans来更加明确的说明，这里的底层实现都是XmlBeanDefinitionReader。</p>
</blockquote>
<p>装在的核心方法在XmlBeanDefinitionReader#registerBeanDefinitions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">		BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">		<span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">		documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">		<span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于properties资源装载spring-bean配置元信息"><a class="markdownIt-Anchor" href="#基于properties资源装载spring-bean配置元信息"></a> 基于Properties资源装载Spring Bean配置元信息</h2>
<p>Spring Bean 配置元信息</p>
<table>
<thead>
<tr>
<th>Properties属性名</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>(class)</td>
<td>Bean类全称限定名</td>
</tr>
<tr>
<td>(abstract)</td>
<td>是否为抽象的BeanDefinition</td>
</tr>
<tr>
<td>(parent)</td>
<td>指定parent BeanDefinition名称</td>
</tr>
<tr>
<td>(lazy-init)</td>
<td>是否为延迟初始化</td>
</tr>
<tr>
<td>(ref)</td>
<td>应用其他Bean的名称</td>
</tr>
<tr>
<td>(scope)</td>
<td>设置Bean的scope属性</td>
</tr>
<tr>
<td>${n}</td>
<td>n表示第n+1个构造器参数</td>
</tr>
</tbody>
</table>
<blockquote>
<p>底层实现：PropertiesBeanDefinitionReader</p>
</blockquote>
<p>接下来我们定义一个properties文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># User BeanDefinition 定义</span><br><span class="line">user.(<span class="class"><span class="keyword">class</span>) </span>= org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User</span><br><span class="line">user.id = <span class="number">1</span></span><br><span class="line">user.name = jiyongchao</span><br><span class="line">user.city = HANGZHOU</span><br></pre></td></tr></table></figure>
<p>尝试获取解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesBeanDefinitionReaderDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        PropertiesBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> PropertiesBeanDefinitionReader(beanFactory);</span><br><span class="line">        String location = <span class="string">&quot;classpath:/META-INF/users-config-definitions.properties&quot;</span>;</span><br><span class="line">        <span class="comment">// 默认通过ISO-8859-1</span></span><br><span class="line">        ResourceLoader resourceLoader = <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line">        <span class="comment">// 通过指定的Classpath获取Resource对象</span></span><br><span class="line">        Resource resource = resourceLoader.getResource(location);</span><br><span class="line">        <span class="comment">// 转换成带字符编码的EncodedResource对象</span></span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(resource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> i = beanDefinitionReader.loadBeanDefinitions(encodedResource);</span><br><span class="line">        System.out.printf(<span class="string">&quot;已加载%d 个BeanDefinition\n&quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        User user = beanFactory.getBean(User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关核心代码在PropertiesBeanDefinitionReader#loadBeanDefinitions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource, <span class="meta">@Nullable</span> String prefix)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(<span class="string">&quot;Loading properties bean definitions from &quot;</span> + encodedResource);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> (InputStream is = encodedResource.getResource().getInputStream()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				getPropertiesPersister().load(props, <span class="keyword">new</span> InputStreamReader(is, encodedResource.getEncoding()));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				getPropertiesPersister().load(props, is);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> count = registerBeanDefinitions(props, prefix, encodedResource.getResource().getDescription());</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Loaded &quot;</span> + count + <span class="string">&quot; bean definitions from &quot;</span> + encodedResource);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> count;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;Could not parse properties from &quot;</span> + encodedResource.getResource(), ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用properties的方式读取BeanDefinition的时候，如果出现Bean重复定义的情况，Spring会忽略后面定义的Bean的相关信息。</p>
</blockquote>
<h2 id="基于java注解的spring-bean配置元信息"><a class="markdownIt-Anchor" href="#基于java注解的spring-bean配置元信息"></a> 基于Java注解的Spring Bean配置元信息</h2>
<p>Spring模式注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Repository</td>
<td>数据仓储模式注解</td>
<td>2.0</td>
</tr>
<tr>
<td>@Component</td>
<td>通用组件模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Service</td>
<td>服务模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Controller</td>
<td>Web控制器模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Configuration</td>
<td>配置类模式注解</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<p>由于注解是不能集成的，所以采用元注解（元标注的方式来实现），其他注解都可以看成是<code>@Component</code>的&quot;派生&quot;注解。</p>
<p>Spring Bean依赖注入注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Autowired</td>
<td>Bean依赖注入，支持多种依赖查找的方式</td>
<td>2.5</td>
</tr>
<tr>
<td>@Qualifier</td>
<td>细粒度的@Autowired依赖查找</td>
<td>2.5</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Java注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Resource</td>
<td>类似于@Autowired</td>
<td>2.5</td>
</tr>
<tr>
<td>@Inject</td>
<td>类似于@Autowired</td>
<td>2.5</td>
</tr>
</tbody>
</table>
<p>Spring Bean条件装配注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Profile</td>
<td>配置化条件装配</td>
<td>3.1</td>
</tr>
<tr>
<td>@Conditional</td>
<td>编程条件装配</td>
<td>4.0</td>
</tr>
</tbody>
</table>
<p>我们可以看一下@Profile注解的@Conditional：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">		MultiValueMap&lt;String, Object&gt; attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());</span><br><span class="line">		<span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Object value : attrs.get(<span class="string">&quot;value&quot;</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (context.getEnvironment().acceptsProfiles(Profiles.of((String[]) value))) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是Spring Bean声明周期回调注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@PostConstruct</td>
<td>替换XML标签或者实现接口</td>
<td>2.5</td>
</tr>
<tr>
<td>@PreDestory</td>
<td>替换XML标签或者实现接口</td>
<td>2.5</td>
</tr>
</tbody>
</table>
<h2 id="spring-bean配置元信息底层实现"><a class="markdownIt-Anchor" href="#spring-bean配置元信息底层实现"></a> Spring Bean配置元信息底层实现</h2>
<p>Spring BeanDefinition解析与注册的方式：</p>
<table>
<thead>
<tr>
<th>实现场景</th>
<th>实现类</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>XML资源</td>
<td>XmlBeanDefinitionReader</td>
<td>1.0</td>
</tr>
<tr>
<td>Properties</td>
<td>PropertiesBeanDefinitionReader</td>
<td>1.0</td>
</tr>
<tr>
<td>Java注解</td>
<td>AnnotatedBeanDefinitionReader</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<blockquote>
<p>需要注意的是AnnotatedBeanDefinitionReader与BeanDefinition并没有任何直接的关系，而XmlBeanDefinitionReader和PropertiesBeanDefinitionReader都继承了AbstractBeanDefinitionReader。</p>
</blockquote>
<h3 id="xml资源的方式"><a class="markdownIt-Anchor" href="#xml资源的方式"></a> XML资源的方式</h3>
<p>Spring XML资源BeanDefinition解析与注册：</p>
<ul>
<li>核心API - XmlBeanDefinitionReader</li>
<li>底层 - BeanDefinitionDocumentReader
<ul>
<li>XML解析 - Java DOM Level 3 API</li>
<li>BeanDefinition 解析  - BeanDefinitionParserDelegate</li>
<li>BeanDefinition注册 - BeanDefinitionRegistry</li>
</ul>
</li>
</ul>
<blockquote>
<p>BeanDefinitionDocumentReader有且仅有一个实现，DefaultBeanDefinitionDocumentReader，它里面的preProcessXml和postProcessXml方法都是空实现，可以让我们在加载XML资源的前后做一些自定义的操作，使用的时候只需要继承DefaultBeanDefinitionDocumentReader，然后设置XmlBeanDefinitionReader所使用的加载类。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;? extends BeanDefinitionDocumentReader&gt; documentReaderClass =</span><br><span class="line">			DefaultBeanDefinitionDocumentReader.class;</span><br></pre></td></tr></table></figure>
<h3 id="properties资源的方式"><a class="markdownIt-Anchor" href="#properties资源的方式"></a> Properties资源的方式</h3>
<p>Spring Properties资源BeanDefinition解析与注册：</p>
<ul>
<li>核心API - PropertiesBeanDefinitionReader
<ul>
<li>资源
<ul>
<li>字节流 - Resource</li>
<li>字符流 - EncodedResource</li>
</ul>
</li>
<li>底层
<ul>
<li>存储 - java.util.Properties</li>
<li>BeanDefinition解析 - API内部实现</li>
<li>BeanDefinition注册 - BeanDefinitionRegistry</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>通过这种方式装在的Bean的名称就是&quot;.&quot;之前的字符。</p>
</blockquote>
<h3 id="java注解的方式"><a class="markdownIt-Anchor" href="#java注解的方式"></a> Java注解的方式</h3>
<p>Spring Java注册BeanDefintiion解析与注册：</p>
<ul>
<li>核心API - AnnotatedBeanDefinitionReader
<ul>
<li>资源
<ul>
<li>类对象 - java.lang.Class</li>
</ul>
</li>
<li>底层
<ul>
<li>条件评估 - ConditionEvaluator</li>
<li>Bean范围解析 - ScopeMetadataResolver</li>
<li>BeanDefinition解析 - 内部API实现</li>
<li>BeanDefinition处理 - AnnotationConfigUtils.processCommonDefinitionAnnotations</li>
<li>BeanDefinition注册 - BeanDefinitionRegistry</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>实现的核心源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">doRegisterBean</span><span class="params">(Class&lt;T&gt; beanClass, <span class="meta">@Nullable</span> String name,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt;[] qualifiers, <span class="meta">@Nullable</span> Supplier&lt;T&gt; supplier,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@Nullable</span> BeanDefinitionCustomizer[] customizers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		AnnotatedGenericBeanDefinition abd = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(beanClass);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		abd.setInstanceSupplier(supplier);</span><br><span class="line">		ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);</span><br><span class="line">		abd.setScope(scopeMetadata.getScopeName());</span><br><span class="line">		String beanName = (name != <span class="keyword">null</span> ? name : <span class="keyword">this</span>.beanNameGenerator.generateBeanName(abd, <span class="keyword">this</span>.registry));</span><br><span class="line">		<span class="comment">// 如果Bean上面有@Lazy或者@Primary等等，这个方法会把相关的信息赋值给BeanDefinition</span></span><br><span class="line">		AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);</span><br><span class="line">		<span class="keyword">if</span> (qualifiers != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;? extends Annotation&gt; qualifier : qualifiers) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Primary.class == qualifier) &#123;</span><br><span class="line">					abd.setPrimary(<span class="keyword">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (Lazy.class == qualifier) &#123;</span><br><span class="line">					abd.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					abd.addQualifier(<span class="keyword">new</span> AutowireCandidateQualifier(qualifier));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (customizers != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (BeanDefinitionCustomizer customizer : customizers) &#123;</span><br><span class="line">				customizer.customize(abd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(abd, beanName);</span><br><span class="line">		definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">		BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于xml资源装载spring-容器配置元信息"><a class="markdownIt-Anchor" href="#基于xml资源装载spring-容器配置元信息"></a> 基于XML资源装载Spring 容器配置元信息</h2>
<p>Spring IoC容器相关XML配置：</p>
<table>
<thead>
<tr>
<th>命名空间</th>
<th>所属模块</th>
<th>Schema资源URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>beans</td>
<td>spring-beans</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/beans/spring-beans.xsd">http://www.springframework.org/schema/beans/spring-beans.xsd</a></td>
</tr>
<tr>
<td>context</td>
<td>spring-context</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/context/beans/spring-context.xsd">http://www.springframework.org/schema/context/beans/spring-context.xsd</a></td>
</tr>
<tr>
<td>aop</td>
<td>spring-aop</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/aop/spring-aop.xsd">http://www.springframework.org/schema/aop/spring-aop.xsd</a></td>
</tr>
<tr>
<td>tx</td>
<td>spring-tx</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/tx/spring-tx.xsd">http://www.springframework.org/schema/tx/spring-tx.xsd</a></td>
</tr>
<tr>
<td>util</td>
<td>spring-util</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/util/spring-util.xsd">http://www.springframework.org/schema/util/spring-util.xsd</a></td>
</tr>
<tr>
<td>tool</td>
<td>spring-beans</td>
<td><a target="_blank" rel="noopener" href="http://www.springframework.org/schema/tool/spring-tool.xsd">http://www.springframework.org/schema/tool/spring-tool.xsd</a></td>
</tr>
</tbody>
</table>
<blockquote>
<p>如果需要支持事务，需要单独引入spring-tx。</p>
</blockquote>
<h2 id="基于java注解配置spring-容器配置元信息"><a class="markdownIt-Anchor" href="#基于java注解配置spring-容器配置元信息"></a> 基于Java注解配置Spring 容器配置元信息</h2>
<p>Spring IoC容器装配注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@ImportResource</td>
<td>替换XML元素<import></td>
<td>3.0</td>
</tr>
<tr>
<td>@Import</td>
<td>导入Configuration Class</td>
<td>3.0</td>
</tr>
<tr>
<td>@ComponenetScan</td>
<td>扫描指定package下标注Spring模式注解的类</td>
<td>3.1</td>
</tr>
</tbody>
</table>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource(&quot;classpath:/META-INF/dependency-lookup-context.xml&quot;)</span></span><br><span class="line"><span class="meta">@Import(User.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedSpringIoCContainerConfigurationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(AnnotatedSpringIoCContainerConfigurationDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        Map&lt;String, User&gt; userMap = context.getBeansOfType(User.class);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, User&gt; entry : userMap.entrySet()) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;User Bean name:%s,content: %s \n&quot;</span>, entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring IoC配置属性注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@PropertySource</td>
<td>配置属性抽象PropertySource注解</td>
<td>3.1</td>
</tr>
<tr>
<td>@PropertySources</td>
<td>@PropertySource集合注解</td>
<td>4.0</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PropertySource(&quot;classpath:/META-INF/users-config-definitions.properties&quot;)</span> <span class="comment">//Java8 + @Repeatable</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:/META-INF/users-config-definitions.properties&quot;)</span></span><br><span class="line"><span class="comment">//@PropertySources(@PropertySource(value = &quot;1&quot;))</span></span><br></pre></td></tr></table></figure>
<h2 id="基于extensible-xml-authoring扩展spring-xml元素"><a class="markdownIt-Anchor" href="#基于extensible-xml-authoring扩展spring-xml元素"></a> 基于Extensible XML authoring扩展Spring XML元素</h2>
<p>Spring XML扩展的步骤：</p>
<ol>
<li>编写XML Schema文件：定义XML结构</li>
<li>自定义NamespaceHandler实现：命名空间绑定</li>
<li>定义BeanDefinitionParser实现：XML元素与BeanDefinition解析</li>
<li>注册XML扩展：命名空间与XML Schema映射</li>
</ol>
<p>定义XML结构：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:users</span>=<span class="string">&quot;http://jycoder.org/schema/users&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://jycoder.org/schema/users&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">users:user</span> <span class="attr">id</span>=<span class="string">&quot;1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;jiyongchao&quot;</span> <span class="attr">city</span>=<span class="string">&quot;SHANGHAI&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>命名空间绑定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将&quot;user&quot;元素注册对应的BeanDefinitionParser实现</span></span><br><span class="line">        registerBeanDefinitionParser(<span class="string">&quot;user&quot;</span>,<span class="keyword">new</span> UserBeanDefinitionParser());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XML元素与BeanDefinition解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">        <span class="keyword">return</span> User.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, ParserContext parserContext, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        setPropertyValue(<span class="string">&quot;id&quot;</span>, element, builder);</span><br><span class="line">        setPropertyValue(<span class="string">&quot;name&quot;</span>, element, builder);</span><br><span class="line">        setPropertyValue(<span class="string">&quot;City&quot;</span>, element, builder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(String attributeName, Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        String attributeValue = element.getAttribute(attributeName);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(attributeValue)) &#123;</span><br><span class="line">            builder.addPropertyValue(attributeName, attributeValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>命名空间与XML Schema映射：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义namespacehanlder</span></span><br><span class="line"><span class="meta">http\://jycoder.org/schema/users</span>=<span class="string">org.jyc.thinking.in.spring.bean.metadata.UsersNamespaceHandler</span></span><br></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">http\://jycoder.org/schema/users.xsd</span>=<span class="string">org/jyc/thinking/in/spring/bean/metadata/users.xsd</span></span><br></pre></td></tr></table></figure>
<p>测试我们编写的案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtensibleXmlAuthoringDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        reader.loadBeanDefinitions(<span class="string">&quot;classpath:/META-INF/users-context.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取User Bean对象</span></span><br><span class="line">        User user = beanFactory.getBean(User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于properties资源装载外部化配置"><a class="markdownIt-Anchor" href="#基于properties资源装载外部化配置"></a> 基于Properties资源装载外部化配置</h2>
<ol>
<li>注解驱动：
<ul>
<li>org.springframework.context.annotation.PropertySource</li>
<li>org.springframework.context.annotation.PropertySources</li>
</ul>
</li>
<li>API编程：
<ul>
<li>org.springframework.core.env.PropertySource</li>
<li>org.springframework.core.env.PropertySources</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PropertySource(&quot;classpath:/META-INF/users-config-definitions.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertySourceDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">(<span class="meta">@Value(&quot;$&#123;user.id&#125;&quot;)</span> String id, <span class="meta">@Value(&quot;$&#123;user.name&#125;&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(id);</span><br><span class="line">        user.setName(name);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 扩展Environment中的PropertySources</span></span><br><span class="line">        <span class="comment">// 添加PropertySources操作必须在refresh方法之前完成</span></span><br><span class="line">        Map&lt;String, Object&gt; propertiesSource = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        propertiesSource.put(<span class="string">&quot;user.name&quot;</span>, <span class="string">&quot;xiao ji&quot;</span>);</span><br><span class="line">        org.springframework.core.env.PropertySource propertySource = <span class="keyword">new</span> MapPropertySource(<span class="string">&quot;first-property-source&quot;</span>, propertiesSource);</span><br><span class="line">        context.getEnvironment().getPropertySources().addFirst(propertySource);</span><br><span class="line">        context.register(AnnotatedSpringIoCContainerConfigurationDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        Map&lt;String, User&gt; userMap = context.getBeansOfType(User.class);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, User&gt; entry : userMap.entrySet()) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;User Bean name:%s,content: %s \n&quot;</span>, entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(context.getEnvironment().getPropertySources());</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于yml资源装载外部化配置"><a class="markdownIt-Anchor" href="#基于yml资源装载外部化配置"></a> 基于yml资源装载外部化配置</h2>
<p>使用API编程：</p>
<ul>
<li>org.springframework.beans.factory.config.YamlProcessor
<ul>
<li>org.springframework.beans.factory.config.YamlMapFactoryBean</li>
<li>org.springframework.beans.factory.config.YamlPropertiesFactoryBean</li>
</ul>
</li>
</ul>
<p>定义YAML文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user:</span></span><br><span class="line">  <span class="attr">id:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">吉永超</span></span><br></pre></td></tr></table></figure>
<p>定义XML文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;yamlMap&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.YamlMapFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;resources&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:/META-INF/user.yaml&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试我们的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBasedYamlPropertySourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">        reader.loadBeanDefinitions(<span class="string">&quot;classpath:/META-INF/yaml-property-source-context.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取User Bean对象</span></span><br><span class="line">        User user = beanFactory.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PropertySource默认是没有yaml格式的实现的，我们可以自己实现一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YamlPropertySourceFactory</span> <span class="keyword">implements</span> <span class="title">PropertySourceFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertySource&lt;?&gt; createPropertySource(String name, EncodedResource resource) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        YamlPropertiesFactoryBean yamlPropertiesFactoryBean = <span class="keyword">new</span> YamlPropertiesFactoryBean();</span><br><span class="line">        yamlPropertiesFactoryBean.setResources(resource.getResource());</span><br><span class="line">        Properties yamlProperties = yamlPropertiesFactoryBean.getObject();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PropertiesPropertySource(name, yamlProperties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用YAML的方式装载外部化配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PropertySource(name = &quot;yamlPropertySource&quot;,</span></span><br><span class="line"><span class="meta">        value = &quot;classpath:/META-INF/user.yaml&quot;,</span></span><br><span class="line"><span class="meta">        factory = YamlPropertySourceFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedYamlPropertySourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">(<span class="meta">@Value(&quot;$&#123;user.id&#125;&quot;)</span> String id, <span class="meta">@Value(&quot;$&#123;user.name&#125;&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(id);</span><br><span class="line">        user.setName(name);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(AnnotatedYamlPropertySourceDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        User user = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-10"><a class="markdownIt-Anchor" href="#面试题-10"></a> 面试题</h2>
<h3 id="spring内建的xml-schema常见有哪些"><a class="markdownIt-Anchor" href="#spring内建的xml-schema常见有哪些"></a> Spring内建的XML Schema常见有哪些？</h3>
<p>见基于XML资源装载Spring 容器配置元信息章节表格。</p>
<h3 id="spring配置元信息有哪些"><a class="markdownIt-Anchor" href="#spring配置元信息有哪些"></a> Spring配置元信息有哪些？</h3>
<ul>
<li>Bean配置元信息：通过媒介（如XML、Properties）等，解析BeanDefinition</li>
<li>IoC容器配置元信息：通过媒介（如XML、Properties等），控制IoC容器行为，比如注解驱动，AOP等</li>
<li>外部化配置：通过资源抽象（如Properties、YAML等），控制PropertySource</li>
<li>Spring Profile：通过外部化配置，提供条件分支流程</li>
</ul>
<h3 id="extensible-xml-authoring的缺点"><a class="markdownIt-Anchor" href="#extensible-xml-authoring的缺点"></a> Extensible XML authoring的缺点？</h3>
<ul>
<li>高复杂度：开发人员需要熟悉XML schema、Spring.handlers，Spring.schemas以及Spring API</li>
<li>嵌套元素支持较弱：通常需要使用方法递归或者嵌套解析的方式处理嵌套（子）元素</li>
<li>XML处理性能较差：Spring XML基于DOM Levels API 实现，该API便于理解，然而性能较差</li>
<li>XML框架移植性较差：很难适配高性能和便利性的XML框架，如JAXB。</li>
</ul>
<h1 id="spring-资源管理"><a class="markdownIt-Anchor" href="#spring-资源管理"></a> Spring 资源管理</h1>
<blockquote>
<p>为什么Spring不使用Java标准资源管理，而选择重新发明轮子？</p>
<ul>
<li>Java标准资源管理强大，然而扩展复杂，资源存储方式并不统一</li>
<li>Spring要自立门户</li>
<li>Spring “抄”、“超”、“潮”</li>
</ul>
</blockquote>
<h2 id="java标准资源管理"><a class="markdownIt-Anchor" href="#java标准资源管理"></a> Java标准资源管理</h2>
<p>Java标准资源定位：</p>
<table>
<thead>
<tr>
<th>职责</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>面向资源</td>
<td>文件系统、artifact（jar、war、ear文件）以及远程资源（HTTP、FTP等）</td>
</tr>
<tr>
<td>API整合</td>
<td>java.lang.ClassLoader#getResource、java.io.File或java.net.URL</td>
</tr>
<tr>
<td>资源定位</td>
<td>java.net.URL或java.net.URI</td>
</tr>
<tr>
<td>面向流失存储</td>
<td>java.net.URLConnection</td>
</tr>
<tr>
<td>协议扩展</td>
<td>java.net.URLStreamHandler或java.net.URLStreamHandleFactory</td>
</tr>
</tbody>
</table>
<h2 id="resource接口"><a class="markdownIt-Anchor" href="#resource接口"></a> Resource接口</h2>
<p>资源接口：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>输入流</td>
<td>org.springframework.core.io.InputStreamResource</td>
</tr>
<tr>
<td>只读资源</td>
<td>org.springframework.core.io.Resource</td>
</tr>
<tr>
<td>可写资源</td>
<td>org.springframework.core.io.WritableResource</td>
</tr>
<tr>
<td>编码资源</td>
<td>org.springframework.core.io.support.EncodedResource</td>
</tr>
<tr>
<td>上下文资源</td>
<td>org.springframework.core.io.ContextResource</td>
</tr>
</tbody>
</table>
<h2 id="内建的resource实现"><a class="markdownIt-Anchor" href="#内建的resource实现"></a> 内建的Resource实现</h2>
<p>内建实现：</p>
<table>
<thead>
<tr>
<th>资源来源</th>
<th>资源协议</th>
<th>实现类</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bean定义</td>
<td>无</td>
<td>org.springframework.beans.factory.support.BeanDefinitionResource</td>
</tr>
<tr>
<td>数组</td>
<td>无</td>
<td>org.springframework.core.io.ByteArrayResource</td>
</tr>
<tr>
<td>类路径</td>
<td>classpath:/</td>
<td>org.springframework.core.io.ClassPathResource</td>
</tr>
<tr>
<td>文件系统</td>
<td>file:/</td>
<td>org.springframework.core.io.FileSystemResource</td>
</tr>
<tr>
<td>URL</td>
<td>URL支持的协议</td>
<td>org.springframework.core.io.UrlResource</td>
</tr>
<tr>
<td>ServletContext</td>
<td>无</td>
<td>org.springframework.web.context.support.ServletContextResource</td>
</tr>
</tbody>
</table>
<h2 id="resource接口扩展"><a class="markdownIt-Anchor" href="#resource接口扩展"></a> Resource接口扩展</h2>
<ol>
<li>可写资源接口
<ul>
<li>org.springframework.core.io.WritableResource
<ul>
<li>org.springframework.core.io.FileSystemResource</li>
<li>org.springframework.core.io.FileUrlResource（@since 5.0.2）</li>
<li>org.springframework.core.io.PathResource（@since 4.0 &amp; @Deprecated）</li>
</ul>
</li>
</ul>
</li>
<li>编码资源接口
<ul>
<li>org.springframework.core.io.support.EncodedResource</li>
</ul>
</li>
</ol>
<p>使用编码资源接口进行操作的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncodedFileSystemResourceDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String currentJavaFilePath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/bean-resource/src/main/java/org/jyc/thinking/in/spring/resource/EncodedFileSystemResourceDemo.java&quot;</span>;</span><br><span class="line">        File currentJavaFile = <span class="keyword">new</span> File(currentJavaFilePath);</span><br><span class="line">        FileSystemResource fileSystemResource = <span class="keyword">new</span> FileSystemResource(currentJavaFile);</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(fileSystemResource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 字符输入流</span></span><br><span class="line">        <span class="keyword">try</span> (Reader reader = encodedResource.getReader()) &#123;</span><br><span class="line">            System.out.println(IOUtils.toString(reader));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring资源加载器"><a class="markdownIt-Anchor" href="#spring资源加载器"></a> Spring资源加载器</h2>
<p>Resource加载器：</p>
<ul>
<li>org.springframework.core.io.ResourceLoader
<ul>
<li>org.springframework.core.io.DefaultResourceLoader</li>
<li>org.springframework.core.io.FileSystemResourceLoader</li>
<li>org.springframework.core.io.ClassRelativeResourceLoader</li>
<li>org.springframework.context.support.AbstractApplicationContext</li>
</ul>
</li>
</ul>
<p>使用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncodedFileSystemResourceLoaderDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String currentJavaFilePath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/bean-resource/src/main/java/org/jyc/thinking/in/spring/resource/EncodedFileSystemResourceLoaderDemo.java&quot;</span>;</span><br><span class="line">        FileSystemResourceLoader resourceLoader = <span class="keyword">new</span> FileSystemResourceLoader();</span><br><span class="line">        Resource fileSystemResource = resourceLoader.getResource(currentJavaFilePath);</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(fileSystemResource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 字符输入流</span></span><br><span class="line">        <span class="keyword">try</span> (Reader reader = encodedResource.getReader()) &#123;</span><br><span class="line">            System.out.println(IOUtils.toString(reader));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring通配路径资源加载器"><a class="markdownIt-Anchor" href="#spring通配路径资源加载器"></a> Spring通配路径资源加载器</h2>
<ol>
<li>通配路径ResourceLoader
<ul>
<li>org.springframework.core.io.support.ResourcePatternResolver</li>
<li>org.springframework.core.io.support.PathMatchingResourcePatternResolver</li>
</ul>
</li>
<li>路径匹配器
<ul>
<li>org.springframework.util.PathMatcher
<ul>
<li>Ant模式匹配实现 - org.springframework.util.AntPathMatcher</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="spring通配路径资源扩展"><a class="markdownIt-Anchor" href="#spring通配路径资源扩展"></a> Spring通配路径资源扩展</h2>
<ol>
<li>实现org.springframework.util.PathMatcher</li>
<li>重置PathMatcher
<ul>
<li>PathMatchingResourcePatternResolver#setPathMatcher</li>
</ul>
</li>
</ol>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizedResourcePatternResolver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 读取当前package对应的所有的.java文件</span></span><br><span class="line">        <span class="comment">// *.java</span></span><br><span class="line">        String currentPackagePath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/bean-resource/src/main/java/org/jyc/thinking/in/spring/resource/&quot;</span>;</span><br><span class="line">        String locationPattern = currentPackagePath + <span class="string">&quot;*.java&quot;</span>;</span><br><span class="line">        PathMatchingResourcePatternResolver resourcePatternResolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver(<span class="keyword">new</span> FileSystemResourceLoader());</span><br><span class="line"></span><br><span class="line">        resourcePatternResolver.setPathMatcher(<span class="keyword">new</span> JavaFilePathMatcher());</span><br><span class="line">        Resource[] resources = resourcePatternResolver.getResources(locationPattern);</span><br><span class="line">        Stream.of(resources).map(ResourceUtils::getContent).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaFilePathMatcher</span> <span class="keyword">implements</span> <span class="title">PathMatcher</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPattern</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> path.endsWith(<span class="string">&quot;.java&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(String pattern, String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> path.endsWith(<span class="string">&quot;.java&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matchStart</span><span class="params">(String pattern, String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">extractPathWithinPattern</span><span class="params">(String pattern, String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">extractUriTemplateVariables</span><span class="params">(String pattern, String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Comparator&lt;String&gt; <span class="title">getPatternComparator</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">combine</span><span class="params">(String pattern1, String pattern2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中使用到的工具类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getContent</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getContent(resource, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getContent</span><span class="params">(Resource resource, String encoding)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(resource, encoding);</span><br><span class="line">        <span class="keyword">try</span> (Reader reader = encodedResource.getReader()) &#123;</span><br><span class="line">            <span class="keyword">return</span> IOUtils.toString(reader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖注入spring-resource"><a class="markdownIt-Anchor" href="#依赖注入spring-resource"></a> 依赖注入Spring Resource</h2>
<p>可以基于@Value实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;classpath:/...&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Resource resource;</span><br></pre></td></tr></table></figure>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectResourceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/META-INF/default.properties&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource defaultPropertiesResource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath*:/META-INF/*.properties&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource[] PropertiesResources;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.dir&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String currentProjectRootPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(ResourceUtils.getContent(defaultPropertiesResource));</span><br><span class="line">        System.out.println(currentProjectRootPath);</span><br><span class="line">        Stream.of(PropertiesResources).map(ResourceUtils::getContent).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(InjectResourceDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 关闭应用上下文</span></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖注入resourceloader"><a class="markdownIt-Anchor" href="#依赖注入resourceloader"></a> 依赖注入ResourceLoader</h2>
<p>有多种方式可以依赖注入ResourceLoader：</p>
<ol>
<li>实现ResourceLoaderAware回调</li>
<li>@Autowired注入ResourceLoader</li>
<li>注入ApplicationContext作为ResourceLoader</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectResourceLoaderDemo</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader awareResourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ResourceLoader autowiredResourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AbstractApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;awareResourceLoader == autowiredResourceLoader: &quot;</span> + (autowiredResourceLoader == awareResourceLoader));</span><br><span class="line">        System.out.println(<span class="string">&quot;autowiredResourceLoader == applicationContext: &quot;</span> + (awareResourceLoader == applicationContext));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        applicationContext.register(InjectResourceLoaderDemo.class);</span><br><span class="line">        applicationContext.refresh();</span><br><span class="line">        <span class="comment">// 关闭应用上下文</span></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.awareResourceLoader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这三种不同的方式最终注入的是相同的对象，都是AbstractApplicationContext。</p>
</blockquote>
<h2 id="面试题-11"><a class="markdownIt-Anchor" href="#面试题-11"></a> 面试题</h2>
<h3 id="spring配置资源中有哪些常见类型"><a class="markdownIt-Anchor" href="#spring配置资源中有哪些常见类型"></a> Spring配置资源中有哪些常见类型？</h3>
<p>XML资源、Properties资源、YAML资源。</p>
<h3 id="请举例不同类型的spring配置资源"><a class="markdownIt-Anchor" href="#请举例不同类型的spring配置资源"></a> 请举例不同类型的Spring配置资源</h3>
<p>XML资源：</p>
<ol>
<li>普通的BeanDefinition XML资源配置 - *.xml</li>
<li>Spring Schema资源 - *.xsd</li>
</ol>
<p>Properties资源：</p>
<ol>
<li>普通Properties格式资源 - *.properties</li>
<li>Spring Handler实现类映射文件 - META/spring.handlers</li>
<li>Spring Schema资源映射文件 - META-INF/spring.schemas</li>
</ol>
<p>YAML资源：</p>
<ol>
<li>普通YAML资源配置 - *.yaml或 *.yml</li>
</ol>
<h3 id="java标准资源管理扩展的步骤"><a class="markdownIt-Anchor" href="#java标准资源管理扩展的步骤"></a> Java标准资源管理扩展的步骤</h3>
<p>简易实现：</p>
<ul>
<li>实现URLStreamHandler并放置再sun.net.www.protocol.${protocol}.Handler包下</li>
</ul>
<p>自定义实现：</p>
<ul>
<li>实现URLStreamHandler</li>
<li>添加 -Djava.protocol.handler.pkgs启动参数，指向URLStreamHandler实现类的包下</li>
</ul>
<p>高级实现：</p>
<ul>
<li>实现URLStreamHandlerFactory并传递到URL之中</li>
</ul>
<h1 id="spring-国际化"><a class="markdownIt-Anchor" href="#spring-国际化"></a> Spring 国际化</h1>
<p>Spring国际化使用场景：</p>
<ul>
<li>普通国际化文案</li>
<li>Bean Validation校验国际化文案</li>
<li>Web站点页面渲染</li>
<li>Web MVC错误消息提示</li>
</ul>
<h2 id="spring国际化接口"><a class="markdownIt-Anchor" href="#spring国际化接口"></a> Spring国际化接口</h2>
<p>核心接口：</p>
<ul>
<li>org.springframework.context.MessageSource</li>
</ul>
<p>主要概念：</p>
<ul>
<li>文案模板编码（code）</li>
<li>文案模板参数（args）</li>
<li>区域（Locale）</li>
</ul>
<h2 id="层次性的messagesource"><a class="markdownIt-Anchor" href="#层次性的messagesource"></a> 层次性的MessageSource</h2>
<p>Spring层次性国际化接口：</p>
<ul>
<li>org.springframework.context.HierarchicalMessageSource</li>
</ul>
<h2 id="java国际化标准实现"><a class="markdownIt-Anchor" href="#java国际化标准实现"></a> Java国际化标准实现</h2>
<p>核心接口：</p>
<ul>
<li>抽象实现 - java.util.ResourceBundle</li>
<li>Properties资源实现 - java.util.PropertyResourceBundle</li>
<li>列举实现 - java.util.ListResourceBundle</li>
</ul>
<p>ResourceBundle核心特性：</p>
<ul>
<li>Key - Value设计</li>
<li>层次性设计</li>
<li>缓存设计</li>
<li>字符编码控制 - java.util.ResourceBundle.Control（@since 1.6）</li>
<li>Control SPI扩展 - java.util.spi.ResourceBundleControlProvider（@since 1.8）</li>
</ul>
<h2 id="java文本格式化"><a class="markdownIt-Anchor" href="#java文本格式化"></a> Java文本格式化</h2>
<p>核心接口：</p>
<ul>
<li>java.text.MessageFormat</li>
</ul>
<p>基本用法：</p>
<ul>
<li>设置消息格式模式 - new MessageFormat(…)</li>
<li>格式化 - format(new Objectp[]{…})</li>
</ul>
<p>消息格式模式：</p>
<ul>
<li>格式元素：{ArgumentIndex（,FormatType,（FormatStyle））}</li>
<li>FormatType：消息格式类型，可选项，每种类型在number、date、time和choice类型选其一</li>
<li>FormatStyle：消息格式风格，可选项，包括：short、medium、long、full、integer、currency、percent</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageFormatDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> planet = <span class="number">7</span>;</span><br><span class="line">        String event = <span class="string">&quot;a disturbance in the Force&quot;</span>;</span><br><span class="line"></span><br><span class="line">        String result = MessageFormat.format(</span><br><span class="line">                <span class="string">&quot;At &#123;1,time,long&#125; on &#123;1,date&#125;, there was &#123;2&#125; on planet &#123;0,number,integer&#125;.&quot;</span>,</span><br><span class="line">                planet, <span class="keyword">new</span> Date(), event);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java文本格式化还有一些高级特性：</p>
<ul>
<li>重置消息格式模板</li>
<li>重置java.util.Locale</li>
<li>重置java.text.Format</li>
</ul>
<p>使用的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageFormatDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> planet = <span class="number">7</span>;</span><br><span class="line">        String event = <span class="string">&quot;a disturbance in the Force&quot;</span>;</span><br><span class="line"></span><br><span class="line">        String messageFormatPattern = <span class="string">&quot;At &#123;1,time,long&#125; on &#123;1,date&#125;, there was &#123;2&#125; on planet &#123;0,number,integer&#125;.&quot;</span>;</span><br><span class="line">        MessageFormat messageFormat = <span class="keyword">new</span> MessageFormat(messageFormatPattern);</span><br><span class="line">        String result = messageFormat.format(<span class="keyword">new</span> Object[]&#123;planet, <span class="keyword">new</span> Date(), event&#125;);</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置MessageFormatPattern</span></span><br><span class="line">        messageFormatPattern = <span class="string">&quot;This is a text: &#123;0&#125;,&#123;1&#125;,&#123;2&#125;&quot;</span>;</span><br><span class="line">        messageFormat.applyPattern(messageFormatPattern);</span><br><span class="line">        result = messageFormat.format(<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;hello,world&quot;</span>, <span class="string">&quot;666&quot;</span>&#125;);</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置Locale</span></span><br><span class="line">        messageFormat.setLocale(Locale.ENGLISH);</span><br><span class="line">        messageFormatPattern = <span class="string">&quot;At &#123;1,time,long&#125; on &#123;1,date&#125;, there was &#123;2&#125; on planet &#123;0,number,integer&#125;.&quot;</span>;</span><br><span class="line">        messageFormat.applyPattern(messageFormatPattern);</span><br><span class="line">        result = messageFormat.format(<span class="keyword">new</span> Object[]&#123;planet, <span class="keyword">new</span> Date(), event&#125;);</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置Format</span></span><br><span class="line">        <span class="comment">// 根据参数索引来设置 Pattern</span></span><br><span class="line">        messageFormat.setFormat(<span class="number">1</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;YYYY-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">        result = messageFormat.format(<span class="keyword">new</span> Object[]&#123;planet, <span class="keyword">new</span> Date(), event&#125;);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="messagesource开箱实现"><a class="markdownIt-Anchor" href="#messagesource开箱实现"></a> MessageSource开箱实现</h2>
<p>基于ResourceBundle + MessageFormat组合MessageSource实现：</p>
<ul>
<li>org.springframework.context.support.ResourceBundleMessageSource</li>
</ul>
<p>可重载Properties + MessageFormat组合MessageSource实现：</p>
<ul>
<li>org.springframework.context.support.ReloadableResourceBundleMessageSource</li>
</ul>
<h2 id="message的内建依赖"><a class="markdownIt-Anchor" href="#message的内建依赖"></a> Message的内建依赖</h2>
<p>MessageSource内建Bean可能来源：</p>
<ul>
<li>预注册Bean名称为：“messageSource”，类型为：MessageSource Bean</li>
<li>默认内建实现 - DelegatingMessageSource
<ul>
<li>层次性查找MessageSource对象</li>
</ul>
</li>
</ul>
<p>相关的代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">		<span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">			<span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">				HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">				<span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">					<span class="comment">// registered already.</span></span><br><span class="line">					hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line">			DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">			dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">			<span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">			beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="springboot为什么要新建messagesource-bean"><a class="markdownIt-Anchor" href="#springboot为什么要新建messagesource-bean"></a> SpringBoot为什么要新建MessageSource Bean?</h2>
<ol>
<li>AbstractApplicationContext的实现决定了MessageSource内建实现</li>
<li>Spring Boot通过外部化配置简化了MessageSource Bean构建</li>
<li>SPring Boot基于Bean Validation校验非常普遍</li>
</ol>
<p>实际上我们可以覆盖SpringBoot中自动装配的MessageSource Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizedMessageSourceBeanDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在Spring Boot场景中，Primary Configure Sources（Classes）高于*AutoConfiguration</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = SpringApplication.run(CustomizedMessageSourceBeanDemo.class, args);</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = applicationContext.getBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(AbstractApplicationContext.MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.getBean(AbstractApplicationContext.MESSAGE_SOURCE_BEAN_NAME);</span><br><span class="line">            <span class="comment">// 查找MessageSource Bean</span></span><br><span class="line">            MessageSource messageSource = applicationContext.getBean(AbstractApplicationContext.MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">            System.out.println(messageSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-12"><a class="markdownIt-Anchor" href="#面试题-12"></a> 面试题</h2>
<h3 id="spring国际化接口有哪些"><a class="markdownIt-Anchor" href="#spring国际化接口有哪些"></a> Spring国际化接口有哪些？</h3>
<ol>
<li>核心接口 - MessageSource</li>
<li>层次性接口 - org.springframework.context.HierarchicalMessageSource</li>
</ol>
<h3 id="spring有哪些messagesource的内建实现"><a class="markdownIt-Anchor" href="#spring有哪些messagesource的内建实现"></a> Spring有哪些MessageSource的内建实现？</h3>
<ul>
<li>org.springframework.context.support.ResourceBundleMessageSource</li>
<li>org.springframework.context.support.ReloadableResourceBundleMessageSource</li>
<li>org.springframework.context.support.StaticMessageSource</li>
<li>org.springframework.context.support.DelegatingMessageSource</li>
</ul>
<h3 id="如何实现配置自动更新messagesource"><a class="markdownIt-Anchor" href="#如何实现配置自动更新messagesource"></a> 如何实现配置自动更新MessageSource？</h3>
<p>主要技术：</p>
<ul>
<li>Java NIO 2：java.nio.file.watchService</li>
<li>Java Concurrency：java.util.concurrent.ExecutorService</li>
<li>Spring：org.springframework.context.support.AbstractMessageSource</li>
</ul>
<h1 id="spring-校验"><a class="markdownIt-Anchor" href="#spring-校验"></a> Spring 校验</h1>
<p>Spring校验使用场景：</p>
<ul>
<li>Spring 常规校验（Validator）</li>
<li>Spring 数据绑定（DataBinder）</li>
<li>Spring Web参数绑定（WebDataBinder）</li>
<li>Spring WebMVC/WebFlux处理方法参数校验</li>
</ul>
<h2 id="validator接口设计"><a class="markdownIt-Anchor" href="#validator接口设计"></a> Validator接口设计</h2>
<p>接口职责：</p>
<ul>
<li>Spring内部校验接口，通过编程的方式校验目标对象</li>
</ul>
<p>核心方法：</p>
<ul>
<li>supports（Class）：校验目标类能否校验</li>
<li>validate（Object，Errors）：校验目标对象，并将校验失败的内容输出至Errors对象</li>
</ul>
<p>配套组件：</p>
<ul>
<li>错误收集器：org.springframework.validation.Errors</li>
<li>Validator工具类：org.springframework.validation.ValidationUtils</li>
</ul>
<p>在Java Doc中的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLoginValidator</span> <span class="keyword">implements</span> <span class="title">Validator</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MINIMUM_PASSWORD_LENGTH = <span class="number">6</span>;</span><br><span class="line">  </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> UserLogin.class.isAssignableFrom(clazz);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object target, Errors errors)</span> </span>&#123;</span><br><span class="line">         ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="string">&quot;userName&quot;</span>, <span class="string">&quot;field.required&quot;</span>);</span><br><span class="line">         ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;field.required&quot;</span>);</span><br><span class="line">         UserLogin login = (UserLogin) target;</span><br><span class="line">         <span class="keyword">if</span> (login.getPassword() != <span class="keyword">null</span></span><br><span class="line">               &amp;&amp; login.getPassword().trim().length() &lt; MINIMUM_PASSWORD_LENGTH) &#123;</span><br><span class="line">            errors.rejectValue(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;field.min.length&quot;</span>,</span><br><span class="line">                  <span class="keyword">new</span> Object[]&#123;Integer.valueOf(MINIMUM_PASSWORD_LENGTH)&#125;,</span><br><span class="line">                  <span class="string">&quot;The password must be at least [&quot;</span> + MINIMUM_PASSWORD_LENGTH + <span class="string">&quot;] characters in length.&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="errors接口设计"><a class="markdownIt-Anchor" href="#errors接口设计"></a> Errors接口设计</h2>
<p>接口职责：</p>
<ul>
<li>数据绑定和校验错误收集接口，与Java Bean和其属性有强关联性。</li>
</ul>
<p>核心方法：</p>
<ul>
<li>reject方法（重载）：收集错误文案</li>
<li>rejectValue方法（重载）：收集对象字段中的错误文案</li>
</ul>
<p>配套组件：</p>
<ul>
<li>Java Bean错误描述：org.springframework.validation.ObjectError</li>
<li>Java Bean属性错误描述：org.springframework.validation.FieldError</li>
</ul>
<h2 id="errors的文案来源"><a class="markdownIt-Anchor" href="#errors的文案来源"></a> Errors的文案来源</h2>
<p>Errors文案生成步骤：</p>
<ol>
<li>选择Errors实现（org.springframework.validation.BeanPropertyBindingResult）</li>
<li>调用reject方法或rejectValue方法</li>
<li>获取Errors对象中ObjectError或FieldError</li>
<li>将ObjectError或FieldError中的code和args，关联MessageSource实现（如：ResourceBundleMessageSource）</li>
</ol>
<p>使用的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorMessageDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建User对象</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="comment">// 2.选择Errors - BeanPropertyBindingResult</span></span><br><span class="line">        Errors errors = <span class="keyword">new</span> BeanPropertyBindingResult(user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 3.调用reject或者rejectValue</span></span><br><span class="line">        <span class="comment">// reject生成ObjectError</span></span><br><span class="line">        <span class="comment">// reject生成 FildError</span></span><br><span class="line">        errors.reject(<span class="string">&quot;user.properties.not.null&quot;</span>);</span><br><span class="line">        errors.rejectValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;name.required&quot;</span>);</span><br><span class="line">        <span class="comment">//4.FieldError is ObjectError</span></span><br><span class="line">        List&lt;ObjectError&gt; globalErrors = errors.getGlobalErrors();</span><br><span class="line">        FieldError fieldError = errors.getFieldError();</span><br><span class="line">        List&lt;ObjectError&gt; allErrors = errors.getAllErrors();</span><br><span class="line">        <span class="comment">// 5.通过ObjectError和FieldError中的code和args关联MessageSource实现</span></span><br><span class="line">        MessageSource messageSource = createMessageSource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ObjectError error : allErrors) &#123;</span><br><span class="line">            messageSource.getMessage(error.getCode(), error.getArguments(), Locale.getDefault());</span><br><span class="line">            System.out.println(messageSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MessageSource <span class="title">createMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StaticMessageSource staticMessageSource = <span class="keyword">new</span> StaticMessageSource();</span><br><span class="line">        staticMessageSource.addMessage(<span class="string">&quot;user.properties.not.null&quot;</span>, Locale.getDefault(), <span class="string">&quot;User 属性不能为空&quot;</span>);</span><br><span class="line">        staticMessageSource.addMessage(<span class="string">&quot;name.required&quot;</span>, Locale.getDefault(), <span class="string">&quot;name is not null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> staticMessageSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义validator"><a class="markdownIt-Anchor" href="#自定义validator"></a> 自定义Validator</h2>
<p>实现org.springframework.validation.Validator接口，具体操作如下：</p>
<ul>
<li>实现supports方法</li>
<li>实现validate方法
<ul>
<li>通过Errors对象收集错误
<ul>
<li>ObjectError：对象（Bean）错误：</li>
<li>FieldError：对象（Bean）属性（Property）错误</li>
</ul>
</li>
<li>通过ObjectError和FieldError关联MessageSource实现获取最终文案</li>
</ul>
</li>
</ul>
<p>自定义Validator的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建Validator</span></span><br><span class="line">        Validator validator = <span class="keyword">new</span> UserValodator();</span><br><span class="line">        <span class="comment">// 2.判断是否支持目标对象的类型</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        System.out.println(validator.supports(user.getClass()));</span><br><span class="line">        <span class="comment">// 3.创建Errors对象</span></span><br><span class="line">        Errors errors = <span class="keyword">new</span> BeanPropertyBindingResult(user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">        validator.validate(user, errors);</span><br><span class="line">        <span class="comment">// 4.获取MessageSource对象</span></span><br><span class="line">        MessageSource messageSource = createMessageSource();</span><br><span class="line">        <span class="comment">// 5.输出所有的错误文案</span></span><br><span class="line">        <span class="keyword">for</span> (ObjectError error : errors.getAllErrors()) &#123;</span><br><span class="line">            String message = messageSource.getMessage(error.getCode(), error.getArguments(), Locale.getDefault());</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserValodator</span> <span class="keyword">implements</span> <span class="title">Validator</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> User.class.equals(clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object target, Errors errors)</span> </span>&#123;</span><br><span class="line">            User user = (User) target;</span><br><span class="line">            ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="string">&quot;id&quot;</span>, <span class="string">&quot;id.required&quot;</span>);</span><br><span class="line">            ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;name.required&quot;</span>);</span><br><span class="line">            String name = user.getName();</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bean-validation"><a class="markdownIt-Anchor" href="#bean-validation"></a> Bean Validation</h2>
<p>Bean Validation 与 Validator适配：</p>
<ul>
<li>核心组件 - org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</li>
<li>依赖Bean Validation - JSR - 303 or JSR - 349 provider</li>
<li>Bean方法参数校验 - org.springframework.validation.beanvalidation.MethodValidationPostProcessor</li>
</ul>
<p>使用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBeanValidationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/bean-validation-context.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Validator validator = applicationContext.getBean(Validator.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(validator instanceof LocalValidatorFactoryBean);</span></span><br><span class="line">        UserProcessor userProcessor = applicationContext.getBean(UserProcessor.class);</span><br><span class="line">        userProcessor.processUser(<span class="keyword">new</span> User());</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="meta">@Validated</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProcessor</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processUser</span><span class="params">(<span class="meta">@Valid</span> User user)</span> </span>&#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Validated</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotNull</span></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的XML文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.jyc.thinking.in.spring.validation&quot;</span> /&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">&quot;validator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.validation.beanvalidation.LocalValidatorFactoryBean&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.validation.beanvalidation.MethodValidationPostProcessor&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;validator&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;validator&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到使用这种方式方便了很多，并且可以根据实际的需求对其进行扩展。</p>
<h2 id="面试题-13"><a class="markdownIt-Anchor" href="#面试题-13"></a> 面试题</h2>
<h3 id="spring校验接口是哪个"><a class="markdownIt-Anchor" href="#spring校验接口是哪个"></a> Spring校验接口是哪个？</h3>
<p>org.springframework.validation.Validator</p>
<h3 id="spring有哪些校验核心组件"><a class="markdownIt-Anchor" href="#spring有哪些校验核心组件"></a> Spring有哪些校验核心组件？</h3>
<ul>
<li>校验器：org.springframework.validation.Validator</li>
<li>错误收集器：org.springframework.validation.Errors</li>
<li>Java Bean错误描述：org.springframework.validation.ObjectError</li>
<li>Java Bean属性错误描述：org.springframework.validation.FieldError</li>
<li>Bean Validation适配：org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</li>
</ul>
<h3 id="请通过示例演示spring-bean的校验"><a class="markdownIt-Anchor" href="#请通过示例演示spring-bean的校验"></a> 请通过示例演示Spring Bean的校验？</h3>
<p>// 待续…</p>
<h1 id="spring-数据绑定"><a class="markdownIt-Anchor" href="#spring-数据绑定"></a> Spring 数据绑定</h1>
<p>Spring数据绑定的使用场景：</p>
<ol>
<li>Spring BeanDefinition到Bean实例创建</li>
<li>Spring数据绑定（DataBinder）</li>
<li>Spring Web参数绑定（WebDataBinder）</li>
</ol>
<h2 id="spring-数据绑定组件"><a class="markdownIt-Anchor" href="#spring-数据绑定组件"></a> Spring 数据绑定组件</h2>
<ol>
<li>标准组件：
<ul>
<li>org.springframework.validation.DataBinder</li>
</ul>
</li>
<li>Web组件：
<ul>
<li>org.springframework.web.bind.WebDataBinder</li>
<li>org.springframework.web.bind.ServletRequestDataBinder</li>
<li>org.springframework.web.bind.support.WebRequestDataBinder</li>
<li>org.springframework.web.bind.support.WebExchangeDataBinder</li>
</ul>
</li>
</ol>
<p>DataBinder的核心属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>target</td>
<td>关联目标Bean</td>
</tr>
<tr>
<td>objectName</td>
<td>目标Bean名称</td>
</tr>
<tr>
<td>bindingResult</td>
<td>属性绑定结果</td>
</tr>
<tr>
<td>typeConverter</td>
<td>类型转化器</td>
</tr>
<tr>
<td>conversionService</td>
<td>类型转化服务</td>
</tr>
<tr>
<td>messageCodesResolver</td>
<td>校验错误文案Code处理器</td>
</tr>
<tr>
<td>validators</td>
<td>关联的Bean Validator实例集合</td>
</tr>
</tbody>
</table>
<p>DataBinder绑定方法bind（PropertyValues），会将PropertyValues key-Value内容映射到关联Bean（target）中的属性上。</p>
<h2 id="databinder元数据"><a class="markdownIt-Anchor" href="#databinder元数据"></a> DataBinder元数据</h2>
<p>DataBinder元数据 - PropertyValues：</p>
<table>
<thead>
<tr>
<th>特征</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据来源</td>
<td>BeanDefinition，主要来源XML资源配置BeanDefinition</td>
</tr>
<tr>
<td>数据结构</td>
<td>由一个或多个PropertyValue组成</td>
</tr>
<tr>
<td>成员结构</td>
<td>PropertyValue包含属性名称，以及属性值（包括原始值、类型转换后的值）</td>
</tr>
<tr>
<td>常见实现</td>
<td>MutablePropertyValue</td>
</tr>
<tr>
<td>Web扩展实现</td>
<td>ServletConfigPropertyValue，ServletRequestParameterPropertyValues</td>
</tr>
<tr>
<td>相关生命周期</td>
<td>InstantiationAwareBeanPostProcessor#postProcessProperties</td>
</tr>
</tbody>
</table>
<h2 id="databinder绑定控制参数"><a class="markdownIt-Anchor" href="#databinder绑定控制参数"></a> DataBinder绑定控制参数</h2>
<p>DataBinder绑定特殊场景分析：</p>
<ul>
<li>当PropertyValues中包含名称的x的PropertyValue，目标对象B不存在x属性，当bind方法执行时，会发生什么？</li>
<li>当PropertyValues中包含名称的x的PropertyValue，目标对象B中存在x属性，当bind方法执行时，如何避免B属性x不被绑定？</li>
<li>当PropertyValues中包含x.y的PropertyValue，目标对象B中存在x属性（嵌套y属性），当bind方法执行时，会发生什么？</li>
</ul>
<p>相关的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinderDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建空白对象</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="comment">// 1.创建DataBinder</span></span><br><span class="line">        DataBinder dataBinder = <span class="keyword">new</span> DataBinder(user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建PropertyValues</span></span><br><span class="line">        HashMap&lt;String, Object&gt; source = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        source.put(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        source.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// a.PropertyValues存在user中不存在的属性值</span></span><br><span class="line">        <span class="comment">// DataBinder特性一：忽略了未知的属性</span></span><br><span class="line">        source.put(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// b.PropertyValues存在一个嵌套属性，company.name</span></span><br><span class="line">        <span class="comment">// DataBinder特性二：支持嵌套属性</span></span><br><span class="line">        source.put(<span class="string">&quot;company.name&quot;</span>,<span class="string">&quot;jjjj&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MutablePropertyValues propertyValues = <span class="keyword">new</span> MutablePropertyValues(source);</span><br><span class="line"></span><br><span class="line">        dataBinder.bind(propertyValues);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.输出user</span></span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DataBinder绑定控制参数：</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ignoreUnknownFields</td>
<td>是否忽略未知字段，默认值：true</td>
</tr>
<tr>
<td>ignoreInvalidFields</td>
<td>是否忽略非法字段，默认值：false</td>
</tr>
<tr>
<td>autoGrowNestedPaths</td>
<td>是否自动增加嵌套路径，默认值：true</td>
</tr>
<tr>
<td>allowedFields</td>
<td>绑定字段白名单</td>
</tr>
<tr>
<td>disallowedFields</td>
<td>绑定字段黑名单</td>
</tr>
<tr>
<td>requiredFields</td>
<td>必须绑定字段</td>
</tr>
</tbody>
</table>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinderDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建空白对象</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="comment">// 1.创建DataBinder</span></span><br><span class="line">        DataBinder dataBinder = <span class="keyword">new</span> DataBinder(user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建PropertyValues</span></span><br><span class="line">        HashMap&lt;String, Object&gt; source = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        source.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        source.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// a.PropertyValues存在user中不存在的属性值</span></span><br><span class="line">        <span class="comment">// DataBinder特性一：忽略了未知的属性</span></span><br><span class="line">        source.put(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// b.PropertyValues存在一个嵌套属性，company.name</span></span><br><span class="line">        <span class="comment">// DataBinder特性二：支持嵌套属性</span></span><br><span class="line">        source.put(<span class="string">&quot;company.name&quot;</span>, <span class="string">&quot;jjjj&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        source.put(&quot;company&quot;, new Company());</span></span><br><span class="line"><span class="comment">//        source.put(&quot;company.name&quot;,&quot;jjjj&quot;);</span></span><br><span class="line"></span><br><span class="line">        MutablePropertyValues propertyValues = <span class="keyword">new</span> MutablePropertyValues(source);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.调整ignoreUnknownFields true（默认） -&gt; false</span></span><br><span class="line"><span class="comment">//        dataBinder.setIgnoreUnknownFields(false);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.调整自动增加嵌套路径true（默认） -&gt; false</span></span><br><span class="line">        dataBinder.setAutoGrowNestedPaths(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.调整ignoreInvalidFields false（默认） -&gt; true</span></span><br><span class="line">        dataBinder.setIgnoreInvalidFields(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.白名单</span></span><br><span class="line">        dataBinder.setRequiredFields(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;city&quot;</span>);</span><br><span class="line"></span><br><span class="line">        dataBinder.bind(propertyValues);</span><br><span class="line">        <span class="comment">// 输出user</span></span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.获取绑定结果（结果包含错误文案code，不会抛出异常）</span></span><br><span class="line">        BindingResult result = dataBinder.getBindingResult();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring底层java-beans替换实现"><a class="markdownIt-Anchor" href="#spring底层java-beans替换实现"></a> Spring底层Java Beans替换实现</h2>
<ol>
<li>Java Beans核心实现 - java.beans.BeanInfo
<ul>
<li>属性（Property）
<ul>
<li>java.beans.PropertyEditor</li>
</ul>
</li>
<li>方法（Method）</li>
<li>事件（Event）</li>
<li>表达式（Expression）</li>
</ul>
</li>
<li>Spring替代实现 - org.springframework.beans.BeanWrapper
<ul>
<li>属性（Property）
<ul>
<li>java.beans.PropertyEditor</li>
</ul>
</li>
<li>嵌套属性路径（nested path）</li>
</ul>
</li>
</ol>
<h2 id="beanwrapper使用场景"><a class="markdownIt-Anchor" href="#beanwrapper使用场景"></a> BeanWrapper使用场景</h2>
<ul>
<li>Spring底层JavaBeans基础设施的中心化接口</li>
<li>通常不会直接使用，间接用于BeanFactory和DataBinder</li>
<li>提供标准JavaBeans分析和操作，能够单独或批量存储Java Bean的属性（properties）</li>
<li>支持嵌套属性路径（nested path）</li>
<li>实现类 org.springframework.beans.BeanWrapperImpl</li>
</ul>
<h2 id="javabeans操作属性"><a class="markdownIt-Anchor" href="#javabeans操作属性"></a> JavaBeans操作属性</h2>
<p>标准的JavaBeans是如何操作属性的？</p>
<table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>java.beans.Introspector</td>
<td>JavaBeans 内省API</td>
</tr>
<tr>
<td>java.beans.BeanInfo</td>
<td>Java Bean 元信息API</td>
</tr>
<tr>
<td>java.beans.BeanDescriptor</td>
<td>Java Bean 信息描述符</td>
</tr>
<tr>
<td>java.beans.PropertyDescriptor</td>
<td>Java Bean 属性描述符</td>
</tr>
<tr>
<td>java.beans.MethodDescriptor</td>
<td>Java Bean 方法描述符</td>
</tr>
<tr>
<td>java.beans.EventSetDescriptor</td>
<td>Java Bean 事件集合描述符</td>
</tr>
</tbody>
</table>
<blockquote>
<p>PropertyDescriptor并不要求setter、getter方法均存在。</p>
</blockquote>
<p>可以使用如下示例进行观察：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaBeansDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// stopClass排除（截止）类</span></span><br><span class="line">        BeanInfo beanInfo = Introspector.getBeanInfo(User.class, Object.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性描述符 PropertyDescriptor</span></span><br><span class="line">        <span class="comment">// 所有的Java类均继承 java.lang.Object方法</span></span><br><span class="line">        <span class="comment">// Class属性来自于Object#getClass() 方法</span></span><br><span class="line">        Stream.of(beanInfo.getPropertyDescriptors()).forEach(propertyDescriptor -&gt; &#123;</span><br><span class="line">            propertyDescriptor.getReadMethod(); <span class="comment">// Getter方法</span></span><br><span class="line">            propertyDescriptor.getWriteMethod(); <span class="comment">// Setter方法</span></span><br><span class="line">            System.out.println(propertyDescriptor);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 输出User定义的方法 MethodDescriptor</span></span><br><span class="line">        Stream.of(beanInfo.getMethodDescriptors()).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="databinder数据校验"><a class="markdownIt-Anchor" href="#databinder数据校验"></a> DataBinder数据校验</h2>
<p>DataBinder与BeanWrapper的联系：</p>
<ul>
<li>bind方法生成BeanPropertyBindingResult</li>
<li>BeanPropertyBindingResult关联BeanWrapper</li>
</ul>
<h2 id="面试题-14"><a class="markdownIt-Anchor" href="#面试题-14"></a> 面试题</h2>
<h3 id="spring数据绑定api是什么"><a class="markdownIt-Anchor" href="#spring数据绑定api是什么"></a> Spring数据绑定API是什么？</h3>
<p>org.springframework.validation.DataBinder</p>
<h3 id="beanwrapper与javabeans之间的关系是"><a class="markdownIt-Anchor" href="#beanwrapper与javabeans之间的关系是"></a> BeanWrapper与JavaBeans之间的关系是？</h3>
<p>BeanWrapper是Spring底层JavaBeans基础设施的中心化接口。</p>
<h3 id="databinder是怎么完成属性类型转换的"><a class="markdownIt-Anchor" href="#databinder是怎么完成属性类型转换的"></a> DataBinder是怎么完成属性类型转换的？</h3>
<p>// …</p>
<h1 id="spring-类型转换"><a class="markdownIt-Anchor" href="#spring-类型转换"></a> Spring 类型转换</h1>
<p>Spring类型转换的实现方案：</p>
<ol>
<li>基于JavaBeans接口的类型转换实现
<ul>
<li>基于java.beans.PropertyEditor扩展</li>
</ul>
</li>
<li>Spring 3.0+ 通用类型转换实现</li>
</ol>
<h2 id="使用场景"><a class="markdownIt-Anchor" href="#使用场景"></a> 使用场景</h2>
<p>场景分析：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>基于JavaBeans接口的类型转换实现</th>
<th>Spring 3.0+通用类型转换实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据绑定</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>BeanWrapper</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>Bean属性类型转换</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>外部化属性类型转换</td>
<td>NO</td>
<td>YES</td>
</tr>
</tbody>
</table>
<h2 id="基于javabeans接口的类型转换"><a class="markdownIt-Anchor" href="#基于javabeans接口的类型转换"></a> 基于JavaBeans接口的类型转换</h2>
<ol>
<li>核心职责：
<ul>
<li>将String类型转化为目标类型的对象</li>
</ul>
</li>
<li>扩展原理：
<ul>
<li>Spring框架将文本内容传递到PropertyEditor实现的setAsText(String)方法</li>
<li>PropertyEditor#setAsText(String)方法实现将String类型转化为目标类型的对象</li>
<li>将目标类型的对象传入PropertyEditor#setAsValue(Object)方法</li>
<li>PropertyEditor#setAsValue(Object)方法实现需要临时存储传入对象</li>
<li>Spring框架将通过PropertyEditor#getValue()获取类型转换后的对象</li>
</ul>
</li>
</ol>
<p>我们可以模拟一下整个过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringToPropertiesPropertyEditor</span> <span class="keyword">extends</span> <span class="title">PropertyEditorSupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.实现setAsText方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="comment">// 2.将String类型转换成Properties类型</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.load(<span class="keyword">new</span> StringReader(text));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.临时存储Properties对象</span></span><br><span class="line">        setValue(properties);</span><br><span class="line">        <span class="comment">// next 获取临时Properties对象 # getValue</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后观察输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyEditorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 模拟Spring Framework的操作</span></span><br><span class="line">        <span class="comment">// 有一段文本name = &quot;吉永超&quot;;</span></span><br><span class="line">        String text = <span class="string">&quot;name = 吉永超&quot;</span>;</span><br><span class="line">        PropertyEditor propertyEditor = <span class="keyword">new</span> StringToPropertiesPropertyEditor();</span><br><span class="line">        propertyEditor.setAsText(text);</span><br><span class="line">        System.out.println(propertyEditor.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring内建propertyeditor扩展"><a class="markdownIt-Anchor" href="#spring内建propertyeditor扩展"></a> Spring内建PropertyEditor扩展</h2>
<p>内建扩展（org.springframework.beans.propertyeditors）：</p>
<table>
<thead>
<tr>
<th>转换场景</th>
<th>实现类</th>
</tr>
</thead>
<tbody>
<tr>
<td>String -&gt; Byte数组</td>
<td>org.springframework.beans.propertyeditors.ByteArrayPropertyEditor</td>
</tr>
<tr>
<td>String -&gt; Char</td>
<td>org.springframework.beans.propertyeditors.CharacterEditor</td>
</tr>
<tr>
<td>String -&gt; Char 数组</td>
<td>org.springframework.beans.propertyeditors.CharArrayPropertyEditor</td>
</tr>
<tr>
<td>String -&gt; Charset</td>
<td>org.springframework.beans.propertyeditors.CharsetEditor</td>
</tr>
<tr>
<td>String -&gt; Class</td>
<td>org.springframework.beans.propertyeditors.ClassEditor</td>
</tr>
<tr>
<td>String -&gt; Currency</td>
<td>org.springframework.beans.propertyeditors.CurrencyEditor</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<h2 id="自定义propertyeditor扩展"><a class="markdownIt-Anchor" href="#自定义propertyeditor扩展"></a> 自定义PropertyEditor扩展</h2>
<p>实现步骤如下：</p>
<ol>
<li>扩展模式：
<ul>
<li>扩展java.beans.PropertyEditorSupport类</li>
</ul>
</li>
<li>实现org.springframework.beans.PropertyEditorRegistrar
<ul>
<li>实现registerCustomEditor（org.springframework.beans.PropertyEditorRegistry）方法</li>
<li>将PropertyEditorRegistry实现注册为Spring Bean</li>
</ul>
</li>
<li>向org.springframework.beans.PropertyEditorRegistry注册自定义PropertyEditor实现
<ul>
<li>通用类型实现：registerCustomEditor(Class&lt;?&gt; requiredType, PropertyEditor propertyEditor);</li>
<li>Java Bean属性类型实现：registerCustomEditor(Class&lt;?&gt; requiredType,  String propertyPath, PropertyEditor propertyEditor);</li>
</ul>
</li>
</ol>
<p>相关的示例，第一步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringToPropertiesPropertyEditor</span> <span class="keyword">extends</span> <span class="title">PropertyEditorSupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.实现setAsText方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="comment">// 2.将String类型转换成Properties类型</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.load(<span class="keyword">new</span> StringReader(text));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.临时存储Properties对象</span></span><br><span class="line">        setValue(properties);</span><br><span class="line">        <span class="comment">// next 获取临时Properties对象 # getValue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAsText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = (Properties) getValue();</span><br><span class="line">        StringBuilder textBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            textBuilder.append(entry.getKey()).append(<span class="string">&quot;=&quot;</span>).append(entry.getValue()).append(System.getProperty(<span class="string">&quot;line.separator&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> textBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二步和第三步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Component // 3.将其声明为Spring Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizedPropertyEditorRegistrar</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCustomEditors</span><span class="params">(PropertyEditorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.通用类型转换</span></span><br><span class="line">        <span class="comment">// 2.Java Bean属性类型转换</span></span><br><span class="line">        registry.registerCustomEditor(User.class, <span class="string">&quot;context&quot;</span>, <span class="keyword">new</span> StringToPropertiesPropertyEditor());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们不采用注解的方式，而是采用XML的方式进行配置，将CustomizedPropertyEditorRegistrar声明为Spring Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;吉永超&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;context&quot;</span>&gt;</span> <span class="comment">&lt;!-- Properties类型 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">                id = 1</span><br><span class="line">                name = 吉永超</span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.conversion.CustomizedPropertyEditorRegistrar&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCustomizedPropertyEditorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/property-editors-context.xml&quot;</span>);</span><br><span class="line">        User user = applicationContext.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="comment">// 关闭应用上下文</span></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="propertyeditor的局限性"><a class="markdownIt-Anchor" href="#propertyeditor的局限性"></a> PropertyEditor的局限性</h2>
<ul>
<li>违反单一原则
<ul>
<li>java.beans.PropertyEditor接口职责太多，除了类型转换，还包括Java Beans事件和Java GUI交互</li>
</ul>
</li>
<li>java.beans.PropertyEditor实现类型局限
<ul>
<li>来源类型只能为java.lang.String类型</li>
</ul>
</li>
<li>java.beans.PropertyEditor实现缺少类型安全
<ul>
<li>除了实现类名可以表达语义，实现类无法感知目标转换类型</li>
</ul>
</li>
</ul>
<h2 id="spring3-通用类型转换接口"><a class="markdownIt-Anchor" href="#spring3-通用类型转换接口"></a> Spring3 通用类型转换接口</h2>
<ol>
<li>类型转换接口 - org.springframework.core.convert.converter.Converter&lt;S, T&gt;
<ul>
<li>泛型参数S：来源类型，参数T：目标类型</li>
<li>核心方法：T convert(S)</li>
</ul>
</li>
<li>通用类型转换接口 - org.springframework.core.convert.converter.GenericConverter
<ul>
<li>核心方法：convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType);</li>
<li>配对类型：org.springframework.core.convert.converter.GenericConverter.ConvertiblePair</li>
<li>类型描述：org.springframework.core.convert.TypeDescriptor</li>
</ul>
</li>
</ol>
<h2 id="spring内建类型转换器"><a class="markdownIt-Anchor" href="#spring内建类型转换器"></a> Spring内建类型转换器</h2>
<table>
<thead>
<tr>
<th>转换场景</th>
<th>实现类所在包名(package)</th>
</tr>
</thead>
<tbody>
<tr>
<td>日期/时间相关</td>
<td>org.springframework.format.datetime</td>
</tr>
<tr>
<td>Java 8 日期/时间相关</td>
<td>org.springframework.format.datetime.standard</td>
</tr>
<tr>
<td>通用实现</td>
<td>org.springframework.core.convert.support</td>
</tr>
</tbody>
</table>
<h2 id="converter接口的局限性"><a class="markdownIt-Anchor" href="#converter接口的局限性"></a> Converter接口的局限性</h2>
<ul>
<li>局限一：缺少Source Type和Target Type前置判断
<ul>
<li>应对：增加org.springframework.core.convert.converter.ConditionalConverter实现</li>
</ul>
</li>
<li>局限二：仅能转换单一的Source Type和Target Type
<ul>
<li>应对：使用org.springframework.core.convert.converter.GenericConverter代替</li>
</ul>
</li>
</ul>
<h2 id="genericconverter接口"><a class="markdownIt-Anchor" href="#genericconverter接口"></a> GenericConverter接口</h2>
<p>org.springframework.core.convert.converter.GenericConverter的介绍：</p>
<table>
<thead>
<tr>
<th>核心要素</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>使用场景</td>
<td>用于&quot;复合&quot;类型转换场景，比如Collection、Map、数组等</td>
</tr>
<tr>
<td>转换范围</td>
<td>Set<ConvertiblePair> getConvertibleTypes()</td>
</tr>
<tr>
<td>配对类型</td>
<td>org.springframework.core.convert.converter.GenericConverter.ConvertiblePair</td>
</tr>
<tr>
<td>转换方法</td>
<td>convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</td>
</tr>
<tr>
<td>类型描述</td>
<td>org.springframework.core.convert.TypeDescriptor</td>
</tr>
</tbody>
</table>
<blockquote>
<p>&quot;复合&quot;类型在进行转换的时候，可以利用Converter接口，对集合（或其他类型）中的元素进行转换。</p>
</blockquote>
<h2 id="优化genericconverter接口"><a class="markdownIt-Anchor" href="#优化genericconverter接口"></a> 优化GenericConverter接口</h2>
<p>GenericConverter局限性：</p>
<ul>
<li>缺少Source TYpe和Target Type前置判断</li>
<li>单一类型转换实现复杂</li>
</ul>
<p>GenericConverter优化接口 - ConditionalGenericConverter</p>
<ul>
<li>复合类型转换 ：org.springframework.core.convert.converter.GenericConverter</li>
<li>类型条件判断：org.springframework.core.convert.converter.ConditionalConverter</li>
</ul>
<h2 id="扩展spring类型转换器"><a class="markdownIt-Anchor" href="#扩展spring类型转换器"></a> 扩展Spring类型转换器</h2>
<p>扩展的步骤：</p>
<ol>
<li>实现转换器接口
<ul>
<li>org.springframework.core.convert.converter.Converter</li>
<li>org.springframework.core.convert.converter.ConverterFatory</li>
<li>org.springframework.core.convert.converter.GenericConverter</li>
</ul>
</li>
<li>注册转换器实现
<ul>
<li>通过ConversionServiceFactoryBean（Spring Bean）</li>
<li>通过org.springframework.core.convert.ConversionService（API）</li>
</ul>
</li>
</ol>
<p>相关的示例如下，步骤一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesToStringConverter</span> <span class="keyword">implements</span> <span class="title">ConditionalGenericConverter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Properties.class.equals(sourceType.getObjectType()) &amp;&amp; String.class.equals(targetType.getObjectType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ConvertiblePair&gt; <span class="title">getConvertibleTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> ConvertiblePair(Properties.class, String.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">        Properties properties = (Properties) source;</span><br><span class="line">        StringBuilder textBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            textBuilder.append(entry.getKey()).append(<span class="string">&quot;=&quot;</span>).append(entry.getValue()).append(System.getProperty(<span class="string">&quot;line.separator&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> textBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>步骤二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:util=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd&#x27;</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/util</span></span><br><span class="line"><span class="string">       http://www.springframework.org/schema/util/spring-util.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;user&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;id&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;吉永超&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;context&quot;</span>&gt; &lt;!-- Properties类型 --&gt;</span><br><span class="line">            &lt;value&gt;</span><br><span class="line">                id = <span class="number">1</span></span><br><span class="line">                name = 吉永超</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;contextAsText&quot;</span> ref=<span class="string">&quot;context&quot;</span>/&gt; &lt;!--properties类型要转成String --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;util:properties id=<span class="string">&quot;context&quot;</span>&gt;</span><br><span class="line">        &lt;prop key=<span class="string">&quot;id&quot;</span>&gt;<span class="number">1</span>&lt;/prop&gt;</span><br><span class="line">        &lt;prop key=<span class="string">&quot;name&quot;</span>&gt;jiyongchao&lt;/prop&gt;</span><br><span class="line">    &lt;/util:properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 声明ConversionServiceFactoryBean--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;conversionService&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;converters&quot;</span> value=<span class="string">&quot;org.jyc.thinking.in.spring.conversion.PropertiesToStringConverter&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要格外注意的是，在注册ConversionServiceFactoryBean的时候，一定要指定名称为conversionService，因为在beanFactory进行查找的时候，会根据名称和类型共同查找，名称固定为conversionService。</p>
</blockquote>
<h2 id="统一类型转换服务"><a class="markdownIt-Anchor" href="#统一类型转换服务"></a> 统一类型转换服务</h2>
<p>org.springframework.core.convert.ConversionService说明：</p>
<table>
<thead>
<tr>
<th>实现类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GenericConversionService</td>
<td>通用ConversionService模板实现，不内置转化器实现</td>
</tr>
<tr>
<td>DefaultConversionService</td>
<td>基础ConversionService实现，内置常用转化器实现</td>
</tr>
<tr>
<td>FormattingConversionService</td>
<td>通用Formatter + GenericConversionService实现，不内置转化器和Formatter实现</td>
</tr>
<tr>
<td>DefaultFormattingConversionService</td>
<td>DefaultConversionService + 格式化 实现（如：JSR-354 Money &amp; Currency，JSR-310 Date-Time）</td>
</tr>
</tbody>
</table>
<h2 id="conversionservice作为依赖"><a class="markdownIt-Anchor" href="#conversionservice作为依赖"></a> ConversionService作为依赖</h2>
<p>类型转换器底层接口 - org.springframework.beans.TypeConverter</p>
<ul>
<li>起始版本：Spring 2.0</li>
<li>核心方法 - convertlfNecessary重载方法</li>
<li>抽象实现 - org.springframework.beans.TypeConverterSupport</li>
<li>简单实现 - org.springframework.beans.SimpleTypeConverter</li>
</ul>
<p>类型转换器底层抽象实现 - org.springframework.beans.TypeConverterSupport</p>
<ul>
<li>实现接口 - org.springframework.beans.TypeConverter</li>
<li>扩展实现 - org.springframework.beans.PropertyEditorRegistrySupport</li>
<li>委派实现 - org.springframework.beans.TypeConverterDelegate</li>
</ul>
<p>类型转换器底层委派实现 - org.springframework.beans.TypeConverterDelegate</p>
<ul>
<li>构造来源 - org.springframework.beans.AbstractNestablePropertyAccessor实现
<ul>
<li>org.springframework.beans.BeanWrapperImpl</li>
</ul>
</li>
<li>依赖 - java.beans.PropertyEditor实现
<ul>
<li>默认内建时间 - org.springframework.beans.PropertyEditorRegistrySupport#registerDefaultEditors</li>
</ul>
</li>
<li>可选依赖 - org.springframework.core.convert.ConversionService实现</li>
</ul>
<p>整体的流程关键节点如下：</p>
<blockquote>
<p>AbstractApplicationContext -&gt; “conversionService” ConversionService Bean -&gt; configurableBeanFactory#setConversionService(conversionService) -&gt; AbstractAutowireCapableBeanFactory#instantiateBean -&gt; AbstractBeanFactory#getConversionServicee -&gt; BeanDefinition -&gt; BeanWrapper -&gt; 属性转换(数据来源：PropertyValues) -&gt; setPropertyValues(PropertyValues) -&gt; TypeConvert#convertIfNecessnary -&gt; TypeConverterDelegate -&gt; PropertyEditor or ConversionService</p>
</blockquote>
<h2 id="面试题-15"><a class="markdownIt-Anchor" href="#面试题-15"></a> 面试题</h2>
<h3 id="spring类型转换实现有哪些"><a class="markdownIt-Anchor" href="#spring类型转换实现有哪些"></a> Spring类型转换实现有哪些？</h3>
<ol>
<li>基于JavaBeans PropertyEditor接口实现</li>
<li>Spring 3.0+通用类型转换实现</li>
</ol>
<h3 id="spring类型转换器接口有哪些"><a class="markdownIt-Anchor" href="#spring类型转换器接口有哪些"></a> Spring类型转换器接口有哪些？</h3>
<ul>
<li>类型转换接口 - org.springframework.core.convert.converter.Converter</li>
<li>通用类型转换接口 - org.springframework.core.convert.converter.GenericConverter</li>
<li>类型条件接口 - org.springframework.core.convert.converter.ConditionalConverter</li>
<li>综合类型转换接口 - org.springframework.core.convert.converter.ConditionalGenericConverter</li>
</ul>
<h3 id="typedescriptor是如何处理泛型"><a class="markdownIt-Anchor" href="#typedescriptor是如何处理泛型"></a> TypeDescriptor是如何处理泛型？</h3>
<p>// …</p>
<h1 id="spring-泛型"><a class="markdownIt-Anchor" href="#spring-泛型"></a> Spring 泛型</h1>
<h2 id="java泛型基础"><a class="markdownIt-Anchor" href="#java泛型基础"></a> Java泛型基础</h2>
<p>泛型类型：</p>
<ul>
<li>泛型类型是在类型上参数化的泛型类或接口</li>
</ul>
<p>泛型的使用场景：</p>
<ul>
<li>编译时强制类型检查</li>
<li>避免类型强转</li>
<li>实现通用算法</li>
</ul>
<p>泛型类型擦写：</p>
<ul>
<li>泛型被引入到Java语言中，以便在编译时提供更严格的类型检查并支持泛型编程。类型擦除确保不会为参数化类型创建新类；因此，泛型不会产生运行时开销。为了实现泛型，编译器将类型擦除应用于：
<ul>
<li>将泛型类型中的所有类型参数替换为其边界，如果类型参数是无边界的，则将其替换为&quot;Object&quot;。因为，生成的字节码只包含普通类、接口和方法</li>
<li>必要时插入类型转换以保持类型安全</li>
<li>生成桥方法以保留扩展泛型类中的多态性</li>
</ul>
</li>
</ul>
<h2 id="java-5类型接口"><a class="markdownIt-Anchor" href="#java-5类型接口"></a> Java 5类型接口</h2>
<p>Java 5类型接口 - java.lang.reflect.Type</p>
<table>
<thead>
<tr>
<th>派生类或接口</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>java.lang.Class</td>
<td>Java类API，如java.lang.String</td>
</tr>
<tr>
<td>java.lang.reflect.GenericArrayType</td>
<td>泛型数组类型</td>
</tr>
<tr>
<td>java.lang.reflect.ParameterizedType</td>
<td>泛型参数类型</td>
</tr>
<tr>
<td>java.lang.reflect.TypeVariable</td>
<td>泛型类型变量，如Collection<E> 中的E</td>
</tr>
<tr>
<td>java.lang.reflect.WildcardType</td>
<td>泛型统配类型</td>
</tr>
</tbody>
</table>
<p>Java泛型反射API：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>API</th>
</tr>
</thead>
<tbody>
<tr>
<td>泛型信息</td>
<td>java.lang.Class#getGenericInfo</td>
</tr>
<tr>
<td>泛型参数</td>
<td>java.lang.reflect#ParameterizedType</td>
</tr>
<tr>
<td>泛型父类</td>
<td>java.lang.Class#getGenericSuperclass</td>
</tr>
<tr>
<td>泛型接口</td>
<td>java.lang.Class#getGenericInterfaces</td>
</tr>
<tr>
<td>泛型声明</td>
<td>java.lang.reflect#GenericDeclaration</td>
</tr>
</tbody>
</table>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericAPIDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原生类型 int long float</span></span><br><span class="line">        Class intClass = <span class="keyword">int</span>.class;</span><br><span class="line">        <span class="comment">// 数组类型 int[],Object[]</span></span><br><span class="line">        Class objectArrayClass = Object[].class;</span><br><span class="line">        <span class="comment">// 原始类型 raw types: java.lang.String</span></span><br><span class="line">        Class rawClass = String.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 泛型参数类型 parameterized Type</span></span><br><span class="line">        ParameterizedType parameterizedType = (ParameterizedType) ArrayList.class.getGenericSuperclass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// parameterizedType.getRawType() = java.util.AbstractList;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//泛型类型变量 Type Variable</span></span><br><span class="line"></span><br><span class="line">        System.out.println(parameterizedType.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;E&gt;</span></span><br><span class="line">        Type[] typeVariables = parameterizedType.getActualTypeArguments();</span><br><span class="line"><span class="comment">//        Stream.of(parameterizedType.getActualTypeArguments()).forEach(System.out::println);</span></span><br><span class="line">        Stream.of(typeVariables).map(TypeVariable.class::cast).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring泛型类型辅助类"><a class="markdownIt-Anchor" href="#spring泛型类型辅助类"></a> Spring泛型类型辅助类</h2>
<p>核心API - org.springframework.core.GenericTypeResolver</p>
<ul>
<li>
<p>版本支持[2.5.2,）</p>
</li>
<li>
<p>处理类型相关（Type）相关方法</p>
<ul>
<li>resolveReturnType</li>
<li>resolveType</li>
</ul>
</li>
<li>
<p>处理泛型参数类型（ParameterizedType）相关方法</p>
<ul>
<li>resolveReturnTypeArgument</li>
<li>resolveTypeArgument</li>
<li>resolveTypeArguments</li>
</ul>
</li>
<li>
<p>处理泛型类型变量（TypeVariable）相关方法</p>
<ul>
<li>getTypeVariableMap</li>
</ul>
</li>
</ul>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTypeResolverDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// String Comparable&lt;String&gt; 具体化</span></span><br><span class="line">        displayReturnTypeGenericInfo(GenericTypeResolverDemo.class, Comparable.class, <span class="string">&quot;getString&quot;</span>);</span><br><span class="line">        <span class="comment">// ArrayList&lt;Object&gt;是List泛型参数类型的具体化</span></span><br><span class="line">        displayReturnTypeGenericInfo(GenericTypeResolverDemo.class, List.class, <span class="string">&quot;getList&quot;</span>);</span><br><span class="line">        <span class="comment">// StringList也是List泛型类型的具体化</span></span><br><span class="line">        displayReturnTypeGenericInfo(GenericTypeResolverDemo.class, List.class, <span class="string">&quot;getStringList&quot;</span>);</span><br><span class="line">        <span class="comment">// 具备 ParameterizedType返回。否则null</span></span><br><span class="line">        <span class="comment">// TypeVariable</span></span><br><span class="line">        Map&lt;TypeVariable, Type&gt; typeVariableMap = GenericTypeResolver.getTypeVariableMap(StringList.class);</span><br><span class="line">        System.out.println(typeVariableMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringList <span class="title">getStringList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Object&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123; <span class="comment">// 泛型参数具体化（字节码有记录）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayReturnTypeGenericInfo</span><span class="params">(Class&lt;?&gt; containingClass, Class&lt;?&gt; generic, String methodName, Class... argumentTypes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method method = containingClass.getMethod(methodName, argumentTypes);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; returnType = GenericTypeResolver.resolveReturnType(method, containingClass);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; returnTypeArgument = GenericTypeResolver.resolveReturnTypeArgument(method, generic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 常规类作为方法返回值</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;GenericTypeResolver.resolveReturnType(%s,%s) = %s\n&quot;</span>, methodName, containingClass.getSimpleName(), returnType);</span><br><span class="line">        <span class="comment">// 常规类型不具备泛型参数类型List&lt;E&gt;</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;GenericTypeResolver.resolveReturnTypeArgument(%s,%s) = %s\n&quot;</span>, methodName, containingClass.getSimpleName(), returnTypeArgument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StringList</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">String</span>&gt; </span>&#123; <span class="comment">// 泛型参数具体化（字节码有记录）</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="泛型集合类型辅助类"><a class="markdownIt-Anchor" href="#泛型集合类型辅助类"></a> 泛型集合类型辅助类</h2>
<p>核心API - org.springframework.core.GenericCollectionTypeSolver</p>
<ul>
<li>
<p>版本支持：[2.0,4.3]</p>
<ul>
<li>替换实现：org.springframework.core.ResolvableType</li>
</ul>
</li>
<li>
<p>处理Collection相关</p>
<ul>
<li>getCollection*Type</li>
<li>getMapValue*Type</li>
</ul>
<blockquote>
<p>GenericCollectionTypeSolver在高版本的Spring中已经移除，建议使用它的替换实现ResolvableType。</p>
</blockquote>
</li>
</ul>
<h2 id="spring方法参数封装"><a class="markdownIt-Anchor" href="#spring方法参数封装"></a> Spring方法参数封装</h2>
<p>核心API - org.springframework.core.MethodParameter</p>
<ul>
<li>
<p>起始版本：[2.0,)</p>
</li>
<li>
<p>元信息</p>
<ul>
<li>关联的方法 - Method</li>
<li>关联的构造器 - Constuctor</li>
<li>构造器或方法参数索引 - parameterIndex</li>
<li>构造器或方法参数类型 - parameterType</li>
<li>构造器或方法参数泛型类型 - genericParameterType</li>
<li>构造器或方法参数名称 - parameterName</li>
<li>所在的类 - containingClass</li>
</ul>
<blockquote>
<p>parameterName是java8之后才存在。</p>
</blockquote>
</li>
</ul>
<h2 id="resolvabletype"><a class="markdownIt-Anchor" href="#resolvabletype"></a> ResolvableType</h2>
<p>核心API - org.springframework.core.ResolvableType</p>
<ul>
<li>起始版本：[4.0,)</li>
<li>扮演角色：GenericTypeResolver和GenericCollectionTypeResolver替代者</li>
<li>工厂方法：for*方法</li>
<li>转换方法：as*方法</li>
<li>处理方法：resolve*方法</li>
</ul>
<p>官方给出的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HashMap&lt;Integer, List&lt;String&gt;&gt; myMap;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">example</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ResolvableType t = ResolvableType.forField(getClass().getDeclaredField(<span class="string">&quot;myMap&quot;</span>));</span><br><span class="line">      t.getSuperType(); <span class="comment">// AbstractMap&lt;Integer, List&lt;String&gt;&gt;</span></span><br><span class="line">      t.asMap(); <span class="comment">// Map&lt;Integer, List&lt;String&gt;&gt;</span></span><br><span class="line">      t.getGeneric(<span class="number">0</span>).resolve(); <span class="comment">// Integer</span></span><br><span class="line">      t.getGeneric(<span class="number">1</span>).resolve(); <span class="comment">// List</span></span><br><span class="line">      t.getGeneric(<span class="number">1</span>); <span class="comment">// List&lt;String&gt;</span></span><br><span class="line">      t.resolveGeneric(<span class="number">1</span>, <span class="number">0</span>); <span class="comment">// String</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们来使用相关的API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolvableTypeDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 工厂创建</span></span><br><span class="line">        <span class="comment">// StringList &lt;- ArrayList &lt;- AbstractList &lt;- list</span></span><br><span class="line">        ResolvableType resolvableType = ResolvableType.forClass(GenericTypeResolverDemo.StringList.class);</span><br><span class="line">        resolvableType.getSuperType(); <span class="comment">//ArrayList</span></span><br><span class="line">        resolvableType.getSuperType().getSuperType(); <span class="comment">// AbstractList</span></span><br><span class="line"></span><br><span class="line">        System.out.println(resolvableType.asCollection().resolve()); <span class="comment">//获取Raw Type</span></span><br><span class="line">        System.out.println(resolvableType.asCollection().resolveGeneric(<span class="number">0</span>)); <span class="comment">// 获取泛型参数类型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ResolvableType也有两个局限性，第一，ResolvableType无法处理泛型擦写，第二，ResolvableType无法处理非具体化的ParameterizedType。</p>
</blockquote>
<h2 id="面试题-16"><a class="markdownIt-Anchor" href="#面试题-16"></a> 面试题</h2>
<h3 id="java泛型擦写是发生在编译时还是运行时"><a class="markdownIt-Anchor" href="#java泛型擦写是发生在编译时还是运行时"></a> Java泛型擦写是发生在编译时，还是运行时？</h3>
<p>运行时。</p>
<h3 id="请介绍java-5-type类型的派生类或接口"><a class="markdownIt-Anchor" href="#请介绍java-5-type类型的派生类或接口"></a> 请介绍Java 5 Type类型的派生类或接口?</h3>
<p>见Java5 类型接口</p>
<h3 id="请说明resolvabletype的设计优势"><a class="markdownIt-Anchor" href="#请说明resolvabletype的设计优势"></a> 请说明ResolvableType的设计优势</h3>
<ul>
<li>简化Java5 Type API开发，屏蔽复杂API的运用，如ParameterizedType</li>
<li>不变性设计（Immutability）</li>
<li>Fluent API设计（Builder模式），链式（流式）编程</li>
</ul>
<h1 id="spring-事件"><a class="markdownIt-Anchor" href="#spring-事件"></a> Spring 事件</h1>
<h2 id="java事件监听器编程模型"><a class="markdownIt-Anchor" href="#java事件监听器编程模型"></a> Java事件/监听器编程模型</h2>
<ul>
<li>设计模式 - 观察者模式扩展
<ul>
<li>可观者对象（消息发送者） - java.util.Observable</li>
<li>观察者 -  java.util.Observer</li>
</ul>
</li>
<li>标准化接口
<ul>
<li>事件对象 - java.util.EventObject</li>
<li>事件监听器 - java.util.EventListener</li>
</ul>
</li>
</ul>
<p>使用的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Observable observable = <span class="keyword">new</span> EventObservable();</span><br><span class="line">        <span class="comment">// 添加观察者（监听者）</span></span><br><span class="line">        observable.addObserver(<span class="keyword">new</span> EventObserver());</span><br><span class="line">        observable.notifyObservers(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.setChanged();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">(Object arg)</span> </span>&#123;</span><br><span class="line">            setChanged();</span><br><span class="line">            <span class="keyword">super</span>.notifyObservers(<span class="keyword">new</span> EventObject(arg));</span><br><span class="line">            clearChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object event)</span> </span>&#123;</span><br><span class="line">            EventObject eventObject = (EventObject) event;</span><br><span class="line">            System.out.println(<span class="string">&quot;收到事件&quot;</span> + eventObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里由于Observable的setChanged是protected，所以需要实现子类，重写这个方法，并且为了更方便的操作，我们一般也会扩充notifyObservers的实现逻辑。</p>
</blockquote>
<h2 id="面向接口的事件监听器设计模式"><a class="markdownIt-Anchor" href="#面向接口的事件监听器设计模式"></a> 面向接口的事件/监听器设计模式</h2>
<p>事件/监听器场景举例</p>
<table>
<thead>
<tr>
<th>Java技术规范</th>
<th>事件接口</th>
<th>监听器接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>JavaBeans</td>
<td>java.beans.PropertyChangeEvent</td>
<td>java.beans.PropertyChangeListener</td>
</tr>
<tr>
<td>Java AWT</td>
<td>java.awt.event.MouseEvent</td>
<td>java.awt.event.MouseListener</td>
</tr>
<tr>
<td>Java Swing</td>
<td>javax.swing.event.MenuEvent</td>
<td>javax.swing.event.MenuListener</td>
</tr>
<tr>
<td>Java Preference</td>
<td>java.util.prefs.PreferenceChangeEvent</td>
<td>java.util.prefs.PreferenceChangeListener</td>
</tr>
</tbody>
</table>
<h2 id="面向注解的事件监听器设计模式"><a class="markdownIt-Anchor" href="#面向注解的事件监听器设计模式"></a> 面向注解的事件/监听器设计模式</h2>
<p>事件/监听器注解场景举例</p>
<table>
<thead>
<tr>
<th>Java 技术规范</th>
<th>事件注解</th>
<th>监听器注解</th>
</tr>
</thead>
<tbody>
<tr>
<td>Servlet 3.0+</td>
<td></td>
<td>@javax.servlet.annotation.WebListener</td>
</tr>
<tr>
<td>JPA 1.0+</td>
<td>@javax.persistence.PostPersist</td>
<td></td>
</tr>
<tr>
<td>Java Common</td>
<td>@PostConstruct</td>
<td></td>
</tr>
<tr>
<td>EJB 3.0+</td>
<td>@javax.ejb.PrePassivate</td>
<td></td>
</tr>
<tr>
<td>JSF 2.0+</td>
<td>@javax.faces.event.ListenerFor</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="spring标准事件-applicationevent"><a class="markdownIt-Anchor" href="#spring标准事件-applicationevent"></a> Spring标准事件 ApplicationEvent</h2>
<p>Java标准事件 java.util.EventObject扩展：</p>
<ul>
<li>扩展特性：事件发生事件戳</li>
</ul>
<p>Spring应用上下文ApplicationEvent扩展 - ApplicationContextEvent</p>
<ul>
<li>Spring应用上下文（ApplicationContext作为事件源）</li>
<li>具体实现：
<ul>
<li>org.springframework.context.event.ContextClosedEvent</li>
<li>org.springframework.context.event.ContextRefreshedEvent</li>
<li>org.springframework.context.event.ContextStartedEvent</li>
<li>org.springframework.context.event.ContextStoppedEvent</li>
</ul>
</li>
</ul>
<h2 id="基于接口的spring事件监听器"><a class="markdownIt-Anchor" href="#基于接口的spring事件监听器"></a> 基于接口的Spring事件监听器</h2>
<p>Java标准事件监听器java.util.EventListener扩展</p>
<ul>
<li>扩展接口 - org.springframework.context.ApplicationListener</li>
<li>设计特点：单一类型事件处理</li>
<li>处理方法：onApplicationEvent(ApplicationEvent event);</li>
<li>事件类型：org.springframework.context.ApplicationEvent</li>
</ul>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationListenerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line">        <span class="comment">// 向Spring应用上下文注册事件</span></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> ApplicationListener&lt;ApplicationEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收到Spring事件： &quot;</span> + event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        context.refresh();</span><br><span class="line">        context.start();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于注解的spring事件监听器"><a class="markdownIt-Anchor" href="#基于注解的spring事件监听器"></a> 基于注解的Spring事件监听器</h2>
<p>Spring注解 - @org.springframework.context.event.EventListener</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>设计特点</td>
<td>支持多ApplicationEvent类型，无需接口约束</td>
</tr>
<tr>
<td>注解目标</td>
<td>方法</td>
</tr>
<tr>
<td>是否支持异步执行</td>
<td>支持</td>
</tr>
<tr>
<td>是否支持泛型类型事件</td>
<td>支持</td>
</tr>
<tr>
<td>是指支持顺序控制</td>
<td>支持，配合@Order注解控制</td>
</tr>
</tbody>
</table>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationListenerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        GenericApplicationContext context = new GenericApplicationContext();</span></span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 将引导类作为配置类</span></span><br><span class="line">        context.register(ApplicationListenerDemo.class);</span><br><span class="line">        <span class="comment">// 方法一：基于Spring接口：向Spring应用上下文注册事件</span></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> ApplicationListener&lt;ApplicationEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">                println(<span class="string">&quot;ApplicationListene接收到Spring事件： &quot;</span> + event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 方法二：基于Spring注解@EventListener</span></span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line">        context.start();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Order(1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">       println(<span class="string">&quot;@EventListener1接收到Spring事件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Order(2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent1</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">        println(<span class="string">&quot;@EventListener2接收到Spring事件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextStartedEvent event)</span> </span>&#123;</span><br><span class="line">        println(<span class="string">&quot;@EventListener接收到Spring事件（异步）&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> </span>&#123;</span><br><span class="line">       println(<span class="string">&quot;@EventListener接收到Spring事件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">println</span><span class="params">(Object printable)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[线程：%s] : %s\n&quot;</span>, Thread.currentThread(), printable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册spring-applicationlistener"><a class="markdownIt-Anchor" href="#注册spring-applicationlistener"></a> 注册Spring ApplicationListener</h2>
<ol>
<li>方法一：ApplicationListener作为Spring Bean注册</li>
<li>方法二：通过ConfigurableApplicationContext API注册</li>
</ol>
<p>第二种方式在之前我们已经讨论过了，这里第一种方式也比较容易：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">           println(<span class="string">&quot;MyApplicationListener接收到Spring事件&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后将MyApplicationListener标注为Spring Bean即可。</p>
<h2 id="spring事件发布器"><a class="markdownIt-Anchor" href="#spring事件发布器"></a> Spring事件发布器</h2>
<ul>
<li>方法一：通过ApplicationEventPublisher发布Spring事件
<ul>
<li>获取ApplicationEventPublisher
<ul>
<li>依赖注入</li>
</ul>
</li>
</ul>
</li>
<li>方法二：通过ApplicationEventPublisher发布Spring事件
<ul>
<li>获取ApplicationEventMulticaster
<ul>
<li>依赖注入</li>
<li>依赖查找</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>使用ApplicationListenerDemo实现ApplicationEventPublisherAware接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> ApplicationEvent(<span class="string">&quot;hello world&quot;</span>) &#123;</span><br><span class="line">    &#125;);</span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring层次性上下文事件传播"><a class="markdownIt-Anchor" href="#spring层次性上下文事件传播"></a> Spring层次性上下文事件传播</h2>
<ul>
<li>
<p>发生说明</p>
<p>当Spring应用出现多层次Spring应用上下文（ApplicationContext）时，如Spring WebMVC、Spring Boot或Spring Cloud场景下，由子ApplicationContext发起Spring事件可能会传递到其Parent ApplicationContext（直到Root）的过程。</p>
</li>
<li>
<p>如何避免</p>
<p>定位Spring事件源（ApplicationContext）进行过滤处理</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HierarchicalSpringEventPropagateDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建parent Spring应用上下文</span></span><br><span class="line">        AnnotationConfigApplicationContext parentContent = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 2.创建current Spring应用上下文</span></span><br><span class="line">        parentContent.setId(<span class="string">&quot;parent-context&quot;</span>);</span><br><span class="line">        parentContent.register(MyListener.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.current -&gt; parent</span></span><br><span class="line">        AnnotationConfigApplicationContext currentContent = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        parentContent.setId(<span class="string">&quot;current-context&quot;</span>);</span><br><span class="line">        currentContent.setParent(parentContent);</span><br><span class="line">        currentContent.register(MyListener.class);</span><br><span class="line"></span><br><span class="line">        parentContent.refresh();</span><br><span class="line">        <span class="comment">// 这里会触发两次，因为会出发父应用上下文的事件</span></span><br><span class="line">        currentContent.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意这里的顺序，不能颠倒</span></span><br><span class="line">        currentContent.close();</span><br><span class="line">        parentContent.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationContextEvent</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 这里必须是静态字段</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;ApplicationEvent&gt; processedEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationContextEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (processedEvents.add(event)) &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;监听到 Spring应用上下文[ID：%s]事件： %s\n&quot;</span>, event.getApplicationContext().getId(), event.getClass().getSimpleName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring内建事件"><a class="markdownIt-Anchor" href="#spring内建事件"></a> Spring内建事件</h2>
<p>ApplicationContextEvent派生事件：</p>
<ul>
<li>ContextRefreshedEvent：Spring应用上下文就绪事件</li>
<li>ContextStartedEvent：Spring应用上下文启动事件</li>
<li>ContextStoppedEvent：Spring应用上下文停止事件</li>
<li>ContextClosedEvent：Spring应用上下文关闭事件</li>
</ul>
<h2 id="payload事件"><a class="markdownIt-Anchor" href="#payload事件"></a> Payload事件</h2>
<p>Spring Payload事件 - org.springframework.context.PayloadApplicationEvent</p>
<ul>
<li>使用场景：简化Spring事件发送，关注事件源主体</li>
<li>发送方法：ApplicationEventPublisher#publishEvent(Object event)</li>
</ul>
<blockquote>
<p>这个事件使用的很少，并且对于泛型的处理还存在Bug，可以使用ApplicationEventPublisher#publishEvent方法。</p>
</blockquote>
<h2 id="自定义spring事件"><a class="markdownIt-Anchor" href="#自定义spring事件"></a> 自定义Spring事件</h2>
<ol>
<li>扩展 org.springframework.context.ApplicationEvent</li>
<li>实现 org.springframework.context.ApplicationListener</li>
<li>注册 org.springframework.context.ApplicationListener</li>
</ol>
<p>我们来实现一个自定义的Spring事件，第一步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySpringEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySpringEvent</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (String) <span class="keyword">super</span>.getSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二步，实现自定义的事件监听器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySpringEventListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MySpringEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MySpringEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[线程：%s] :监听到事件 %s\n&quot;</span>, Thread.currentThread().getName(), event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步，注册自定义事件监听器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizedSpringEventDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> MySpringEventListener());</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        context.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;hello,world&quot;</span>));</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖注入applicationeventpublisher"><a class="markdownIt-Anchor" href="#依赖注入applicationeventpublisher"></a> 依赖注入ApplicationEventPublisher</h2>
<ol>
<li>通过ApplicationEventPublisherAware回调接口</li>
<li>通过@Autowired ApplicationEventPublisher</li>
</ol>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectingApplicationEventPublisherDemo</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// #3</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;the event from @Autowired ApplicationEventPublisher&quot;</span>));</span><br><span class="line">        <span class="comment">// #4</span></span><br><span class="line">        applicationContext.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;the event from @Autowired ApplicationContext&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(InjectingApplicationEventPublisherDemo.class);</span><br><span class="line"></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> MySpringEventListener());</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;the event from ApplicationEventPublisher&quot;</span>)); <span class="comment">//#1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123; <span class="comment">//#2</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="string">&quot;the event from ApplicationContext&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖查找applicationeventmulticaster"><a class="markdownIt-Anchor" href="#依赖查找applicationeventmulticaster"></a> 依赖查找ApplicationEventMulticaster</h2>
<p>查找条件：</p>
<ul>
<li>Bean名称：“applicationEventMulticaster”</li>
<li>Bean类型：org.springframework.context.event.ApplicationEventMulticaster</li>
</ul>
<p>依赖查找的细节可以在AbstractApplicationContext#initApplicationEventMulticaster中看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">		<span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">					beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 如果不存在会直接new一个，也就是说初始化之后，ApplicationEventMulticaster不会为空</span></span><br><span class="line">			<span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">			beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">						<span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="applicationeventpublisher底层实现"><a class="markdownIt-Anchor" href="#applicationeventpublisher底层实现"></a> ApplicationEventPublisher底层实现</h2>
<p>底层实现：</p>
<ul>
<li>接口：org.springframework.context.event.ApplicationEventMulticaster</li>
<li>抽象类：org.springframework.context.event.AbstractApplicationEventMulticaster</li>
<li>实现类：org.springframework.context.event.SimpleApplicationEventMulticaster</li>
</ul>
<blockquote>
<p>早期的Spring，ApplicationEventPublisherAware与BeanPostProcessor不能同时使用，后面的版本采用了事件回放的机制修复了这个BUG。</p>
</blockquote>
<h2 id="同步和异步spring事件广播"><a class="markdownIt-Anchor" href="#同步和异步spring事件广播"></a> 同步和异步Spring事件广播</h2>
<p>基本实现类 - org.springframework.context.event.SimpleApplicationEventMulticaster</p>
<ul>
<li>模式切换： setTaskExecutor(Executor taskExecutor)
<ul>
<li>默认模式：同步</li>
<li>异步模式：如java.util.concurrent.ThreadPoolExecutor</li>
</ul>
</li>
<li>设计缺陷：非基于接口契约编程</li>
</ul>
<p>基于编码的同步和异步事件广播示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncEventHandlerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> MySpringEventListener());</span><br><span class="line"></span><br><span class="line">        context.refresh(); <span class="comment">// 初始化 ApplicationEventMulticaster</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 依赖查找 ApplicationEventMulticaster</span></span><br><span class="line">        ApplicationEventMulticaster applicationEventMulticaster = context.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (applicationEventMulticaster <span class="keyword">instanceof</span> SimpleApplicationEventMulticaster) &#123;</span><br><span class="line">            SimpleApplicationEventMulticaster simpleApplicationEventMulticaster = (SimpleApplicationEventMulticaster) applicationEventMulticaster;</span><br><span class="line">            <span class="comment">//切换 taskExecutor</span></span><br><span class="line">            ExecutorService taskExecutor = Executors.newSingleThreadExecutor(<span class="keyword">new</span> CustomizableThreadFactory(<span class="string">&quot;my-spring-event-thread-pool&quot;</span>));</span><br><span class="line">            <span class="comment">// 同步 -&gt; 异步</span></span><br><span class="line">            simpleApplicationEventMulticaster.setTaskExecutor(taskExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加ContextClosedEvent事件处理</span></span><br><span class="line">            applicationEventMulticaster.addApplicationListener(<span class="keyword">new</span> ApplicationListener&lt;ContextClosedEvent&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!taskExecutor.isShutdown()) &#123;</span><br><span class="line">                        taskExecutor.shutdown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;hello,world&quot;</span>));</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了这种编码的方式，还可以通过注解的方式。</p>
<p>基于注解 - org.springframework.context.event.EventListener</p>
<ul>
<li>模式切换
<ul>
<li>默认模式：同步</li>
<li>异步模式：标注@org.springframework.scheduling.annotation.Async</li>
</ul>
</li>
<li>实现限制：无法直接实现同步/异步动态切换</li>
</ul>
<p>基于注解方式的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 激活Spring异步特性</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedAsyncEventHandlerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(AnnotatedAsyncEventHandlerDemo.class);</span><br><span class="line"></span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> MySpringEventListener());</span><br><span class="line"></span><br><span class="line">        context.refresh(); <span class="comment">// 初始化 ApplicationEventMulticaster</span></span><br><span class="line">        context.publishEvent(<span class="keyword">new</span> MySpringEvent(<span class="string">&quot;hello,world&quot;</span>));</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(MySpringEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[线程：%s] : %s\n&quot;</span>, Thread.currentThread().getName(), event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExecutorService taskExecutor = newSingleThreadExecutor(<span class="keyword">new</span> CustomizableThreadFactory(<span class="string">&quot;my-spring-event-thread-pool-a&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring事件异常处理"><a class="markdownIt-Anchor" href="#spring事件异常处理"></a> Spring事件异常处理</h2>
<p>Spring3.0错误处理接口 - org.springframework.util.ErrorHandler</p>
<p>使用场景：</p>
<ul>
<li>Spring事件（Events）
<ul>
<li>SimpleApplicationEventMulticaster Spring 4.1开始支持</li>
</ul>
</li>
<li>Spring本地调度（Scheduling）
<ul>
<li>org.springframework.scheduling.concurrent.ConcurrentTaskScheduler</li>
<li>org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler</li>
</ul>
</li>
</ul>
<p>实现的核心代码在SimpleApplicationEventMulticaster#invokeListener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeListener</span><span class="params">(ApplicationListener&lt;?&gt; listener, ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">		ErrorHandler errorHandler = getErrorHandler();</span><br><span class="line">		<span class="keyword">if</span> (errorHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				doInvokeListener(listener, event);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">				errorHandler.handleError(err);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			doInvokeListener(listener, event);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring事件监听实现原理"><a class="markdownIt-Anchor" href="#spring事件监听实现原理"></a> Spring事件/监听实现原理</h2>
<p>核心类 - org.springframework.context.event.SimpleApplicationEventMulticaster</p>
<ul>
<li>设计模式：观察者模式扩展
<ul>
<li>被观察者 - org.springframework.context.ApplicationListener
<ul>
<li>API添加</li>
<li>依赖查找</li>
</ul>
</li>
<li>通知对象 - org.springframework.context.ApplicationEvent</li>
</ul>
</li>
<li>执行模式：同步/异步</li>
<li>异常处理：org.springframework.util.ErrorHandler</li>
<li>泛型处理：org.springframework.core.ResolvableType</li>
</ul>
<blockquote>
<p>监听事件的时候，Spring还会处理ApplicationEvent的子孙类，包含所有层次的事件。</p>
</blockquote>
<h2 id="springboot事件"><a class="markdownIt-Anchor" href="#springboot事件"></a> SpringBoot事件</h2>
<p>SpringBoot事件</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>发生时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>ApplicationStartingEvent</td>
<td>当SpringBoot应用已启动时</td>
</tr>
<tr>
<td>ApplicationStartedEvent</td>
<td>当SpringBoot应用已启动时</td>
</tr>
<tr>
<td>ApplicationEnvironmentPreparedEvent</td>
<td>当SpringBoot Environment实例已准备时</td>
</tr>
<tr>
<td>ApplicationPreparedEvent</td>
<td>当SpringBoot应用预备时</td>
</tr>
<tr>
<td>ApplicationReadyEvent</td>
<td>当SpringBoot应用完全可用时</td>
</tr>
<tr>
<td>ApplicationFailedEvent</td>
<td>当SpringBoot应用启动失败时</td>
</tr>
</tbody>
</table>
<p>SpringCloud事件</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>发生时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>EnvironmentChangeEvent</td>
<td>当Environment示例配置属性发生变化时</td>
</tr>
<tr>
<td>HeartbeatEvent</td>
<td>当DiscoveryClient客户端发送心跳时</td>
</tr>
<tr>
<td>InstancePreRegisteredEvent</td>
<td>当服务实例注册前</td>
</tr>
<tr>
<td>InstanceRegisteredEvent</td>
<td>当服务实例注册后</td>
</tr>
<tr>
<td>RefreshEvent</td>
<td>当RefreshEndpoint被调用时</td>
</tr>
<tr>
<td>RefreshScopedRefreshedEvent</td>
<td>当Refresh Scope Bean刷新后</td>
</tr>
</tbody>
</table>
<h2 id="面试题-17"><a class="markdownIt-Anchor" href="#面试题-17"></a> 面试题</h2>
<h3 id="spring事件核心接口组件"><a class="markdownIt-Anchor" href="#spring事件核心接口组件"></a> Spring事件核心接口/组件？</h3>
<ul>
<li>Spring事件 - org.springframework.context.ApplicationEvent</li>
<li>Spring事件监听器 -  org.springframework.context.ApplicationListener</li>
<li>Spring事件发布器 - org.springframework.context.ApplicationEventPublisher</li>
<li>Spring事件广播器 - org.springframework.context.event.ApplicationEventMulticaster</li>
</ul>
<h2 id="spring同步和异步事件处理的使用场景"><a class="markdownIt-Anchor" href="#spring同步和异步事件处理的使用场景"></a> Spring同步和异步事件处理的使用场景？</h2>
<ul>
<li>Spring同步事件 - 绝大部分Spring使用场景，如ContextRefreshedEvent</li>
<li>Spring异步事件 - 主要  @EventListener与@Async配合，实现异步处理，不阻塞主线程，比如长时间的数据计算任务等。不要轻易调整SimpleApplicationEventMulticaster中关联的taskExecutor对象，除非使用者非常了解Spring事件机制，否则容易出现异常行为。</li>
</ul>
<h2 id="eventlistener的工作原理"><a class="markdownIt-Anchor" href="#eventlistener的工作原理"></a> @EventListener的工作原理</h2>
<p>// …</p>
<h1 id="spring-注解驱动"><a class="markdownIt-Anchor" href="#spring-注解驱动"></a> Spring 注解驱动</h1>
<p>Spring注解驱动的编程发展的大概历程：</p>
<ol>
<li>注解驱动的启蒙时代：Spring Framework 1.x</li>
<li>注解驱动的过渡时代：Spring Framework 2.x</li>
<li>注解驱动的黄金时代：Spring Framework 3.x</li>
<li>注解驱动的完善时代：Spring Framework 4.x</li>
<li>注解驱动的当下时代：Spring Framework 5.x</li>
</ol>
<h2 id="spring核心注解场景分类"><a class="markdownIt-Anchor" href="#spring核心注解场景分类"></a> Spring核心注解场景分类</h2>
<p>Spring模式注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Repository</td>
<td>数据仓库模式注解</td>
<td>2.0</td>
</tr>
<tr>
<td>@Component</td>
<td>通用组件模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Service</td>
<td>服务模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Controller</td>
<td>Web控制器模式注解</td>
<td>2.5</td>
</tr>
<tr>
<td>@Configuration</td>
<td>配置类模式注解</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<p>装配注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@ImportResource</td>
<td>替换XML元素<import></td>
<td>2.5</td>
</tr>
<tr>
<td>@Import</td>
<td>导入Configuration类</td>
<td>2.5</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>扫描指定package下标注Spring模式注解的类</td>
<td>3.1</td>
</tr>
</tbody>
</table>
<p>依赖注入注解：</p>
<table>
<thead>
<tr>
<th>Spring注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Autowired</td>
<td>Bean依赖注入，支持多种依赖查找方式</td>
<td>2.5</td>
</tr>
<tr>
<td>@Qualifer</td>
<td>细粒度的@Autowired依赖查找</td>
<td>2.5</td>
</tr>
</tbody>
</table>
<h2 id="spring注解编程模型"><a class="markdownIt-Anchor" href="#spring注解编程模型"></a> Spring注解编程模型</h2>
<p>编程模型概览：</p>
<ul>
<li>元注解（Meta-Annotations）</li>
<li>Spring模式注解（Stereotype Annotations）</li>
<li>Spring组合注解（Composed Annotations）</li>
<li>Spring注解属性别名和覆盖（Attribute Aliases and Overrides）</li>
</ul>
<h2 id="spring元注解"><a class="markdownIt-Anchor" href="#spring元注解"></a> Spring元注解</h2>
<p>除了直接使用JDK 定义好的注解，我们还可以自定义注解，在JDK 1.5中提供了4个标准的用来对注解类型进行注解的注解类，我们称之为 meta-annotation（元注解），他们分别是：</p>
<ul>
<li>@Target</li>
<li>@Retention</li>
<li>@Documented</li>
<li>@Inherited</li>
</ul>
<p>Target注解的作用是描述注解的使用范围。Reteniton注解的作用是，描述注解保留的时间范围（即：被描述的注解在它所修饰的类中可以被保留到何时）。Documented注解的作用是，描述在使用 javadoc 工具为类生成帮助文档时是否要保留其注解信息。Inherited注解的作用是，使被它修饰的注解具有继承性（如果某个类使用了被@Inherited修饰的注解，则其子类将自动具有该注解）。</p>
<p>除了以上四种标准，还有我们之前提到过的@Repeatable。</p>
<h2 id="spring模式注解"><a class="markdownIt-Anchor" href="#spring模式注解"></a> Spring模式注解</h2>
<p>模式注解是一种注解，这种注解是用于去声明应用中扮演&quot;组件&quot;角色的类，@Component是一种通用的组件注解，标注这个注解的类会被Spring扫描。</p>
<blockquote>
<p>由于注解无法像接口或者类一样继承，因此只能采用使用注解描述注解的方式。</p>
</blockquote>
<p>@Component&quot;派生性&quot;原理：</p>
<ul>
<li>核心组件 - org.springframework.context.annotation.ClassPathBeanDefinitionScanner
<ul>
<li>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider</li>
</ul>
</li>
<li>资源处理 - org.springframework.core.io.support.ResourcePatternResolver</li>
<li>资源 - 类元信息
<ul>
<li>org.springframework.core.type.classreading.MetadataReaderFactory</li>
</ul>
</li>
<li>类元信息 - org.springframework.core.type.ClassMetadata
<ul>
<li>ASM实现 - org.springframework.core.type.classreading.ClassMetadataReadingVisitor</li>
<li>反射实现 - org.springframework.core.type.StandardAnnotationMetadata</li>
</ul>
</li>
<li>注解元信息 - org.springframework.core.type.AnnotationMetadata
<ul>
<li>ASM实现 - org.springframework.core.type.classreading.AnnotationMetadataReadingVisitor</li>
<li>反射实现 - org.springframework.core.type.StandardAnnotationMetadata</li>
</ul>
</li>
</ul>
<p>我们定义一个测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyComponent</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个具有&quot;派生性&quot;的注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">// 元注解，实现@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyComponent &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试是否生效：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;org.jyc.thinking.in.spring.annotation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentScanDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(ComponentScanDemo.class);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="comment">// 从Spring 4.0开始支持多层次@Component派生</span></span><br><span class="line">        TestClass bean = context.getBean(TestClass.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-组合注解"><a class="markdownIt-Anchor" href="#spring-组合注解"></a> Spring 组合注解</h2>
<p>Spring组合注解（Composed Annotations）中的元注允许是Spring模式注解（Stereotype Annotation）与其他Spring功能性注解的任意组合。</p>
<p>比较典型的例子就是在SpringBoot场景中的SpringBootApplication：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring注解属性别名"><a class="markdownIt-Anchor" href="#spring注解属性别名"></a> Spring注解属性别名</h2>
<p>注解属性的别名实际上总共有两种，一种是显性的别名，一种是隐性的别名。</p>
<p>显性的别名比较容易理解，在@ComponentScan中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AliasFor(&quot;basePackages&quot;)</span></span><br><span class="line">String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>此时basePackages和value就互为显性别名，下面是隐性别名的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyComponentScan &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隐形别名,当被元标注的注解中的属性无法表达语义的时候，就需要额外增加attribute属性，如果没有attribute属性，就表示&quot;继承&quot; <span class="doctag">@AliasFor</span>中的注解的属性</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 是注解的一种&quot;多态&quot;，子注解提供了新的属性方法引用&quot;父&quot;（元）注解中的属性方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scanBasePackages -&gt; <span class="doctag">@AliasFor</span> ComponentScan.basePackages.value(显性别名)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@AliasFor</span> ComponentScan.basePackages.value 传递隐形别名,而且这种方式是支持多层次的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @AliasFor(annotation = ComponentScan.class, attribute = &quot;value&quot;)</span></span><br><span class="line"><span class="comment">//    String[] scanBasePackages() default &#123;&#125;;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring注解属性覆盖"><a class="markdownIt-Anchor" href="#spring注解属性覆盖"></a> Spring注解属性覆盖</h2>
<p>属性覆盖也有两种，一种是显性覆盖，一种是隐形覆盖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@MyComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyComponentScan2 &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(annotation = MyComponentScan.class, attribute = &quot;scanBasePackages&quot;)</span></span><br><span class="line">    String[] BasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隐形覆盖</span></span><br><span class="line"><span class="comment">     * 在<span class="doctag">@MyComponentScan</span>中也有scanBasePackages属性，如果注解中存在同名的就会覆盖掉元标注注解中的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显性覆盖</span></span><br><span class="line"><span class="comment">     * packages覆盖了scanBasePackages 同时覆盖了<span class="doctag">@MyComponentScan</span>.scanBasePackages</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;scanBasePackages&quot;)</span></span><br><span class="line">    String[] packages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-enable模块驱动"><a class="markdownIt-Anchor" href="#spring-enable模块驱动"></a> Spring @Enable模块驱动</h2>
<p>@Eanable模块驱动是以@Enabke为前缀的注解驱动编程模型。所谓&quot;模块&quot;是指具备相同领域的功能组件的集合，组合形成一个独立的单元，比如Web MVC模块、AspectJ代理模块、Caching（缓存）模块、JMX（Java 扩展模块）、Async（异步处理）模块等。</p>
<p>举例说明：</p>
<ul>
<li>@EnableWebMvc</li>
<li>@EnableTranscationManagement</li>
<li>@EnableCaching</li>
<li>@EnableMBeanExport</li>
<li>@EnaleAsync</li>
</ul>
<p>除了框架内建的这些实现，我们还可以自定义@Eanable模块：</p>
<ol>
<li>驱动注解：@Enable***</li>
<li>导入注解：@Import具体实现</li>
<li>具体以下三种实现均可：
<ul>
<li>基于Configuration Class</li>
<li>基于@ImportSelector</li>
<li>基于@ImportBeanDefinitionRegistar接口实现</li>
</ul>
</li>
</ol>
<p>首先演示第一种基于配置类实现，首先定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(HelloWorldConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableHelloWorld &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后定义相对应的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后进行测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHelloWorld</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableModuleDemo</span> </span>&#123; <span class="comment">// 第一步：通过@Enable**命名</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(EnableModuleDemo.class);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        String bean = context.getBean(<span class="string">&quot;helloWorld&quot;</span>, String.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种实现，首先定义ImportSelector的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">&quot;org.jyc.thinking.in.spring.annotation.HelloWorldConfiguration&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加到@Enable注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="comment">// 第二步：通过@Import注解导入具体实现</span></span><br><span class="line"><span class="comment">//@Import(HelloWorldConfiguration.class)</span></span><br><span class="line"><span class="comment">// 方法二：通过@ImportSelector接口实现</span></span><br><span class="line"><span class="meta">@Import(HelloWorldImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableHelloWorld &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三种实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        AnnotatedGenericBeanDefinition beanDefinition = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(HelloWorldConfiguration.class);</span><br><span class="line">        BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition,registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，添加到@Enable注解上面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="comment">// 第二步：通过@Import注解导入具体实现</span></span><br><span class="line"><span class="comment">//@Import(HelloWorldConfiguration.class)</span></span><br><span class="line"><span class="comment">// 方法二：通过@ImportSelector接口实现</span></span><br><span class="line"><span class="comment">//@Import(HelloWorldImportSelector.class)</span></span><br><span class="line"><span class="comment">//方法三：通过 ImportBeanDefinitionRegistrar</span></span><br><span class="line"><span class="meta">@Import(HelloWorldImportBeanDefinitionRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableHelloWorld &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring条件注解"><a class="markdownIt-Anchor" href="#spring条件注解"></a> Spring条件注解</h2>
<p>Spring的条件注解主要有两种：</p>
<ul>
<li>基于配置条件注解 - @org.springframework.context.annotation.Profile
<ul>
<li>关联对象 - org.springframework.core.env.Environment</li>
<li>实现变化：从Spring 4.0开始，@Profile基于@Conditional实现</li>
</ul>
</li>
<li>基于编程条件注解 - org.springframework.context.annotation.Conditional
<ul>
<li>关联对象 - org.springframework.context.annotation.Condition具体实现</li>
</ul>
</li>
</ul>
<p>@Condtional实现原理大致如下：</p>
<ul>
<li>上下文对象 - org.springframework.context.annotation.ConditionContext</li>
<li>条件判断 - org.springframework.context.annotation.ConditionEvaluator</li>
<li>配置阶段 - org.springframework.context.annotation.ConfigurationCondition.ConfigurationPhase</li>
<li>判断入口 - org.springframework.context.annotation.ConfigurationClassPostProcessor
<ul>
<li>org.springframework.context.annotation.ConfigurationClassParser</li>
</ul>
</li>
</ul>
<p>Profile注解的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(ProfileDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Environment对象</span></span><br><span class="line">        ConfigurableEnvironment environment = context.getEnvironment();</span><br><span class="line">        <span class="comment">// 默认的Profiles = [&quot;odd&quot;]</span></span><br><span class="line">        environment.setDefaultProfiles(<span class="string">&quot;odd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加活跃的Profiles</span></span><br><span class="line">        environment.setActiveProfiles(<span class="string">&quot;even&quot;</span>);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        Integer number = context.getBean(<span class="string">&quot;number&quot;</span>, Integer.class);</span><br><span class="line">        System.out.println(number);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;number&quot;)</span></span><br><span class="line">    <span class="meta">@Profile(&quot;odd&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">odd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;number&quot;)</span></span><br><span class="line"><span class="comment">//    @Profile(&quot;even&quot;)</span></span><br><span class="line">    <span class="meta">@Conditional(EventProfileCondition.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">even</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上@Conditional注解的使用也可能会用到Profile属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventProfileCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 条件上下文</span></span><br><span class="line">        Environment environment = context.getEnvironment();</span><br><span class="line">        <span class="keyword">return</span> environment.acceptsProfiles(<span class="string">&quot;even&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Profile在Spring 4当中的实现方式：</p>
<p>基于org.springframework.context.annotation.Condition接口实现：org.springframework.context.annotation.ProfileCondition，实现的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">		MultiValueMap&lt;String, Object&gt; attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());</span><br><span class="line">		<span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Object value : attrs.get(<span class="string">&quot;value&quot;</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (context.getEnvironment().acceptsProfiles(Profiles.of((String[]) value))) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="springboot和springcloud注解"><a class="markdownIt-Anchor" href="#springboot和springcloud注解"></a> SpringBoot和SpringCloud注解</h2>
<p>SpringBoot注解：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@SpringBootConfiguration</td>
<td>Spring Boot配置类</td>
<td>1.4.0</td>
</tr>
<tr>
<td>@SpringBootApplication</td>
<td>Spring Boot应用引导注解</td>
<td>1.2.0</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>Spring Boot激活自动装配</td>
<td>1.0.0</td>
</tr>
</tbody>
</table>
<p>SpringCloud注解：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>场景说明</th>
<th>起始版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>@SpringCloudApplication</td>
<td>Spring Cloud应用引导注解</td>
<td>1.0.0</td>
</tr>
<tr>
<td>@EnableDiscovertClient</td>
<td>Spring Cloud激活服务发现客户端注解</td>
<td>1.0.0</td>
</tr>
<tr>
<td>@EnableCircuitBreaker</td>
<td>Spring Cloud激活熔断注解</td>
<td>1.0.0</td>
</tr>
</tbody>
</table>
<h2 id="面试题-18"><a class="markdownIt-Anchor" href="#面试题-18"></a> 面试题</h2>
<h3 id="spring模式注解有哪些"><a class="markdownIt-Anchor" href="#spring模式注解有哪些"></a> Spring模式注解有哪些？</h3>
<ul>
<li>@Compenent</li>
<li>@Resository</li>
<li>@Service</li>
<li>@Controller</li>
<li>@Configuration</li>
</ul>
<h3 id="eventlistener的工作原理-2"><a class="markdownIt-Anchor" href="#eventlistener的工作原理-2"></a> @EventListener的工作原理？</h3>
<p>源码导读 - org.springframework.context.event.EventListenerMethodProcessor</p>
<h3 id="propertysource工作原理"><a class="markdownIt-Anchor" href="#propertysource工作原理"></a> @PropertySource工作原理</h3>
<p>// …</p>
<h1 id="spring-environment抽象"><a class="markdownIt-Anchor" href="#spring-environment抽象"></a> Spring Environment抽象</h1>
<p>Environment接口主要有以下两个作用：</p>
<ol>
<li>
<p>统一的Spring配置属性管理</p>
<p>SpringFramework 3.1开始引入Environment抽象，它统一Spring配置属性的存储，包括占位符处理和类型转换，不仅完整地替换PropertyPlaceholderConfigurer，而且还支持更丰富的配置属性源（PropertySource）</p>
</li>
<li>
<p>条件化Spring Bean装配管理</p>
<p>通过Environment Profiles信息，帮助Spring容器提供条件化地装配Bean</p>
</li>
</ol>
<h2 id="environment接口使用场景"><a class="markdownIt-Anchor" href="#environment接口使用场景"></a> Environment接口使用场景</h2>
<ul>
<li>用于属性占位符处理</li>
<li>用于转换Spring配置属性类型</li>
<li>用于存储Spring配置属性源（PropertySource）</li>
<li>用于Profiles状态维护</li>
</ul>
<h2 id="environment占位符处理"><a class="markdownIt-Anchor" href="#environment占位符处理"></a> Environment占位符处理</h2>
<p>不同Spring版本Environment对于占位符处理有所差异：</p>
<ul>
<li>Spring 3.1前占位符处理
<ul>
<li>组件：org.springframework.beans.factory.config.PropertyPlaceholderConfigurer</li>
<li>接口：org.springframework.util.StringValueResolver</li>
</ul>
</li>
<li>Spring 3.1+占位符处理：
<ul>
<li>组件：org.springframework.context.support.PropertySourcesPlaceholderConfigurer</li>
<li>接口：org.springframework.beans.factory.config.EmbeddedValueResolver</li>
</ul>
</li>
</ul>
<p>我们可以来看以下具体地使用场景，首先定义一个properties文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">user.id</span>=<span class="string">11111</span></span><br><span class="line"><span class="meta">user.name</span>=<span class="string">jjjj</span></span><br><span class="line"><span class="meta">user.city</span>=<span class="string">HANGZHOU</span></span><br></pre></td></tr></table></figure>
<p>紧接着定义需要注入的Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;location&quot; value=&quot;classpath:/META-INF/default.properties&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;fileEncoding&quot; value=&quot;UTF-8&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;/bean&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.support.PropertySourcesPlaceholderConfigurer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;location&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:/META-INF/default.properties&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;fileEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.jyc.thinking.in.spring.ioc.overview.dependency.domain.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;user.id&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;user.name&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;city&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;user.city&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后观察输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyPlaceholderConfigurerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:/META-INF/placeholders-resolver.xml&quot;</span>);</span><br><span class="line">        User user = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到占位符已经被成功的替换。</p>
<h2 id="理解条件配置spring-profiles"><a class="markdownIt-Anchor" href="#理解条件配置spring-profiles"></a> 理解条件配置Spring Profiles</h2>
<p>Spring3.1的条件配置：</p>
<ul>
<li>API：org.springframework.core.env.ConfigurableEnvironment
<ul>
<li>修改：addActiveProfile(String)、SetActiveProfiles(String…)和setDefaultProfiles(String…)</li>
<li>获取：getActiveProfiles()和getDefaultProfiles</li>
<li>匹配：#acceptsProfiles(String…)和acceptsProfiles(Profiles)</li>
</ul>
</li>
<li>注解：org.springframework.context.annotation.Profile</li>
</ul>
<blockquote>
<p>在Spring当中，也可以通过<code>-Dspring.profiles.active</code>来修改当前的激活环境。</p>
</blockquote>
<h2 id="依赖注入environment"><a class="markdownIt-Anchor" href="#依赖注入environment"></a> 依赖注入Environment</h2>
<ol>
<li>注解注入：
<ul>
<li>通过EnvironmentAware接口回调</li>
<li>通过@Autowired注入Environment</li>
</ul>
</li>
<li>间接依赖注入：
<ul>
<li>通过ApplicationAware接口回调</li>
<li>通过@Autowired注入ApplicationContext</li>
</ul>
</li>
</ol>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectingEnvironmentDemo</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment environment2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(InjectingEnvironmentDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        InjectingEnvironmentDemo injectingEnvironmentDemo = context.getBean(InjectingEnvironmentDemo.class);</span><br><span class="line">        System.out.println(injectingEnvironmentDemo.environment);</span><br><span class="line"></span><br><span class="line">        System.out.println(injectingEnvironmentDemo.environment == injectingEnvironmentDemo.environment2);</span><br><span class="line"></span><br><span class="line">        System.out.println(context == injectingEnvironmentDemo.applicationContext);</span><br><span class="line"></span><br><span class="line">        System.out.println(injectingEnvironmentDemo.environment == context.getEnvironment());</span><br><span class="line">         </span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="依赖查找environment"><a class="markdownIt-Anchor" href="#依赖查找environment"></a> 依赖查找Environment</h2>
<ol>
<li>直接依赖查找
<ul>
<li>通过org.springframework.context.ConfigurableApplicationContext#ENVIRONMENT_BEAN_NAME</li>
</ul>
</li>
<li>直接查找
<ul>
<li>通过org.springframework.context.ConfigurableApplicationContext#getEnvironment</li>
</ul>
</li>
</ol>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupEnvironmentDemo</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(LookupEnvironmentDemo.class);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        LookupEnvironmentDemo injectingEnvironmentDemo = context.getBean(LookupEnvironmentDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过Environment Bean名称依赖查找</span></span><br><span class="line">        Environment environment = context.getBean(ConfigurableApplicationContext.ENVIRONMENT_BEAN_NAME, Environment.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(injectingEnvironmentDemo.environment);</span><br><span class="line"></span><br><span class="line">        System.out.println(injectingEnvironmentDemo.environment == environment);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以发现依赖查找和依赖注入的Environment都是同一个，Environment对象本身隶属于ApplicationContext，但是在容器启动的时候，会注册一个单例的Environment对象到BeanFactory中。</p>
</blockquote>
<h2 id="依赖注入value"><a class="markdownIt-Anchor" href="#依赖注入value"></a> 依赖注入@Value</h2>
<p>@Value注解的实现类：org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor</p>
<h2 id="spring类型转换在environment中的运用"><a class="markdownIt-Anchor" href="#spring类型转换在environment中的运用"></a> Spring类型转换在Environment中的运用</h2>
<p>Environment底层实现：</p>
<ul>
<li>底层实现 - org.springframework.core.env.PropertySourcesPropertyResolver
<ul>
<li>核心方法 - convertValueIfNecessary</li>
</ul>
</li>
<li>底层服务 - org.springframework.core.convert.ConversionService
<ul>
<li>默认实现 - org.springframework.core.convert.support.DefaultConversionService</li>
</ul>
</li>
</ul>
<p>相关的核心源代码：</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210625173747553.png" alt="image-20210625173747553" style="zoom: 67%;" />
<h2 id="spring类型转换在value中的运用"><a class="markdownIt-Anchor" href="#spring类型转换在value中的运用"></a> Spring类型转换在@Value中的运用</h2>
<p>@Value底层实现：</p>
<ol>
<li>底层实现：org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor
<ul>
<li>org.springframework.beans.factory.support.DefaultListableBeanFactory#doResolveDependency</li>
</ul>
</li>
<li>底层服务：org.springframework.beans.TypeConverter
<ul>
<li>默认实现：org.springframework.beans.TypeConverterDelegate
<ul>
<li>java.beans.PropertyEditor</li>
<li>org.springframework.core.convert.ConversionService</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>相关的核心源代码：</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210625174810362.png" alt="image-20210625174810362" style="zoom: 50%;" />
<h2 id="spring配置属性源propertysource"><a class="markdownIt-Anchor" href="#spring配置属性源propertysource"></a> Spring配置属性源PropertySource</h2>
<ul>
<li>
<p>API</p>
<ul>
<li>单配置属性源：org.springframework.core.env.PropertySource</li>
<li>多配置属性源：org.springframework.core.env.PropertySources</li>
</ul>
</li>
<li>
<p>注解</p>
<ul>
<li>单配置属性源：org.springframework.context.annotation.PropertySource</li>
<li>多配置属性源：org.springframework.context.annotation.PropertySources</li>
</ul>
</li>
<li>
<p>关联</p>
<ul>
<li>存储对象：org.springframework.core.env.MutablePropertySources</li>
<li>关联方法：org.springframework.core.env.ConfigurableEnvironment#getPropertySources</li>
</ul>
</li>
</ul>
<h2 id="spring内建的配置属性源"><a class="markdownIt-Anchor" href="#spring内建的配置属性源"></a> Spring内建的配置属性源</h2>
<p>内建的PropertySource:</p>
<table>
<thead>
<tr>
<th>PropertySource类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>org.springframework.core.env.CommandLinePropertySource</td>
<td>命令行配置属性源</td>
</tr>
<tr>
<td>org.springframework.jndi.JndiPropertySource</td>
<td>JNDI配置属性源</td>
</tr>
<tr>
<td>org.springframework.core.env.PropertiesPropertySource</td>
<td>Properties配置属性源</td>
</tr>
<tr>
<td>org.springframework.web.context.support.ServletConfigPropertySource</td>
<td>Servlet配置属性源</td>
</tr>
<tr>
<td>org.springframework.web.context.support.ServletContextPropertySource</td>
<td>ServletContext配置属性源</td>
</tr>
<tr>
<td>org.springframework.core.env.SystemEnvironmentPropertySource</td>
<td>环境变量配置属性源</td>
</tr>
<tr>
<td>…</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="基于注解扩展spring配置属性源"><a class="markdownIt-Anchor" href="#基于注解扩展spring配置属性源"></a> 基于注解扩展Spring配置属性源</h2>
<p>@org.springframework.context.annotation.PropertySource实现原理：</p>
<ul>
<li>入口 - org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass
<ul>
<li>org.springframework.context.annotation.ConfigurationClassParser#processPropertySource</li>
</ul>
</li>
<li>4.3新增语义
<ul>
<li>配置属性字符编码 - encoding</li>
<li>org.springframework.core.io.support.PropertySourceFactory</li>
</ul>
</li>
<li>适配对象 - org.springframework.core.env.CompositePropertySource</li>
</ul>
<blockquote>
<p>默认只支持properties格式的文件，可以通过PropertySourceFactory进行扩展。</p>
</blockquote>
<h2 id="基于api扩展spring配置属性源"><a class="markdownIt-Anchor" href="#基于api扩展spring配置属性源"></a> 基于API扩展Spring配置属性源</h2>
<p>PropertySource的配置实际上有两种类型：</p>
<ul>
<li>Spring应用上下文启动前装配PropertySource</li>
<li>Spring应用上下文启动后装配PropertySource</li>
</ul>
<p>基于API扩展的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnvironmentPropertySourceChangeDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String UserName; <span class="comment">// 不具备动态更新地能力</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// propertySource(“first-property-source”) &#123;user.name = 吉永超&#125;</span></span><br><span class="line">    <span class="comment">// propertySource(Java System Properties) &#123;user.name = jyc&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">        context.register(EnvironmentPropertySourceChangeDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在Spring应用上下文启动之前，调整Environment中的PropertySource</span></span><br><span class="line">        ConfigurableEnvironment environment = context.getEnvironment();</span><br><span class="line">        <span class="comment">// 获取MutablePropertySources 对象</span></span><br><span class="line">        MutablePropertySources propertySources = environment.getPropertySources();</span><br><span class="line">        <span class="comment">// 动态地插入PropertySource到PropertySources</span></span><br><span class="line">        HashMap&lt;String, Object&gt; source = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        source.put(<span class="string">&quot;user.name&quot;</span>, <span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line">        MapPropertySource propertySource = <span class="keyword">new</span> MapPropertySource(<span class="string">&quot;first-property-source&quot;</span>, source);</span><br><span class="line">        propertySources.addFirst(propertySource);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        source.put(<span class="string">&quot;user.name&quot;</span>, <span class="string">&quot;007&quot;</span>);</span><br><span class="line">        EnvironmentPropertySourceChangeDemo environmentPropertySourceChangeDemo = context.getBean(EnvironmentPropertySourceChangeDemo.class);</span><br><span class="line">        System.out.println(environmentPropertySourceChangeDemo.UserName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (PropertySource ps : propertySources) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;PropertySource(name=%s),&#x27;user.name&#x27;属性=%s\n&quot;</span>, ps.getName(), ps.getProperty(<span class="string">&quot;user.name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-测试配置属性源"><a class="markdownIt-Anchor" href="#spring-测试配置属性源"></a> Spring 测试配置属性源</h2>
<p>Spring 4.1测试配置属性源 - @TestPropertySource</p>
<p>相关的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = TestPropertySourceDemo.class)</span> <span class="comment">//Spring 注解驱动测试注解</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &quot;user.name=吉永超&quot;)</span>  <span class="comment">// PropertySource(name=Inlined Test Properties)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPropertySourceDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> TestPropertySourceDemo().userName);</span><br><span class="line">        <span class="keyword">for</span> (PropertySource ps : environment.getPropertySources()) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;PropertySource(name=%s),&#x27;user.name&#x27;属性=%s\n&quot;</span>, ps.getName(), ps.getProperty(<span class="string">&quot;user.name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到@TestPropertySource来源的优先级相当的高。</p>
<h2 id="面试题-19"><a class="markdownIt-Anchor" href="#面试题-19"></a> 面试题</h2>
<h3 id="简单介绍spring-environment接口"><a class="markdownIt-Anchor" href="#简单介绍spring-environment接口"></a> 简单介绍Spring Environment接口？</h3>
<ul>
<li>核心接口 - org.springframework.core.env.Environment</li>
<li>父接口 - org.springframework.core.env.PropertyResolver</li>
<li>可配置接口 - org.springframework.core.env.ConfigurableEnvironment</li>
<li>职责：
<ul>
<li>管理Spring配置属性源</li>
<li>管理Profiles</li>
</ul>
</li>
</ul>
<h3 id="如何控制propertysource的优先级"><a class="markdownIt-Anchor" href="#如何控制propertysource的优先级"></a> 如何控制PropertySource的优先级？</h3>
<p>可以通过相关的Spring相关的API进行操作</p>
<h3 id="environment完整的生命周期是怎样的"><a class="markdownIt-Anchor" href="#environment完整的生命周期是怎样的"></a> Environment完整的生命周期是怎样的？</h3>
<p>// …</p>
<h1 id="spring-应用上下文生命周期"><a class="markdownIt-Anchor" href="#spring-应用上下文生命周期"></a> Spring 应用上下文生命周期</h1>
<h2 id="spring应用上下文启动准备阶段"><a class="markdownIt-Anchor" href="#spring应用上下文启动准备阶段"></a> Spring应用上下文启动准备阶段</h2>
<p>org.springframework.context.support.AbstractApplicationContext#prepareRefresh方法：</p>
<ul>
<li>启动时间 - startupDate</li>
<li>状态标志 - closed(false)、active(true)</li>
<li>初始化 PropertySources - initPropertySources()</li>
<li>校验Environment中必须属性</li>
<li>初始化事件监听器集合</li>
<li>初始化早期Spring事件集合</li>
</ul>
<p>相关的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Switch to active.</span></span><br><span class="line">	<span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">	<span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">	<span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line">	initPropertySources();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">	<span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">	getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">		<span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">		<span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">	<span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">	<span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beanfactory创建阶段"><a class="markdownIt-Anchor" href="#beanfactory创建阶段"></a> BeanFactory创建阶段</h2>
<p>AbstractApplicationContext#obtainFreshBeanFactory方法：</p>
<ul>
<li>刷新Spring应用上下文底层BeanFactory - refreshBeanFactory()
<ul>
<li>销毁或关闭BeanFactory，如果已存在的话</li>
<li>创建BeanFactory - createBeanFactory()</li>
<li>设置BeanFactory Id</li>
<li>设置&quot;是否允许BeanDefinition重复定义&quot; - customizeBeanFactory(DefaultListableBeanFactory)</li>
<li>设置&quot;是否允许循环应用（依赖）&quot; - customizeBeanFactory(DefaultListableBeanFactory)</li>
<li>加载BeanDefinition - loadBeanDefinitions(DefaultListableBeanFactory beanFactory)</li>
<li>关联新建BeanFactory到Spring应用上下文</li>
</ul>
</li>
<li>返回Spring应用上下文底层BeanFactory - getBeanFactory</li>
</ul>
<p>可以在AbstractRefreshableApplicationContext看到具体的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">		destroyBeans();</span><br><span class="line">		closeBeanFactory();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">		beanFactory.setSerializationId(getId());</span><br><span class="line">		customizeBeanFactory(beanFactory);</span><br><span class="line">		loadBeanDefinitions(beanFactory);</span><br><span class="line">		<span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beanfactory准备阶段"><a class="markdownIt-Anchor" href="#beanfactory准备阶段"></a> BeanFactory准备阶段</h2>
<p>AbstractApplicationContext#prepareBeanFactory(ConfigurableListableBeanFactory)方法：</p>
<ul>
<li>关联ClassLoader</li>
<li>设置Bean表达式处理器</li>
<li>添加PropertyEdittorRegistrar实现 - ResourceEditorRegistrar</li>
<li>添加Aware回调接口BeanPostProcessor实现 - ApplicationContextAwareProcessor</li>
<li>忽略Aware回调接口作为依赖注入接口</li>
<li>注册ResolvableDependency对象 - BeanFactory、ResourceLoader、ApplicationEventPublisher以及ApplicationContext</li>
<li>注册ApplicationListenerDetector对象</li>
<li>注册LoadTimeWeaverAwareProcessor对象</li>
<li>注册单例对象 - Environment、Java System Properties、以及OS环境变量</li>
</ul>
<p>相关的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line">	beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">	<span class="keyword">if</span> (!shouldIgnoreSpel) &#123;</span><br><span class="line">		beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">	&#125;</span><br><span class="line">	beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line">	beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">	beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">	beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">	<span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line">	beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">	beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">	beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">	beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">	beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">	<span class="keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">		<span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">		beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register default environment beans.</span></span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">		beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">		beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">		beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;</span><br><span class="line">		beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beanfactory后置处理阶段"><a class="markdownIt-Anchor" href="#beanfactory后置处理阶段"></a> BeanFactory后置处理阶段</h2>
<p>AbstractApplicationContext#postProcessBeanFactory(ConfigurableListableBeanFactory)方法</p>
<ul>
<li>由子类覆盖该方法</li>
</ul>
<p>AbstractApplicationContext#invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory)方法：</p>
<ul>
<li>调用BeanFactoryPostProcessor或BeanDefinitionPostProcessorRegistry后置处理方法</li>
<li>注册LoadTimeWeaverAwareProcessor对象</li>
</ul>
<blockquote>
<p>通常情况下，我们应该选择第二种方式，组合优先于继承。</p>
</blockquote>
<p>相关的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">		<span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line">		<span class="keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">			beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">			beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beanfactory注册beanpostprocess"><a class="markdownIt-Anchor" href="#beanfactory注册beanpostprocess"></a> BeanFactory注册BeanPostProcess</h2>
<p>AbstractApplicationContext#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory)方法：</p>
<ul>
<li>注册PriorityOrdered类型的BeanPostProcessor Beans</li>
<li>注册Ordered类型的BeanPostProcessor Beans</li>
<li>注册普通BeanPostProcessor Beans</li>
<li>注册MergedBeanDefinitionPostProcessor Beans</li>
<li>注册ApplicationListenerDetector对象</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line">		<span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line">		<span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line">		<span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">		<span class="comment">// Ordered, and the rest.</span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">			<span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                    <span class="comment">// 特别要注意，这里会导致Bean的提前初始化</span></span><br><span class="line">				BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">				priorityOrderedPostProcessors.add(pp);</span><br><span class="line">				<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">					internalPostProcessors.add(pp);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">				orderedPostProcessorNames.add(ppName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">		<span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">               <span class="comment">// 这里也会初始化</span></span><br><span class="line">			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">			orderedPostProcessors.add(pp);</span><br><span class="line">			<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">				internalPostProcessors.add(pp);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">		<span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">			nonOrderedPostProcessors.add(pp);</span><br><span class="line">			<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">				internalPostProcessors.add(pp);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line">		sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">		<span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化内建messagesource"><a class="markdownIt-Anchor" href="#初始化内建messagesource"></a> 初始化内建MessageSource</h2>
<p>AbstractApplicationContext#initMessageSource方法：</p>
<ul>
<li>第十二章Spring国际化 - MessageSource内建依赖</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">	<span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">		<span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">		<span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">			HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">			<span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">				<span class="comment">// registered already.</span></span><br><span class="line">				hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line">		DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">		dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">		<span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">		beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化内建spring事件广播器"><a class="markdownIt-Anchor" href="#初始化内建spring事件广播器"></a> 初始化内建Spring事件广播器</h2>
<p>AbstractApplicationContext#initApplicationEventMulticaster方法：</p>
<ul>
<li>第十七章Spring事件 - ApplicationEventMulticaster底层实现</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">		<span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">					beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">			beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">						<span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到在Spring的应用上下文中，ApplicationEventMulticaster这个对象一定会存在，因此我们可以使用依赖注入的方式获取到唯一的对象ApplicationEventMulticaster的对象。</p>
</blockquote>
<h2 id="spring应用上下文刷新"><a class="markdownIt-Anchor" href="#spring应用上下文刷新"></a> Spring应用上下文刷新</h2>
<p>AbstractApplicationContext#onRefresh方法：</p>
<ul>
<li>org.springframework.web.context.support.AbstractRefreshableWebApplicationContext#onRefresh</li>
<li>org.springframework.web.context.support.GenericWebApplicationContext#onRefresh</li>
<li>org.springframework.boot.web.reactive.context.ReactiveWebServerApplicationContext#onRefresh</li>
<li>org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#onRefresh</li>
<li>org.springframework.web.context.support.StaticWebApplicationContext#onRefresh</li>
</ul>
<blockquote>
<p>onRefresh()方法只有在Web的场景下才会进行扩展。</p>
</blockquote>
<h2 id="spring事件监听器注册"><a class="markdownIt-Anchor" href="#spring事件监听器注册"></a> Spring事件监听器注册</h2>
<p>AbstractApplicationContext#registerListeners方法：</p>
<ul>
<li>添加当前应用上下文所关联的ApplicationListeners对象（集合）</li>
<li>添加BeanFactory所注册ApplicationListeners Beans</li>
<li>广播早期Spring事件</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Register statically specified listeners first.</span></span><br><span class="line">		<span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">			getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">		<span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line">		String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">			getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line">		Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">		<span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123;</span><br><span class="line">			<span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">				getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="beanfactory初始化完成阶段"><a class="markdownIt-Anchor" href="#beanfactory初始化完成阶段"></a> BeanFactory初始化完成阶段</h2>
<p>AbstractApplicationContext#finishBeanFactoryInitialization(ConfigurableListableBeanFactory)方法：</p>
<ul>
<li>BeanFactory关联ConversionService Bean，如果存在</li>
<li>添加StringValueResolver对象</li>
<li>依赖查找LoadTimeWeaverAware Bean</li>
<li>BeanFactory临时ClassLoader置为null</li>
<li>BeanFactory冻结配置</li>
<li>BeanFactory初始化非延迟单例Beans</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line">	<span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">			beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">		beanFactory.setConversionService(</span><br><span class="line">				beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register a default embedded value resolver if no BeanFactoryPostProcessor</span></span><br><span class="line">	<span class="comment">// (such as a PropertySourcesPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">	<span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">		beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">	String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">	<span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">		getBean(weaverAwareName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">	beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line">	beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">	beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring应用上下文刷新完成阶段"><a class="markdownIt-Anchor" href="#spring应用上下文刷新完成阶段"></a> Spring应用上下文刷新完成阶段</h2>
<p>AbstractApplicationContext#finishRefresh方法：</p>
<ul>
<li>清除ResourceLoader缓存 - clearResourceCaches() @since 5.0</li>
<li>初始化LifecycleProcessor对象 - initLifecycleProcessor()</li>
<li>调用LifecycleProcessor().onRefresh()方法</li>
<li>发布Spring应用上下文已刷新事件 - ContextRefreshedEvent</li>
<li>向MBeanServer托管Live Beans</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">		clearResourceCaches();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">		initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">		getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Publish the final event.</span></span><br><span class="line">		publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line">		<span class="keyword">if</span> (!NativeDetector.inNativeImage()) &#123;</span><br><span class="line">			LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-应用上下文启动阶段"><a class="markdownIt-Anchor" href="#spring-应用上下文启动阶段"></a> Spring 应用上下文启动阶段</h2>
<p>AbstractApplicationContext#start方法</p>
<ul>
<li>启动LifecycleProcessor
<ul>
<li>依赖查找Lifecycle Beans</li>
<li>启动Lifecycle Beans</li>
</ul>
</li>
<li>发布Spring应用上下文已启动事件 - ContextStartedEvent</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getLifecycleProcessor().start();</span><br><span class="line">		publishEvent(<span class="keyword">new</span> ContextStartedEvent(<span class="keyword">this</span>));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-应用上下文停止阶段"><a class="markdownIt-Anchor" href="#spring-应用上下文停止阶段"></a> Spring 应用上下文停止阶段</h2>
<p>AbstractApplicationContext#stop方法</p>
<ul>
<li>停止LifecycleProcessor
<ul>
<li>依赖查找Lifecycle Beans</li>
<li>停止Lifecycle Beans</li>
</ul>
</li>
<li>发布Spring应用上下文已停止事件 - ContextStoppedEvent</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		getLifecycleProcessor().stop();</span><br><span class="line">		publishEvent(<span class="keyword">new</span> ContextStoppedEvent(<span class="keyword">this</span>));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以自定义一个Lifecycle：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLifecycle</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> running = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        running = <span class="keyword">true</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;org.jyc.thinking.in.spring.lifecycle.MyLifecycle 启动...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;org.jyc.thinking.in.spring.lifecycle.MyLifecycle 停止...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> running;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line">        <span class="comment">// 注册MyLifecycle成为一个Spring Bean</span></span><br><span class="line">        context.registerBeanDefinition(<span class="string">&quot;myLifecycle&quot;</span>, BeanDefinitionBuilder.rootBeanDefinition(MyLifecycle.class).getBeanDefinition());</span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="comment">// 启动应用上下文</span></span><br><span class="line">        context.start();</span><br><span class="line">        <span class="comment">// 关闭Spring应用</span></span><br><span class="line">        context.stop();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring应用上下文关闭阶段"><a class="markdownIt-Anchor" href="#spring应用上下文关闭阶段"></a> Spring应用上下文关闭阶段</h2>
<p>AbstractApplicationContext#close方法:</p>
<ul>
<li>状态标识：active(false)、closed(true)</li>
<li>Live Beans JMX撤销托管
<ul>
<li>LiveBeansView.unregisterApplicationContext(ConfigurableApplicationContext)</li>
</ul>
</li>
<li>发布Spring应用上下文已关闭事件 - ContextClosedEvent</li>
<li>关闭LifecycleProcessor
<ul>
<li>依赖查找Lifecycle Beans</li>
<li>停止Lifecycle Beans</li>
</ul>
</li>
<li>销毁Lifecycle Beans</li>
<li>关闭BeanFactory</li>
<li>回调onClose()</li>
<li>注册Shutdown Hook线程（如果曾注册）</li>
</ul>
<p>相应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Check whether an actual close attempt is necessary...</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.active.get() &amp;&amp; <span class="keyword">this</span>.closed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Closing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!NativeDetector.inNativeImage()) &#123;</span><br><span class="line">			LiveBeansView.unregisterApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// Publish shutdown event.</span></span><br><span class="line">			publishEvent(<span class="keyword">new</span> ContextClosedEvent(<span class="keyword">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			logger.warn(<span class="string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				logger.warn(<span class="string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Destroy all cached singletons in the context&#x27;s BeanFactory.</span></span><br><span class="line">		destroyBeans();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Close the state of this context itself.</span></span><br><span class="line">		closeBeanFactory();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Let subclasses do some final clean-up if they wish...</span></span><br><span class="line">		onClose();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">			<span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Switch to inactive.</span></span><br><span class="line">		<span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里补充一个关于ShutdownHook的示例，通过这种方式可以优雅的停止线程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShutdownHookThreadDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> ApplicationListener&lt;ContextClosedEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;[线程 %s] ContextClosedEvent 处理\n&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        context.refresh();</span><br><span class="line">        context.registerShutdownHook();</span><br><span class="line">        System.out.println(<span class="string">&quot;按任意键继续并且关闭Spring 应用上下文&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="面试题-20"><a class="markdownIt-Anchor" href="#面试题-20"></a> 面试题</h2>
<h3 id="spring应用上下文生命周期有哪些阶段"><a class="markdownIt-Anchor" href="#spring应用上下文生命周期有哪些阶段"></a> Spring应用上下文生命周期有哪些阶段？</h3>
<p>可以简单的回答为：</p>
<ul>
<li>刷新阶段 - ConfigurableApplicationContext#refresh()</li>
<li>启动阶段 - ConfigurableApplicationContext#start()</li>
<li>停止阶段 - ConfigurableApplicationContext#stop()</li>
<li>关闭阶段 - ConfigurableApplicationContext#close()</li>
</ul>
<h3 id="environment完整的生命周期"><a class="markdownIt-Anchor" href="#environment完整的生命周期"></a> Environment完整的生命周期？</h3>
<p>主要分为refresh()方法之前和refresh()方法之后，在refresh()方法之前可以主动填充自定义的Environment对象，在refresh()方法之后会创建默认的Environment对象。</p>
<h1 id="spring-总结"><a class="markdownIt-Anchor" href="#spring-总结"></a> Spring 总结</h1>
<h2 id="spring核心特性-2"><a class="markdownIt-Anchor" href="#spring核心特性-2"></a> Spring核心特性</h2>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210628202410655.png" alt="image-20210628202410655" /></p>
<h2 id="spring核心价值"><a class="markdownIt-Anchor" href="#spring核心价值"></a> Spring核心价值</h2>
<p><img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210628202440062.png" alt="image-20210628202440062" /></p>
<h1 id="附录"><a class="markdownIt-Anchor" href="#附录"></a> 附录</h1>
<h2 id="为什么说objectfactory提供的是延迟依赖查找"><a class="markdownIt-Anchor" href="#为什么说objectfactory提供的是延迟依赖查找"></a> 为什么说ObjectFactory提供的是延迟依赖查找？</h2>
<p>原因：</p>
<ul>
<li>ObjectFactory（或ObjectProvider）可关联某一类型Bean</li>
<li>ObjectFactory（或ObjectProvider）对象在被依赖注入和依赖查询时并未实时查找关联类型Bean</li>
<li>ObjectFactory（或ObjectProvider）调用getObject()方法时，目标Bean才被依赖查找</li>
</ul>
<p>总结：ObjectFactory（或ObjectProvider）相当于某一类型Bean依赖查找代理对象。</p>
<p>这里我们可以编写一个示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectFactoryLazyLookupDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(ObjectFactoryLazyLookupDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        ObjectFactoryLazyLookupDemo demo = context.getBean(ObjectFactoryLazyLookupDemo.class);</span><br><span class="line">        <span class="comment">// 代理对象</span></span><br><span class="line">        ObjectProvider&lt;User&gt; objectProvider = demo.objectProvider;</span><br><span class="line">        ObjectFactory&lt;User&gt; userObjectFactory = demo.userObjectFactory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ObjectFactory和ObjectProvider</span></span><br><span class="line">        System.out.println(<span class="string">&quot;userObjectFactory == objectProvider: &quot;</span> +</span><br><span class="line">                (userObjectFactory == objectProvider));</span><br><span class="line">        <span class="comment">// 结果为true，说明两者的底层实现是一样的。</span></span><br><span class="line">        System.out.println(<span class="string">&quot;userObjectFactory.getClass() == objectProvider.getClass(): &quot;</span> +</span><br><span class="line">                (userObjectFactory.getClass() == objectProvider.getClass()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实际对象(延迟查找)</span></span><br><span class="line">        System.out.println(userObjectFactory.getObject());</span><br><span class="line">        System.out.println(objectProvider.getObject());</span><br><span class="line">        System.out.println(context.getBean(User.class));</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectFactory&lt;User&gt; userObjectFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectProvider&lt;User&gt; objectProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;111111&quot;</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以在DefaultListableBeanFactory.DependencyObjectProvider中看到相关的原理，只有在调用getObject的时候，才会根据泛型的具体化进行依赖查找，创建对象，而不是直接去查找，也就是所谓的延迟依赖查找。</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629102005648.png" alt="image-20210629102005648" style="zoom:50%;" />
<h2 id="依赖查找注入的bean会被缓存嘛"><a class="markdownIt-Anchor" href="#依赖查找注入的bean会被缓存嘛"></a> 依赖查找（注入）的Bean会被缓存嘛？</h2>
<ul>
<li>单例Bean（Singleton）-  会
<ul>
<li>缓存位置：org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjects属性</li>
</ul>
</li>
<li>原型Bean（Prototype）- 不会
<ul>
<li>当依赖查询或依赖注入时，根据BeanDefinition每次创建</li>
</ul>
</li>
<li>其他Scope Bean
<ul>
<li>request：每个ServletRequest内部缓存，生命周期维持在每次HTTP请求</li>
<li>session：每个HttpSeesion内部缓存，生命周期维持在每个用户HTTP会话</li>
<li>application：当前Servlet应用内部缓存</li>
</ul>
</li>
</ul>
<p>相关的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanCachingDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        context.register(BeanCachingDemo.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        BeanCachingDemo beanCachingDemo = context.getBean(BeanCachingDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// singletonBean会被缓存</span></span><br><span class="line">            System.out.println(beanCachingDemo == context.getBean(BeanCachingDemo.class));</span><br><span class="line">        &#125;</span><br><span class="line">        User user = context.getBean(User.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// prototype不会被缓存</span></span><br><span class="line">            System.out.println(user == context.getBean(User.class));</span><br><span class="line">        &#125;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;111111&quot;</span>);</span><br><span class="line">        user.setName(<span class="string">&quot;吉永超&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中单例对象的最为复杂，在DefaultSingletonBeanRegistry#getSingleton中可以看到核心的逻辑：</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629104114854.png" style="zoom: 50%;" />
<p>在每次进行依赖查找（注入）的时候不是直接创建对象，而是会现在缓存的字段singletonObjects中进行获取。</p>
<p>原型作用域的Bean每次在依赖查找（注入）的时候都会根据BeanDefinition重新构建Bean。</p>
<p>总而言之，只有Prototype的Bean不会进行缓存，其他情况下均会进行缓存。Prototype的Bean在被容器创建之后就会与容器脱钩，不再有生命周期等特性。</p>
<h2 id="bean的处理流程是怎样的"><a class="markdownIt-Anchor" href="#bean的处理流程是怎样的"></a> @Bean的处理流程是怎样的？</h2>
<ul>
<li>解析范围 - Configuration Class中的@Bean方法</li>
<li>方法类型 - 静态@Bean方法和实例@Bean方法</li>
</ul>
<p>在找到标注了@Configuration Class的类之后，会获取到所有的@Bean的方法，根据标注的@Bean的方法解析出相应的BeanDefinition，然后创建对象，相关的逻辑在</p>
<p>ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsForBeanMethod方法中，另外在解析静态方法和实例方法的时候，有一些差别：</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629112032376.png" alt="image-20210629112032376" style="zoom:50%;" />
<p>可以看到，如果是实例方法，那么首先要获取到实例方法所在的类的实例，静态方法的初始化会更早。</p>
<h2 id="beanfactory是如何处理循环依赖的"><a class="markdownIt-Anchor" href="#beanfactory是如何处理循环依赖的"></a> BeanFactory是如何处理循环依赖的？</h2>
<p>预备知识：</p>
<ul>
<li>循环依赖开关（方法）- AbstractAutowireCapableBeanFactory#setAllowCircularReferences</li>
<li>单例工程（属性）- DefaultSingletonBeanRegistry#singletonFactories</li>
<li>获取早期未处理Bean（方法） - AbstractAutowireCapableBeanFactory#getEarlyBeanReference</li>
<li>早期未处理Bean（属性） - DefaultSingletonBeanRegistry#earlySingletonObjects</li>
</ul>
<p>循环依赖的示例，首先定义一个学生类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClassRoom classRoom;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassRoom <span class="title">getClassRoom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> classRoom;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassRoom</span><span class="params">(ClassRoom classRoom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classRoom = classRoom;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, classRoom.name=&quot;</span> + classRoom.getName() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后定义一个教室类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassRoom</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;Student&gt; students;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Student&gt; <span class="title">getStudents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> students;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStudents</span><span class="params">(Collection&lt;Student&gt; students)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.students = students;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ClassRoom&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, students=&quot;</span> + students +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularReferencesDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">// 注册 Configuration Class</span></span><br><span class="line">        context.register(CircularReferencesDemo.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果设置为 false，则抛出异常信息如：currently in creation: Is there an unresolvable circular reference?</span></span><br><span class="line">        <span class="comment">// 默认值为 true</span></span><br><span class="line">        context.setAllowCircularReferences(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动 Spring 应用上下文</span></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Student : &quot;</span> + context.getBean(Student.class));</span><br><span class="line">        System.out.println(<span class="string">&quot;ClassRoom : &quot;</span> + context.getBean(ClassRoom.class));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭 Spring 应用上下文</span></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Student student = <span class="keyword">new</span> Student();</span><br><span class="line">        student.setId(<span class="number">1L</span>);</span><br><span class="line">        student.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassRoom <span class="title">classRoom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClassRoom classRoom = <span class="keyword">new</span> ClassRoom();</span><br><span class="line">        classRoom.setName(<span class="string">&quot;C122&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> classRoom;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理循环依赖的核心代码：</p>
<img src="https://blog-1304855543.cos.ap-guangzhou.myqcloud.com/blog/img/image-20210629152452981.png" alt="image-20210629152452981" style="zoom:50%;" />
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    
        <div class="reward-container">
  <div>感谢您的支持！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="吉永超 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>吉永超
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://jycoder.club/2020/07/16/SpringFramework/" title="SpringFramework">https://jycoder.club/2020/07/16/SpringFramework/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Spring/" rel="tag"># Spring</a>
              <a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/07/13/Functionalprogramming/" rel="prev" title="函数式编程">
      <i class="fa fa-chevron-left"></i> 函数式编程
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/16/SpringCloud/" rel="next" title="SpringCloud">
      SpringCloud <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text"> Spring 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%89%B9%E6%80%A7%E6%80%BB%E8%A7%88"><span class="nav-number">1.1.</span> <span class="nav-text"> Spring特性总览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-%E4%B8%AD%E5%80%BC%E5%BE%97%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="nav-number">1.1.1.</span> <span class="nav-text"> Spring 中值得学习的地方</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.2.</span> <span class="nav-text"> Spring核心特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">1.1.3.</span> <span class="nav-text"> Spring数据存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-web%E6%8A%80%E6%9C%AF"><span class="nav-number">1.1.4.</span> <span class="nav-text"> Spring Web技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%8A%80%E6%9C%AF%E6%95%B4%E5%90%88"><span class="nav-number">1.1.5.</span> <span class="nav-text"> Spring技术整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%B5%8B%E8%AF%95"><span class="nav-number">1.1.6.</span> <span class="nav-text"> Spring测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.</span> <span class="nav-text"> Spring版本特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A8%A1%E5%9D%97%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.</span> <span class="nav-text"> Spring模块化设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.4.</span> <span class="nav-text"> Spring编程模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="nav-number">1.5.</span> <span class="nav-text"> Spring的核心价值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-number">1.6.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFspring-framework"><span class="nav-number">1.6.1.</span> <span class="nav-text"> 什么是Spring Framework？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-framwork%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="nav-number">1.6.2.</span> <span class="nav-text"> Spring Framwork有哪些核心模块？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-framework%E7%9A%84%E4%BC%98%E5%8A%BF%E5%92%8C%E4%B8%8D%E8%B6%B3%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.6.3.</span> <span class="nav-text"> Spring Framework的优势和不足是什么？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ioc%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text"> IoC简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ioc%E7%9A%84%E5%8F%91%E5%B1%95%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text"> IoC的发展简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ioc%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0%E7%AD%96%E7%95%A5"><span class="nav-number">2.2.</span> <span class="nav-text"> IoC主要实现策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ioc%E5%AE%B9%E5%99%A8%E7%9A%84%E8%81%8C%E8%B4%A3"><span class="nav-number">2.3.</span> <span class="nav-text"> IoC容器的职责</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ioc%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.4.</span> <span class="nav-text"> IoC的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9Fioc%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.5.</span> <span class="nav-text"> 传统IoC容器的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%95%8C%E5%AE%9Aioc%E5%AE%B9%E5%99%A8%E6%98%AF%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%9A%84"><span class="nav-number">2.6.</span> <span class="nav-text"> 如何界定IoC容器是轻量级的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E5%92%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-number">2.7.</span> <span class="nav-text"> 依赖查找和依赖注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5%E5%92%8Csetter%E6%B3%A8%E5%85%A5"><span class="nav-number">2.8.</span> <span class="nav-text"> 构造器注入和Setter注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-2"><span class="nav-number">2.9.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFioc"><span class="nav-number">2.9.1.</span> <span class="nav-text"> 什么是IoC？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E5%92%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.9.2.</span> <span class="nav-text"> 依赖查找和依赖注入的区别？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E4%BD%9C%E4%B8%BAioc%E5%AE%B9%E5%99%A8%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF"><span class="nav-number">2.9.3.</span> <span class="nav-text"> Spring作为IoC容器有什么优势？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ioc%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.</span> <span class="nav-text"> IoC实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-ioc%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">3.1.</span> <span class="nav-text"> Spring IoC依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-ioc%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-number">3.2.</span> <span class="nav-text"> Spring IoC依赖注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%92%8C%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-number">3.3.</span> <span class="nav-text"> Spring依赖注入和依赖查找的来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-ioc%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">3.4.</span> <span class="nav-text"> Spring IoC配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E5%92%8Capplicationcontext"><span class="nav-number">3.5.</span> <span class="nav-text"> BeanFactory和ApplicationContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-ioc%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">3.6.</span> <span class="nav-text"> Spring IoC容器生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-3"><span class="nav-number">3.7.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFspring-ioc%E5%AE%B9%E5%99%A8"><span class="nav-number">3.7.1.</span> <span class="nav-text"> 什么是Spring IoC容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beanfactory%E5%92%8Cfactorybean"><span class="nav-number">3.7.2.</span> <span class="nav-text"> BeanFactory和FactoryBean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-ioc%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E5%87%86%E5%A4%87"><span class="nav-number">3.7.3.</span> <span class="nav-text"> Spring IoC容器启动时做了哪些准备？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-bean%E5%9F%BA%E7%A1%80"><span class="nav-number">4.</span> <span class="nav-text"> Spring Bean基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#beandefinition"><span class="nav-number">4.1.</span> <span class="nav-text"> BeanDefinition</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-bean%E5%91%BD%E5%90%8D"><span class="nav-number">4.2.</span> <span class="nav-text"> Spring Bean命名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beandefinition%E6%B3%A8%E5%86%8C%E5%88%B0ioc%E5%AE%B9%E5%99%A8"><span class="nav-number">4.3.</span> <span class="nav-text"> BeanDefinition注册到IoC容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96bean%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">4.4.</span> <span class="nav-text"> 实例化Bean的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96bean%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">4.5.</span> <span class="nav-text"> 初始化Bean的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%B6%E8%BF%9F%E5%88%9D%E5%A7%8B%E5%8C%96bean"><span class="nav-number">4.6.</span> <span class="nav-text"> 延迟初始化Bean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%80%E6%AF%81bean"><span class="nav-number">4.7.</span> <span class="nav-text"> 销毁Bean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6spring-bean"><span class="nav-number">4.8.</span> <span class="nav-text"> 垃圾回收Spring Bean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-4"><span class="nav-number">4.9.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AAspring-bean"><span class="nav-number">4.9.1.</span> <span class="nav-text"> 如何注册一个Spring Bean？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFspring-beandefinition"><span class="nav-number">4.9.2.</span> <span class="nav-text"> 什么是Spring BeanDefinition？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E5%AE%B9%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E7%AE%A1%E7%90%86%E6%B3%A8%E5%86%8Cbean"><span class="nav-number">4.9.3.</span> <span class="nav-text"> Spring容器是怎样管理注册Bean</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.</span> <span class="nav-text"> 依赖查找</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E7%AE%80%E4%BB%8B"><span class="nav-number">5.1.</span> <span class="nav-text"> 依赖查找简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E4%B8%80%E7%B1%BB%E5%9E%8B%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.2.</span> <span class="nav-text"> 单一类型依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.3.</span> <span class="nav-text"> 集合类型依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%82%E6%AC%A1%E6%80%A7%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.4.</span> <span class="nav-text"> 层次性依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%B6%E8%BF%9F%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.5.</span> <span class="nav-text"> 延迟依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">5.6.</span> <span class="nav-text"> 安全依赖查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%BB%BA%E5%8F%AF%E6%9F%A5%E6%89%BE%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="nav-number">5.7.</span> <span class="nav-text"> 内建可查找的依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E4%B8%AD%E5%85%B8%E5%9E%8B%E5%BC%82%E5%B8%B8"><span class="nav-number">5.8.</span> <span class="nav-text"> 依赖查找中典型异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-5"><span class="nav-number">5.9.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objectfactory%E4%B8%8Ebeanfactory%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.9.1.</span> <span class="nav-text"> ObjectFactory与BeanFactory的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beanfactorygetbean%E6%93%8D%E4%BD%9C%E6%98%AF%E5%90%A6%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="nav-number">5.9.2.</span> <span class="nav-text"> BeanFactory.getBean操作是否线程安全？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E7%9A%84%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E5%92%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%9C%A8%E6%9D%A5%E6%BA%90%E4%B8%8A%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"><span class="nav-number">5.9.3.</span> <span class="nav-text"> Spring的依赖查找和依赖注入在来源上有什么区别？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-number">6.</span> <span class="nav-text"> 依赖注入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.1.</span> <span class="nav-text"> 依赖注入的模式和类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E7%BB%91%E5%AE%9A"><span class="nav-number">6.2.</span> <span class="nav-text"> 自动绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setter%E6%B3%A8%E5%85%A5"><span class="nav-number">6.3.</span> <span class="nav-text"> Setter注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5"><span class="nav-number">6.4.</span> <span class="nav-text"> 构造器注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E6%B3%A8%E5%85%A5"><span class="nav-number">6.5.</span> <span class="nav-text"> 字段注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A5"><span class="nav-number">6.6.</span> <span class="nav-text"> 方法注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%85%A5"><span class="nav-number">6.7.</span> <span class="nav-text"> 接口回调注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%B1%BB%E5%9E%8B%E9%80%89%E6%8B%A9"><span class="nav-number">6.8.</span> <span class="nav-text"> 依赖注入类型选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="nav-number">6.9.</span> <span class="nav-text"> 基础类型注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="nav-number">6.10.</span> <span class="nav-text"> 集合类型注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%AE%9A%E6%B3%A8%E5%85%A5"><span class="nav-number">6.11.</span> <span class="nav-text"> 限定注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%B6%E8%BF%9F%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-number">6.12.</span> <span class="nav-text"> 延迟依赖注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E5%A4%84%E7%90%86%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="nav-number">6.13.</span> <span class="nav-text"> 依赖处理的过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#autowird%E6%B3%A8%E5%85%A5"><span class="nav-number">6.14.</span> <span class="nav-text"> @Autowird注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#inject%E5%92%8Cautowired%E8%81%94%E7%B3%BB"><span class="nav-number">6.15.</span> <span class="nav-text"> @Inject和@Autowired联系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E9%80%9A%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86"><span class="nav-number">6.16.</span> <span class="nav-text"> Java通用注解原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%B3%A8%E8%A7%A3"><span class="nav-number">6.17.</span> <span class="nav-text"> 自定义依赖注入注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-6"><span class="nav-number">6.18.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%A4%9A%E5%B0%91%E7%A7%8D%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">6.18.1.</span> <span class="nav-text"> 有多少种依赖注入的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%A0%E5%81%8F%E5%A5%BD%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5%E8%BF%98%E6%98%AFsetter%E6%B3%A8%E5%85%A5"><span class="nav-number">6.18.2.</span> <span class="nav-text"> 你偏好构造器注入还是Setter注入?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E6%9D%A5%E6%BA%90%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">6.18.3.</span> <span class="nav-text"> Spring依赖注入的来源有哪些？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-ioc%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90"><span class="nav-number">7.</span> <span class="nav-text"> Spring IoC依赖来源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-number">7.1.</span> <span class="nav-text"> 依赖查找的来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-number">7.2.</span> <span class="nav-text"> 依赖注入的来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E5%92%8C%E6%B8%B8%E7%A6%BB%E5%AF%B9%E8%B1%A1"><span class="nav-number">7.3.</span> <span class="nav-text"> Spring容器管理和游离对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-beandefinition%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90"><span class="nav-number">7.4.</span> <span class="nav-text"> Spring BeanDefinition作为依赖来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E4%BD%93%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90"><span class="nav-number">7.5.</span> <span class="nav-text"> 单体对象作为依赖来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resolvable-dependency%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90"><span class="nav-number">7.6.</span> <span class="nav-text"> Resolvable Dependency作为依赖来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90"><span class="nav-number">7.7.</span> <span class="nav-text"> 外部化配置作为依赖来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-7"><span class="nav-number">7.8.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%92%8C%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E7%9A%84%E4%BE%9D%E8%B5%96%E6%9D%A5%E6%BA%90%E6%98%AF%E5%90%A6%E7%9B%B8%E5%90%8C"><span class="nav-number">7.8.1.</span> <span class="nav-text"> 依赖注入和依赖查找的依赖来源是否相同？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%BE%8B%E5%AF%B9%E8%B1%A1%E8%83%BD%E5%9C%A8ioc%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E6%B3%A8%E5%86%8C%E5%90%97"><span class="nav-number">7.8.2.</span> <span class="nav-text"> 单例对象能在IoC容器启动后注册吗？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E6%9D%A5%E6%BA%90%E6%9C%89%E5%93%AA%E4%BA%9B-2"><span class="nav-number">7.8.3.</span> <span class="nav-text"> Spring依赖注入的来源有哪些？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-bean%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.</span> <span class="nav-text"> Spring Bean作用域</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%AE%80%E4%BB%8B"><span class="nav-number">8.1.</span> <span class="nav-text"> 作用域简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#singleton%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.2.</span> <span class="nav-text"> singleton作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prototype%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.3.</span> <span class="nav-text"> prototype作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#request%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.4.</span> <span class="nav-text"> request作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.5.</span> <span class="nav-text"> session作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#application%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.6.</span> <span class="nav-text"> application作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89bean%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">8.7.</span> <span class="nav-text"> 自定义Bean作用域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-8"><span class="nav-number">8.8.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BA%E7%9A%84bean%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%9C%89%E5%87%A0%E7%A7%8D"><span class="nav-number">8.8.1.</span> <span class="nav-text"> Spring内建的Bean的作用域有几种？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#singleton-bean%E6%98%AF%E5%90%A6%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E6%98%AF%E5%94%AF%E4%B8%80%E7%9A%84"><span class="nav-number">8.8.2.</span> <span class="nav-text"> singleton Bean是否在一个应用中是唯一的？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#application-bean%E6%98%AF%E5%90%A6%E8%A2%AB%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88%E4%BB%96%E6%9B%BF%E4%BB%A3"><span class="nav-number">8.8.3.</span> <span class="nav-text"> “application” Bean是否被其他方案他替代？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">9.</span> <span class="nav-text"> Spring Bean 生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%E9%98%B6%E6%AE%B5"><span class="nav-number">9.1.</span> <span class="nav-text"> 元信息配置阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E4%BF%A1%E6%81%AF%E8%A7%A3%E6%9E%90%E9%98%B6%E6%AE%B5"><span class="nav-number">9.2.</span> <span class="nav-text"> 元信息解析阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E9%98%B6%E6%AE%B5"><span class="nav-number">9.3.</span> <span class="nav-text"> 注册阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beandefinition%E5%90%88%E5%B9%B6%E9%98%B6%E6%AE%B5"><span class="nav-number">9.4.</span> <span class="nav-text"> BeanDefinition合并阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean-class%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5"><span class="nav-number">9.5.</span> <span class="nav-text"> Bean Class加载阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-number">9.6.</span> <span class="nav-text"> 实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%89%8D%E9%98%B6%E6%AE%B5"><span class="nav-number">9.6.1.</span> <span class="nav-text"> 实例化前阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="nav-number">9.6.2.</span> <span class="nav-text"> 实例化阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%90%8E%E9%98%B6%E6%AE%B5"><span class="nav-number">9.6.3.</span> <span class="nav-text"> Bean实例化后阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC%E5%89%8D%E9%98%B6%E6%AE%B5"><span class="nav-number">9.7.</span> <span class="nav-text"> 属性赋值前阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">9.8.</span> <span class="nav-text"> 初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%9B%9E%E8%B0%83%E9%98%B6%E6%AE%B5"><span class="nav-number">9.8.1.</span> <span class="nav-text"> 接口回调阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%8D%E9%98%B6%E6%AE%B5"><span class="nav-number">9.8.2.</span> <span class="nav-text"> 初始化前阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="nav-number">9.8.3.</span> <span class="nav-text"> 初始化阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%8E%E9%98%B6%E6%AE%B5"><span class="nav-number">9.8.4.</span> <span class="nav-text"> 初始化后阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5"><span class="nav-number">9.8.5.</span> <span class="nav-text"> 初始化完成阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E9%98%B6%E6%AE%B5"><span class="nav-number">9.9.</span> <span class="nav-text"> 销毁阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E5%89%8D%E9%98%B6%E6%AE%B5"><span class="nav-number">9.9.1.</span> <span class="nav-text"> 销毁前阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E9%98%B6%E6%AE%B5-2"><span class="nav-number">9.9.2.</span> <span class="nav-text"> 销毁阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86"><span class="nav-number">9.10.</span> <span class="nav-text"> Bean垃圾收集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-9"><span class="nav-number">9.11.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#beanpostprocess%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">9.11.1.</span> <span class="nav-text"> BeanPostProcess使用场景有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beanfactorypostprocess%E4%B8%8Ebeanpostprocess%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">9.11.2.</span> <span class="nav-text"> BeanFactoryPostProcess与BeanPostProcess的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beanfactory%E6%98%AF%E6%80%8E%E6%A0%B7%E5%A4%84%E7%90%86bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">9.11.3.</span> <span class="nav-text"> BeanFactory是怎样处理Bean生命周期？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.</span> <span class="nav-text"> Spring 配置元信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-bean%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.1.</span> <span class="nav-text"> Spring Bean配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-bean%E5%B1%9E%E6%80%A7%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.2.</span> <span class="nav-text"> Spring Bean属性元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.3.</span> <span class="nav-text"> Spring容器配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Exml%E8%B5%84%E6%BA%90%E8%A3%85%E8%BD%BDspring-bean%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.4.</span> <span class="nav-text"> 基于XML资源装载Spring Bean配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eproperties%E8%B5%84%E6%BA%90%E8%A3%85%E8%BD%BDspring-bean%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.5.</span> <span class="nav-text"> 基于Properties资源装载Spring Bean配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ejava%E6%B3%A8%E8%A7%A3%E7%9A%84spring-bean%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.6.</span> <span class="nav-text"> 基于Java注解的Spring Bean配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-bean%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="nav-number">10.7.</span> <span class="nav-text"> Spring Bean配置元信息底层实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#xml%E8%B5%84%E6%BA%90%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">10.7.1.</span> <span class="nav-text"> XML资源的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#properties%E8%B5%84%E6%BA%90%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">10.7.2.</span> <span class="nav-text"> Properties资源的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java%E6%B3%A8%E8%A7%A3%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">10.7.3.</span> <span class="nav-text"> Java注解的方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Exml%E8%B5%84%E6%BA%90%E8%A3%85%E8%BD%BDspring-%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.8.</span> <span class="nav-text"> 基于XML资源装载Spring 容器配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ejava%E6%B3%A8%E8%A7%A3%E9%85%8D%E7%BD%AEspring-%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">10.9.</span> <span class="nav-text"> 基于Java注解配置Spring 容器配置元信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eextensible-xml-authoring%E6%89%A9%E5%B1%95spring-xml%E5%85%83%E7%B4%A0"><span class="nav-number">10.10.</span> <span class="nav-text"> 基于Extensible XML authoring扩展Spring XML元素</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eproperties%E8%B5%84%E6%BA%90%E8%A3%85%E8%BD%BD%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">10.11.</span> <span class="nav-text"> 基于Properties资源装载外部化配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eyml%E8%B5%84%E6%BA%90%E8%A3%85%E8%BD%BD%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">10.12.</span> <span class="nav-text"> 基于yml资源装载外部化配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-10"><span class="nav-number">10.13.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BA%E7%9A%84xml-schema%E5%B8%B8%E8%A7%81%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">10.13.1.</span> <span class="nav-text"> Spring内建的XML Schema常见有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E9%85%8D%E7%BD%AE%E5%85%83%E4%BF%A1%E6%81%AF%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">10.13.2.</span> <span class="nav-text"> Spring配置元信息有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extensible-xml-authoring%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="nav-number">10.13.3.</span> <span class="nav-text"> Extensible XML authoring的缺点？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="nav-number">11.</span> <span class="nav-text"> Spring 资源管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E6%A0%87%E5%87%86%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="nav-number">11.1.</span> <span class="nav-text"> Java标准资源管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resource%E6%8E%A5%E5%8F%A3"><span class="nav-number">11.2.</span> <span class="nav-text"> Resource接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%BB%BA%E7%9A%84resource%E5%AE%9E%E7%8E%B0"><span class="nav-number">11.3.</span> <span class="nav-text"> 内建的Resource实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resource%E6%8E%A5%E5%8F%A3%E6%89%A9%E5%B1%95"><span class="nav-number">11.4.</span> <span class="nav-text"> Resource接口扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">11.5.</span> <span class="nav-text"> Spring资源加载器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E9%80%9A%E9%85%8D%E8%B7%AF%E5%BE%84%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">11.6.</span> <span class="nav-text"> Spring通配路径资源加载器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E9%80%9A%E9%85%8D%E8%B7%AF%E5%BE%84%E8%B5%84%E6%BA%90%E6%89%A9%E5%B1%95"><span class="nav-number">11.7.</span> <span class="nav-text"> Spring通配路径资源扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5spring-resource"><span class="nav-number">11.8.</span> <span class="nav-text"> 依赖注入Spring Resource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5resourceloader"><span class="nav-number">11.9.</span> <span class="nav-text"> 依赖注入ResourceLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-11"><span class="nav-number">11.10.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.10.1.</span> <span class="nav-text"> Spring配置资源中有哪些常见类型？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E4%B8%BE%E4%BE%8B%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84spring%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90"><span class="nav-number">11.10.2.</span> <span class="nav-text"> 请举例不同类型的Spring配置资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java%E6%A0%87%E5%87%86%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%89%A9%E5%B1%95%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-number">11.10.3.</span> <span class="nav-text"> Java标准资源管理扩展的步骤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E5%9B%BD%E9%99%85%E5%8C%96"><span class="nav-number">12.</span> <span class="nav-text"> Spring 国际化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%9B%BD%E9%99%85%E5%8C%96%E6%8E%A5%E5%8F%A3"><span class="nav-number">12.1.</span> <span class="nav-text"> Spring国际化接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%82%E6%AC%A1%E6%80%A7%E7%9A%84messagesource"><span class="nav-number">12.2.</span> <span class="nav-text"> 层次性的MessageSource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E5%9B%BD%E9%99%85%E5%8C%96%E6%A0%87%E5%87%86%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.3.</span> <span class="nav-text"> Java国际化标准实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">12.4.</span> <span class="nav-text"> Java文本格式化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#messagesource%E5%BC%80%E7%AE%B1%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.5.</span> <span class="nav-text"> MessageSource开箱实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#message%E7%9A%84%E5%86%85%E5%BB%BA%E4%BE%9D%E8%B5%96"><span class="nav-number">12.6.</span> <span class="nav-text"> Message的内建依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#springboot%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%96%B0%E5%BB%BAmessagesource-bean"><span class="nav-number">12.7.</span> <span class="nav-text"> SpringBoot为什么要新建MessageSource Bean?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-12"><span class="nav-number">12.8.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E5%9B%BD%E9%99%85%E5%8C%96%E6%8E%A5%E5%8F%A3%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">12.8.1.</span> <span class="nav-text"> Spring国际化接口有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%9C%89%E5%93%AA%E4%BA%9Bmessagesource%E7%9A%84%E5%86%85%E5%BB%BA%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.8.2.</span> <span class="nav-text"> Spring有哪些MessageSource的内建实现？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0messagesource"><span class="nav-number">12.8.3.</span> <span class="nav-text"> 如何实现配置自动更新MessageSource？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E6%A0%A1%E9%AA%8C"><span class="nav-number">13.</span> <span class="nav-text"> Spring 校验</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#validator%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="nav-number">13.1.</span> <span class="nav-text"> Validator接口设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#errors%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="nav-number">13.2.</span> <span class="nav-text"> Errors接口设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#errors%E7%9A%84%E6%96%87%E6%A1%88%E6%9D%A5%E6%BA%90"><span class="nav-number">13.3.</span> <span class="nav-text"> Errors的文案来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89validator"><span class="nav-number">13.4.</span> <span class="nav-text"> 自定义Validator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean-validation"><span class="nav-number">13.5.</span> <span class="nav-text"> Bean Validation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-13"><span class="nav-number">13.6.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%A0%A1%E9%AA%8C%E6%8E%A5%E5%8F%A3%E6%98%AF%E5%93%AA%E4%B8%AA"><span class="nav-number">13.6.1.</span> <span class="nav-text"> Spring校验接口是哪个？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%A1%E9%AA%8C%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">13.6.2.</span> <span class="nav-text"> Spring有哪些校验核心组件？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E9%80%9A%E8%BF%87%E7%A4%BA%E4%BE%8B%E6%BC%94%E7%A4%BAspring-bean%E7%9A%84%E6%A0%A1%E9%AA%8C"><span class="nav-number">13.6.3.</span> <span class="nav-text"> 请通过示例演示Spring Bean的校验？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A"><span class="nav-number">14.</span> <span class="nav-text"> Spring 数据绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E7%BB%84%E4%BB%B6"><span class="nav-number">14.1.</span> <span class="nav-text"> Spring 数据绑定组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#databinder%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">14.2.</span> <span class="nav-text"> DataBinder元数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#databinder%E7%BB%91%E5%AE%9A%E6%8E%A7%E5%88%B6%E5%8F%82%E6%95%B0"><span class="nav-number">14.3.</span> <span class="nav-text"> DataBinder绑定控制参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%BA%95%E5%B1%82java-beans%E6%9B%BF%E6%8D%A2%E5%AE%9E%E7%8E%B0"><span class="nav-number">14.4.</span> <span class="nav-text"> Spring底层Java Beans替换实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanwrapper%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">14.5.</span> <span class="nav-text"> BeanWrapper使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#javabeans%E6%93%8D%E4%BD%9C%E5%B1%9E%E6%80%A7"><span class="nav-number">14.6.</span> <span class="nav-text"> JavaBeans操作属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#databinder%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="nav-number">14.7.</span> <span class="nav-text"> DataBinder数据校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-14"><span class="nav-number">14.8.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9Aapi%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">14.8.1.</span> <span class="nav-text"> Spring数据绑定API是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beanwrapper%E4%B8%8Ejavabeans%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%E6%98%AF"><span class="nav-number">14.8.2.</span> <span class="nav-text"> BeanWrapper与JavaBeans之间的关系是？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#databinder%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%8C%E6%88%90%E5%B1%9E%E6%80%A7%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%9A%84"><span class="nav-number">14.8.3.</span> <span class="nav-text"> DataBinder是怎么完成属性类型转换的？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">15.</span> <span class="nav-text"> Spring 类型转换</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">15.1.</span> <span class="nav-text"> 使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ejavabeans%E6%8E%A5%E5%8F%A3%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">15.2.</span> <span class="nav-text"> 基于JavaBeans接口的类型转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BApropertyeditor%E6%89%A9%E5%B1%95"><span class="nav-number">15.3.</span> <span class="nav-text"> Spring内建PropertyEditor扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89propertyeditor%E6%89%A9%E5%B1%95"><span class="nav-number">15.4.</span> <span class="nav-text"> 自定义PropertyEditor扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#propertyeditor%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-number">15.5.</span> <span class="nav-text"> PropertyEditor的局限性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring3-%E9%80%9A%E7%94%A8%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E6%8E%A5%E5%8F%A3"><span class="nav-number">15.6.</span> <span class="nav-text"> Spring3 通用类型转换接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BA%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">15.7.</span> <span class="nav-text"> Spring内建类型转换器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#converter%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-number">15.8.</span> <span class="nav-text"> Converter接口的局限性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genericconverter%E6%8E%A5%E5%8F%A3"><span class="nav-number">15.9.</span> <span class="nav-text"> GenericConverter接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96genericconverter%E6%8E%A5%E5%8F%A3"><span class="nav-number">15.10.</span> <span class="nav-text"> 优化GenericConverter接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">15.11.</span> <span class="nav-text"> 扩展Spring类型转换器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E6%9C%8D%E5%8A%A1"><span class="nav-number">15.12.</span> <span class="nav-text"> 统一类型转换服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#conversionservice%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96"><span class="nav-number">15.13.</span> <span class="nav-text"> ConversionService作为依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-15"><span class="nav-number">15.14.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%AE%9E%E7%8E%B0%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">15.14.1.</span> <span class="nav-text"> Spring类型转换实现有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%99%A8%E6%8E%A5%E5%8F%A3%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">15.14.2.</span> <span class="nav-text"> Spring类型转换器接口有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#typedescriptor%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%B3%9B%E5%9E%8B"><span class="nav-number">15.14.3.</span> <span class="nav-text"> TypeDescriptor是如何处理泛型？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E6%B3%9B%E5%9E%8B"><span class="nav-number">16.</span> <span class="nav-text"> Spring 泛型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E6%B3%9B%E5%9E%8B%E5%9F%BA%E7%A1%80"><span class="nav-number">16.1.</span> <span class="nav-text"> Java泛型基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#java-5%E7%B1%BB%E5%9E%8B%E6%8E%A5%E5%8F%A3"><span class="nav-number">16.2.</span> <span class="nav-text"> Java 5类型接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B%E8%BE%85%E5%8A%A9%E7%B1%BB"><span class="nav-number">16.3.</span> <span class="nav-text"> Spring泛型类型辅助类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%9B%E5%9E%8B%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E8%BE%85%E5%8A%A9%E7%B1%BB"><span class="nav-number">16.4.</span> <span class="nav-text"> 泛型集合类型辅助类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%B0%81%E8%A3%85"><span class="nav-number">16.5.</span> <span class="nav-text"> Spring方法参数封装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resolvabletype"><span class="nav-number">16.6.</span> <span class="nav-text"> ResolvableType</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-16"><span class="nav-number">16.7.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java%E6%B3%9B%E5%9E%8B%E6%93%A6%E5%86%99%E6%98%AF%E5%8F%91%E7%94%9F%E5%9C%A8%E7%BC%96%E8%AF%91%E6%97%B6%E8%BF%98%E6%98%AF%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="nav-number">16.7.1.</span> <span class="nav-text"> Java泛型擦写是发生在编译时，还是运行时？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E4%BB%8B%E7%BB%8Djava-5-type%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%B4%BE%E7%94%9F%E7%B1%BB%E6%88%96%E6%8E%A5%E5%8F%A3"><span class="nav-number">16.7.2.</span> <span class="nav-text"> 请介绍Java 5 Type类型的派生类或接口?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E8%AF%B4%E6%98%8Eresolvabletype%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%BC%98%E5%8A%BF"><span class="nav-number">16.7.3.</span> <span class="nav-text"> 请说明ResolvableType的设计优势</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E4%BA%8B%E4%BB%B6"><span class="nav-number">17.</span> <span class="nav-text"> Spring 事件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">17.1.</span> <span class="nav-text"> Java事件&#x2F;监听器编程模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E5%90%91%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">17.2.</span> <span class="nav-text"> 面向接口的事件&#x2F;监听器设计模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E5%90%91%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">17.3.</span> <span class="nav-text"> 面向注解的事件&#x2F;监听器设计模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A0%87%E5%87%86%E4%BA%8B%E4%BB%B6-applicationevent"><span class="nav-number">17.4.</span> <span class="nav-text"> Spring标准事件 ApplicationEvent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%8E%A5%E5%8F%A3%E7%9A%84spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8"><span class="nav-number">17.5.</span> <span class="nav-text"> 基于接口的Spring事件监听器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8"><span class="nav-number">17.6.</span> <span class="nav-text"> 基于注解的Spring事件监听器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8Cspring-applicationlistener"><span class="nav-number">17.7.</span> <span class="nav-text"> 注册Spring ApplicationListener</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E5%99%A8"><span class="nav-number">17.8.</span> <span class="nav-text"> Spring事件发布器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%B1%82%E6%AC%A1%E6%80%A7%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BA%8B%E4%BB%B6%E4%BC%A0%E6%92%AD"><span class="nav-number">17.9.</span> <span class="nav-text"> Spring层次性上下文事件传播</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BA%E4%BA%8B%E4%BB%B6"><span class="nav-number">17.10.</span> <span class="nav-text"> Spring内建事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload%E4%BA%8B%E4%BB%B6"><span class="nav-number">17.11.</span> <span class="nav-text"> Payload事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89spring%E4%BA%8B%E4%BB%B6"><span class="nav-number">17.12.</span> <span class="nav-text"> 自定义Spring事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5applicationeventpublisher"><span class="nav-number">17.13.</span> <span class="nav-text"> 依赖注入ApplicationEventPublisher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BEapplicationeventmulticaster"><span class="nav-number">17.14.</span> <span class="nav-text"> 依赖查找ApplicationEventMulticaster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#applicationeventpublisher%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="nav-number">17.15.</span> <span class="nav-text"> ApplicationEventPublisher底层实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5spring%E4%BA%8B%E4%BB%B6%E5%B9%BF%E6%92%AD"><span class="nav-number">17.16.</span> <span class="nav-text"> 同步和异步Spring事件广播</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E4%BA%8B%E4%BB%B6%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">17.17.</span> <span class="nav-text"> Spring事件异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">17.18.</span> <span class="nav-text"> Spring事件&#x2F;监听实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#springboot%E4%BA%8B%E4%BB%B6"><span class="nav-number">17.19.</span> <span class="nav-text"> SpringBoot事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-17"><span class="nav-number">17.20.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E4%BA%8B%E4%BB%B6%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3%E7%BB%84%E4%BB%B6"><span class="nav-number">17.20.1.</span> <span class="nav-text"> Spring事件核心接口&#x2F;组件？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">17.21.</span> <span class="nav-text"> Spring同步和异步事件处理的使用场景？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eventlistener%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">17.22.</span> <span class="nav-text"> @EventListener的工作原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E6%B3%A8%E8%A7%A3%E9%A9%B1%E5%8A%A8"><span class="nav-number">18.</span> <span class="nav-text"> Spring 注解驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A0%B8%E5%BF%83%E6%B3%A8%E8%A7%A3%E5%9C%BA%E6%99%AF%E5%88%86%E7%B1%BB"><span class="nav-number">18.1.</span> <span class="nav-text"> Spring核心注解场景分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%B3%A8%E8%A7%A3%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">18.2.</span> <span class="nav-text"> Spring注解编程模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%85%83%E6%B3%A8%E8%A7%A3"><span class="nav-number">18.3.</span> <span class="nav-text"> Spring元注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A8%A1%E5%BC%8F%E6%B3%A8%E8%A7%A3"><span class="nav-number">18.4.</span> <span class="nav-text"> Spring模式注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-%E7%BB%84%E5%90%88%E6%B3%A8%E8%A7%A3"><span class="nav-number">18.5.</span> <span class="nav-text"> Spring 组合注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7%E5%88%AB%E5%90%8D"><span class="nav-number">18.6.</span> <span class="nav-text"> Spring注解属性别名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96"><span class="nav-number">18.7.</span> <span class="nav-text"> Spring注解属性覆盖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-enable%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8"><span class="nav-number">18.8.</span> <span class="nav-text"> Spring @Enable模块驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%9D%A1%E4%BB%B6%E6%B3%A8%E8%A7%A3"><span class="nav-number">18.9.</span> <span class="nav-text"> Spring条件注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#springboot%E5%92%8Cspringcloud%E6%B3%A8%E8%A7%A3"><span class="nav-number">18.10.</span> <span class="nav-text"> SpringBoot和SpringCloud注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-18"><span class="nav-number">18.11.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E6%A8%A1%E5%BC%8F%E6%B3%A8%E8%A7%A3%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">18.11.1.</span> <span class="nav-text"> Spring模式注解有哪些？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eventlistener%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-2"><span class="nav-number">18.11.2.</span> <span class="nav-text"> @EventListener的工作原理？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#propertysource%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">18.11.3.</span> <span class="nav-text"> @PropertySource工作原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-environment%E6%8A%BD%E8%B1%A1"><span class="nav-number">19.</span> <span class="nav-text"> Spring Environment抽象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#environment%E6%8E%A5%E5%8F%A3%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">19.1.</span> <span class="nav-text"> Environment接口使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#environment%E5%8D%A0%E4%BD%8D%E7%AC%A6%E5%A4%84%E7%90%86"><span class="nav-number">19.2.</span> <span class="nav-text"> Environment占位符处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%A7%A3%E6%9D%A1%E4%BB%B6%E9%85%8D%E7%BD%AEspring-profiles"><span class="nav-number">19.3.</span> <span class="nav-text"> 理解条件配置Spring Profiles</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5environment"><span class="nav-number">19.4.</span> <span class="nav-text"> 依赖注入Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BEenvironment"><span class="nav-number">19.5.</span> <span class="nav-text"> 依赖查找Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5value"><span class="nav-number">19.6.</span> <span class="nav-text"> 依赖注入@Value</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%9C%A8environment%E4%B8%AD%E7%9A%84%E8%BF%90%E7%94%A8"><span class="nav-number">19.7.</span> <span class="nav-text"> Spring类型转换在Environment中的运用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%9C%A8value%E4%B8%AD%E7%9A%84%E8%BF%90%E7%94%A8"><span class="nav-number">19.8.</span> <span class="nav-text"> Spring类型转换在@Value中的运用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%BA%90propertysource"><span class="nav-number">19.9.</span> <span class="nav-text"> Spring配置属性源PropertySource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%86%85%E5%BB%BA%E7%9A%84%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%BA%90"><span class="nav-number">19.10.</span> <span class="nav-text"> Spring内建的配置属性源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E6%89%A9%E5%B1%95spring%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%BA%90"><span class="nav-number">19.11.</span> <span class="nav-text"> 基于注解扩展Spring配置属性源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eapi%E6%89%A9%E5%B1%95spring%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%BA%90"><span class="nav-number">19.12.</span> <span class="nav-text"> 基于API扩展Spring配置属性源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%BA%90"><span class="nav-number">19.13.</span> <span class="nav-text"> Spring 测试配置属性源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-19"><span class="nav-number">19.14.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8Dspring-environment%E6%8E%A5%E5%8F%A3"><span class="nav-number">19.14.1.</span> <span class="nav-text"> 简单介绍Spring Environment接口？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6propertysource%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">19.14.2.</span> <span class="nav-text"> 如何控制PropertySource的优先级？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#environment%E5%AE%8C%E6%95%B4%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84"><span class="nav-number">19.14.3.</span> <span class="nav-text"> Environment完整的生命周期是怎样的？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">20.</span> <span class="nav-text"> Spring 应用上下文生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%90%AF%E5%8A%A8%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="nav-number">20.1.</span> <span class="nav-text"> Spring应用上下文启动准备阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5"><span class="nav-number">20.2.</span> <span class="nav-text"> BeanFactory创建阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="nav-number">20.3.</span> <span class="nav-text"> BeanFactory准备阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5"><span class="nav-number">20.4.</span> <span class="nav-text"> BeanFactory后置处理阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E6%B3%A8%E5%86%8Cbeanpostprocess"><span class="nav-number">20.5.</span> <span class="nav-text"> BeanFactory注册BeanPostProcess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BAmessagesource"><span class="nav-number">20.6.</span> <span class="nav-text"> 初始化内建MessageSource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BAspring%E4%BA%8B%E4%BB%B6%E5%B9%BF%E6%92%AD%E5%99%A8"><span class="nav-number">20.7.</span> <span class="nav-text"> 初始化内建Spring事件广播器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%B7%E6%96%B0"><span class="nav-number">20.8.</span> <span class="nav-text"> Spring应用上下文刷新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E6%B3%A8%E5%86%8C"><span class="nav-number">20.9.</span> <span class="nav-text"> Spring事件监听器注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5"><span class="nav-number">20.10.</span> <span class="nav-text"> BeanFactory初始化完成阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%B7%E6%96%B0%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5"><span class="nav-number">20.11.</span> <span class="nav-text"> Spring应用上下文刷新完成阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5"><span class="nav-number">20.12.</span> <span class="nav-text"> Spring 应用上下文启动阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5"><span class="nav-number">20.13.</span> <span class="nav-text"> Spring 应用上下文停止阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%85%B3%E9%97%AD%E9%98%B6%E6%AE%B5"><span class="nav-number">20.14.</span> <span class="nav-text"> Spring应用上下文关闭阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98-20"><span class="nav-number">20.15.</span> <span class="nav-text"> 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%9C%89%E5%93%AA%E4%BA%9B%E9%98%B6%E6%AE%B5"><span class="nav-number">20.15.1.</span> <span class="nav-text"> Spring应用上下文生命周期有哪些阶段？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#environment%E5%AE%8C%E6%95%B4%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">20.15.2.</span> <span class="nav-text"> Environment完整的生命周期？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-%E6%80%BB%E7%BB%93"><span class="nav-number">21.</span> <span class="nav-text"> Spring 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7-2"><span class="nav-number">21.1.</span> <span class="nav-text"> Spring核心特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="nav-number">21.2.</span> <span class="nav-text"> Spring核心价值</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">22.</span> <span class="nav-text"> 附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%B4objectfactory%E6%8F%90%E4%BE%9B%E7%9A%84%E6%98%AF%E5%BB%B6%E8%BF%9F%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE"><span class="nav-number">22.1.</span> <span class="nav-text"> 为什么说ObjectFactory提供的是延迟依赖查找？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E6%B3%A8%E5%85%A5%E7%9A%84bean%E4%BC%9A%E8%A2%AB%E7%BC%93%E5%AD%98%E5%98%9B"><span class="nav-number">22.2.</span> <span class="nav-text"> 依赖查找（注入）的Bean会被缓存嘛？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84"><span class="nav-number">22.3.</span> <span class="nav-text"> @Bean的处理流程是怎样的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beanfactory%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84"><span class="nav-number">22.4.</span> <span class="nav-text"> BeanFactory是如何处理循环依赖的？</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">吉永超</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jycoast" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jycoast" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jyccoder@gmail.com" title="E-Mail → mailto:jyccoder@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吉永超</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:17</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//fastly.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//fastly.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      
<link rel="stylesheet" href="//fastly.jsdelivr.net/npm/katex@0/dist/katex.min.css">
  <script src="//fastly.jsdelivr.net/npm/katex@0/dist/contrib/copy-tex.min.js"></script>
  <link rel="stylesheet" href="//fastly.jsdelivr.net/npm/katex@0/dist/contrib/copy-tex.min.css">


  


</body>
</html>
